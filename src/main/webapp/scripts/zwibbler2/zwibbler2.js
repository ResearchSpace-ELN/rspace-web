/**
   Zwibbler

   Copyright 2013 Hanov Solutions Inc. All Rights Reserved. This software is
   NOT open source. For licensing information, contact the author.

   steve.hanov@gmail.com

   @license
 */
(function(){
"use strict";var m;function aa(a,b,c,d,e){this.Qa=a||"transparent";this.left=b||0;this.top=c||0;this.right=d||0;this.bottom=e||0;this.zIndex=1;this.insertBefore=null}aa.prototype.Ga=function(){this.aa.remove()};
aa.prototype.show=function(a){this.aa=n("<div>");this.aa.$("position","fixed");this.aa.$("background",this.Qa);this.aa.$("opacity","0.25");this.aa.$("left",""+this.left+"px");this.aa.$("top",""+this.top+"px");this.aa.$("right",""+this.right+"px");this.aa.$("bottom",""+this.bottom+"px");this.aa.$("display","none");this.aa.click(function(b){a(b)});this.insertBefore?(this.aa.$("z-index",""+this.zIndex),ba(n(this.aa),this.insertBefore)):(this.aa.$("z-index",""+this.zIndex),n("body").append(this.aa));
ca(this.aa)};var da=Function("return this")();da.JSON||(da.JSON={});
(function(){function a(a){return 10>a?"0"+a:a}function b(a){e.lastIndex=0;return e.test(a)?'"'+a.replace(e,function(a){var b=h[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function c(a,d){var e,h,x,v,w=f,B,A=d[a];A&&"object"===typeof A&&"function"===typeof A.toJSON&&(A=A.toJSON(a));"function"===typeof l&&(A=l.call(d,a,A));switch(typeof A){case "string":return b(A);case "number":return isFinite(A)?String(A):"null";case "boolean":case "null":return String(A);
case "object":if(!A)return"null";f+=g;B=[];if("[object Array]"===Object.prototype.toString.apply(A)){v=A.length;for(e=0;e<v;e+=1)B[e]=c(e,A)||"null";x=0===B.length?"[]":f?"[\n"+f+B.join(",\n"+f)+"\n"+w+"]":"["+B.join(",")+"]";f=w;return x}if(l&&"object"===typeof l)for(v=l.length,e=0;e<v;e+=1)h=l[e],"string"===typeof h&&(x=c(h,A))&&B.push(b(h)+(f?": ":":")+x);else for(h in A)Object.hasOwnProperty.call(A,h)&&(x=c(h,A))&&B.push(b(h)+(f?": ":":")+x);x=0===B.length?"{}":f?"{\n"+f+B.join(",\n"+f)+"\n"+
w+"}":"{"+B.join(",")+"}";f=w;return x}}"function"!==typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+a(this.getUTCMonth()+1)+"-"+a(this.getUTCDate())+"T"+a(this.getUTCHours())+":"+a(this.getUTCMinutes())+":"+a(this.getUTCSeconds())+"Z":""},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return""+this.valueOf()});var d=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f,g,h={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},l;"function"!==typeof da.JSON.stringify&&(da.JSON.stringify=function(a,b,d){var e;g=f="";if("number"===typeof d)for(e=0;e<d;e+=1)g+=" ";else"string"===typeof d&&(g=d);if((l=b)&&"function"!==typeof b&&("object"!==typeof b||"number"!==typeof b.length))throw Error("JSON.stringify");return c("",
{"":a})});"function"!==typeof da.JSON.parse&&(da.JSON.parse=function(a,b){function c(a,d){var e,f,g=a[d];if(g&&"object"===typeof g)for(e in g)Object.hasOwnProperty.call(g,e)&&(f=c(g,e),void 0!==f?g[e]=f:delete g[e]);return b.call(a,d,g)}var e;a=String(a);d.lastIndex=0;d.test(a)&&(a=a.replace(d,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,
"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return e=eval("("+a+")"),"function"===typeof b?c({"":e},""):e;throw new SyntaxError("JSON.parse");})})();var ea;try{ea=Function("return this")()}catch(fa){ea=window}var ga={},ha=[];function r(a,b){!1===b&&(ga[a]=!0);return function(b){var d=arguments,e=[],f=d[0];if(!ga[a]){var g=f.split("%s");e.push(g[0]);for(f=1;f<g.length;f++)f-1>=d.length-1?e.push("<too few args>"):"string"===typeof d[f]||"number"===typeof d[f]?e.push(d[f]):void 0===d[f]?e.push("(undefined)"):null===d[f]?e.push("(null)"):e.push(JSON.stringify(d[f])),e.push(g[f]);d=e.join("");for(f=0;f<ha.length;f++)ha[f](a,d)}}}
function ia(a){ha.push(a)}"console"in ea||(ea.console={log:function(){for(var a=[],b=0;b<arguments.length;b++)try{a.push(JSON.stringify(arguments[b]))}catch(c){a.push(c.toString())}for(b=0;b<ha.length;b++)ha[b]("Console",a.join(""))}},ea.console.error=ea.console.log);function ja(){this.length=0}r("JQUERY");var ka,la=/\s+/,ma=/^[\s\xA0]+/,na=/[\s\xA0]+$/;function oa(a,b,c){a=a.getElementsByTagName(c);for(c=0;c<a.length;c++)b[c]=a[c];b.length=a.length}
function pa(a){var b=/#(.*)$/,c=/\.(.*)$/,d=/^<\s*([a-zA-Z0-9]+).*>$/,e=/^([A-Za-z]+)$/,f=new ja,g;try{g=("object"===typeof HTMLElement?a instanceof HTMLElement:"object"===typeof a&&1===a.nodeType&&"string"===typeof a.nodeName||3===a.nodeType)||a===window||a===document||a===document.body||a instanceof Element}catch(h){g=!1}if(g)f[0]=a,f.length=1;else{if(a instanceof ja)return a;if(null!==(b=b.exec(a)))a=document.getElementById(b[1]),null!==a&&(f[0]=a,f.length=1);else if(null!==(b=d.exec(a)))f[0]=
document.createElement(b[1]),f.length=1;else if(null!==(b=c.exec(a))){a=document.wg(b[1]);for(c=0;c<a.length;c++)f[c]=a[c];f.length=a.length}else if(null!==(b=e.exec(a)))oa(document,f,b[1]);else throw console.log(a),"Error: can't parse selector: "+a+" ("+a.nodeType;}return f}
ja.prototype={Ga:function(){for(var a=0;a<this.length;a++)this[a].style.display="none";return this},show:function(){for(var a=0;a<this.length;a++)this[a].style.display="block";return this},append:function(a){a=pa(a);if(0<this.length)for(var b=0;b<a.length;b++)this[0].appendChild(a[b]);return this},remove:function(){for(var a=0;a<this.length;a++)this[a].parentNode&&this[a].parentNode.removeChild(this[a]);return this},empty:function(){for(var a=0;a<this.length;a++)for(;null!==this[a].firstChild;)this[a].removeChild(this[a].firstChild);
return this},text:function(a){for(var b=0;b<this.length;b++){for(;null!==this[b].firstChild;)this[b].removeChild(this[b].firstChild);this[b].appendChild(document.createTextNode(a))}return this},width:function(){if(0<this.length){if(1===arguments.length){for(var a=0;a<this.length;a++)this[a].style.width=""+arguments[0]+"px";return this}return this[0]===window?this[0].innerWidth||document.documentElement.clientWidth:this[0].clientWidth}return 0},height:function(){if(0<this.length){if(1===arguments.length){for(var a=
0;a<this.length;a++)this[a].style.height=""+arguments[0]+"px";return this}return this[0]===window?this[0].innerHeight||document.documentElement.clientHeight:this[0].clientHeight}return 0},outerWidth:function(){return 0<this.length?this[0].offsetWidth:0},outerHeight:function(){return 0<this.length?this[0].offsetHeight:0},offset:function(){if(0<this.length){var a=this[0].getBoundingClientRect(),b=0,c=0;"pageYOffset"in window?(b=window.pageXOffset,c=window.pageYOffset):(b=document.body.scrollLeft,c=
document.body.scrollTop);return{top:a.top+c,left:a.left+b}}return{left:0,top:0}},clone:function(){return this.length?pa(this[0].cloneNode(!0)):new ja},find:function(a){var b=new ja;this.length&&oa(this[0],b,a);return b},La:function(a,b){if(2===arguments.length){for(var c=0;c<this.length;c++)this[c].setAttribute(a,b);return this}return 0<this.length?this[0].getAttribute(a):""},ac:function(a){for(var b=0;b<this.length;b++)a(this[b])},focus:function(){0<this.length&&this[0].focus();return this},blur:function(){0<
this.length&&this[0].blur();return this},submit:function(){for(var a=0;a<this.length;a++)this[a].submit();return this},$:function(a,b){var c=a.split("-");a=c[0];for(var d=1;d<c.length;d++)a+=c[d].substr(0,1).toUpperCase()+c[d].substr(1);if(2===arguments.length){for(d=0;d<this.length;d++)this[d].style[a]=""+b;return this}return this[0].currentStyle?this[0].currentStyle[a]:window.getComputedStyle?window.getComputedStyle(this[0],null)[a]:this[0].style[a]},on:function(a,b){window.addEventListener?this.ac(function(c){b.cg=
function(a){a.Hb=a;"which"in a||(a.which=a.button);return b.call(c,a)};c.addEventListener(a,b.cg,!1)}):this.ac(function(c){c.attachEvent("on"+a,function(a){a.Hb=a;a.which=a.button;a.pageX=a.clientX;a.pageY=a.clientY;a.preventDefault=function(){a.returnValue=!1};a.stopPropagation=function(){a.cancelBubble=!0};return b.call(c,a)})});return this},bind:function(a,b){return this.on(a,b)},click:function(a){return this.on("click",a)},xe:function(a){return this.on("change",a)},resize:function(a){return this.on("resize",
a)}};function ca(a){for(var b=0;b<a.length;b++)a[b].style.display="block"}function qa(a,b,c){ra(sa(a,b),c)}function ra(a,b){a.on("mouseout",b)}function sa(a,b){return a.on("mouseover",b)}function ta(a,b){a.on("dblclick",b)}function ua(a,b){a.on("mousemove",b)}function va(a,b){a.on("mouseup",b)}function wa(a,b){a.on("mousedown",b)}function xa(a,b){a.on("keydown",b)}
function ya(a,b){if(b&&"string"===typeof b)for(var c=(b||"").split(la),d=0,e=a.length;d<e;d++){var f=a[d];if(1===f.nodeType)if(f.className){for(var g=" "+f.className+" ",h=f.className,l=0,k=c.length;l<k;l++)0>g.indexOf(" "+c[l]+" ")&&(h+=" "+c[l]);f.className=ka.trim(h)}else f.className=b}return a}function za(a){for(var b=0;b<a.length;b++)a[b].removeAttribute("id");return a}function Aa(a,b){for(var c=0;c<a.length;c++)a[c].innerHTML=b;return a}
function Ba(a){a.ac(function(a){var c;document.createEventObject?(c=document.createEventObject(),a.fireEvent("onmousedown",c)):(c=document.createEvent("HTMLEvents"),c.initEvent("mousedown",!0,!0),a.dispatchEvent(c))})}function ba(a,b){b=pa(b);0<a.length&&0<b.length&&b[0].parentNode.insertBefore(a[0],b[0])}ka=function(a){return pa(a)};ka.trim=function(a){return null===a?"":a.toString().replace(ma,"").replace(na,"")};
ka.hg=function(a){var b=a.url||"",c=a.type||"GET",d=a.Ih||function(){},e=a.error||function(){};a=a.data||"";var f="",g;try{g=new XMLHttpRequest}catch(h){try{g=new ActiveXObject("Msxml2.XMLHTTP")}catch(l){try{g=new ActiveXObject("Microsoft.XMLHTTP")}catch(k){e(null,"",null)}}}if("object"===typeof a)for(var p in a)Object.hasOwnProperty.call(a,p)&&(f.length&&(f+="&"),f+=encodeURIComponent(p),f+="=",f+=encodeURIComponent(a[p]));"GET"===c&&(b+="?"+f,f="");g.open(c,b,!0);g.onreadystatechange=function(){if(4===
g.readyState)if(200===g.status){var a=g.responseText;if(0===g.getResponseHeader("content-type").indexOf("application/json"))try{a=ka.Rg(a)}catch(b){}d(a,"",g)}else e(g,"",null)};"POST"===c&&g.setRequestHeader("Content-Type","application/x-www-form-urlencoded");g.send(f)};
document.wg=function(a){var b=[],c,d;c=a.split(/\s+/);for(a=0;a<c.length;a++)d=c[a].replace(/([\/\\\^$*+?.()|\[\]{}])/g,"\\$1"),b.push(new RegExp("(^|\\s)"+d+"(\\s|$)"));var e=document.getElementsByTagName("*"),f=[];a=0;for(d=e.length;a<d;a++){var g=e[a],h=!0;for(c=0;c<b.length;c++)if(!b[c].test(g.className)){h=!1;break}h&&f.push(g)}return f};ka.Rg=function(a){return window.JSON?window.JSON.parse(a):eval("("+a+")")};
ka.extend=function(a){for(var b=arguments[0],c=1;c<arguments.length;c++){var d=arguments[c],e;for(e in d)d.hasOwnProperty(e)&&(b[e]=d[e])}return b};ka.vc=ja.prototype;var n=ka;var Ca=r("MISC");function Da(a){var b=document.createElement("canvas");a&&a.appendChild(b);"G_vmlCanvasManager"in window&&(Ca("Emulating canvas in IE"),G_vmlCanvasManager.initElement(b),n(b).bind("selectstart",function(a){Ca("Cancelled selectstart on canvas");a.stopPropagation();a.preventDefault()}));return b}var Ea=/MSIE ([0-9]{1,}[\.0-9]{0,})/,Fa=null;
function Ga(){var a;if(null!==Fa)a=Fa;else{a=-1;if("Microsoft Internet Explorer"===navigator.appName){var b=Ea.exec(navigator.userAgent);null!==b&&(a=parseFloat(b[1]))}Fa=a;Ca("IE version is %s",a)}return 0<=a&&9>a}function Ha(a){for(var b=0;a;)try{var c=parseInt(n(a).$("z-index"),10);c&&(b=Math.max(b,c));a=a.parentNode}catch(d){break}return b};var Ia=r("Cookies");function Ja(a){this.Ba(a)}
Ja.prototype={log:r("Layout"),Ba:function(a){this.fc=a.itemSize||100;this.qe=a.algorithm||"wrap";this.zf=a.gravity||"down";this.nf=!1!==a.resize;"down"===this.zf?(this.offsetWidth="offsetWidth",this.offsetHeight="offsetHeight",this.width="width",this.height="height",this.top="top",this.left="left",this.clientWidth="clientWidth",this.clientHeight="clientHeight"):"up"===this.zf?(this.offsetWidth="offsetWidth",this.offsetHeight="offsetHeight",this.width="width",this.height="height",this.top="bottom",
this.left="left",this.clientWidth="clientWidth",this.clientHeight="clientHeight"):(this.offsetWidth="offsetHeight",this.offsetHeight="offsetWidth",this.width="height",this.height="width",this.top="left",this.left="top",this.clientWidth="clientHeight",this.clientHeight="clientWidth")},Md:function(a){"absolute"!==window.getComputedStyle(a,null).getPropertyValue("position")&&(a.style.position="relative");for(var b=0;b<a.children.length;b++)a.children[b].style.position="absolute";if("wrap"===this.qe)for(var b=
a[this.clientWidth],c=0,d=0,e=0,f=0;f<a.children.length;f++){var g=a.children[f];Ka(this,g,this.fc);var h=g[this.offsetWidth],l=g[this.offsetHeight];window.console.log(c,d,h,e);c+h>b?0===c?(La(this,g,c,d),d+=l):(d+=e,c=0,La(this,g,c,d),e=l):(La(this,g,c,d),c+=h,e=Math.max(e,l))}else if("mason"===this.qe)if(e=a[this.clientWidth],d=c=0,0>=e)this.log("Skipping layout; width is <= 0");else{this.log("Laying out to width %s",e);b=Math.round(e/this.fc);this.fc=e/b;e=[];for(f=0;f<b;f++)e.push(0);for(f=0;f<
a.children.length;f++){g=a.children[f];Ka(this,g,this.fc);h=g[this.offsetHeight];l=0;for(c=1;c<b;c++)e[c]<e[l]&&(l=c);c=l*this.fc;d=e[l];La(this,g,c,d);e[l]+=h}}else if("perfect"===this.qe){b=a[this.clientWidth];c=h=0;d=[];for(e=h=0;e<a.children.length;e++){f=a.children[e];Ma(this,f,this.fc);g=f[this.offsetWidth];if(h+g>b)if(0===d.length){La(this,f,0,c);Ka(this,f,b);c+=f[this.offsetHeight];continue}else{for(var k=b/h,p=h=0;p<d.length;p++)l=d[p],Ma(this,l,this.fc*k),La(this,l,h,c),h+=l[this.offsetWidth];
c+=this.fc*k;h=0;d.length=0}d.push(f);h+=g}for(e=h=0;e<d.length;e++)l=d[e],La(this,l,h,c),h+=l[this.offsetWidth]}}};function La(a,b,c,d){b.style[a.top]=d+"px";b.style[a.left]=c+"px"}function Ma(a,b,c){if(a.nf){var d=b[a.offsetWidth],e=b[a.offsetHeight];b.style[a.height]=""+c+"px";b.style[a.width]=""+c/e*d+"px"}}function Ka(a,b,c){if(a.nf){var d=b[a.offsetWidth],e=b[a.offsetHeight];b.style[a.width]=""+c+"px";b.style[a.height]=""+c/d*e+"px"}};function Na(a,b,c,d,e){this.view=a;this.ka=b;this.handle=c;this.Lf=b.yf(c);this.Ya(d,e)}
Na.prototype={log:r("MoveEditNode"),cc:function(){this.log("Entering MoveEditNode")},yc:function(){this.log("Leaving MoveEditNode")},$a:function(a){"touchmove"===a.type?(a=a.touches[0],a=s(this.view,a.pageX,a.pageY),this.Za(a.x,a.y)):"touchend"===a.type&&(a=a.changedTouches[0],a=s(this.view,a.pageX,a.pageY),this.fb(a.x,a.y))},Ya:function(a,b){this.log("onMouseDown(%s,%s)",a,b);this.oh=a;this.ph=b},Za:function(a,b){var c=this.view.Wa(new u(a,b));a=c.x;b=c.y;this.ka.kd(this.handle,a,b);this.ka.format(this.view.ga,
this.view.nb);this.view.la()},fb:function(a,b){this.log("onMouseUp(%s,%s)",a,b);var c=this.view.Wa(new u(a,b));a=c.x;b=c.y;a===this.oh&&b===this.ph||this.view.qa([new Oa(this.ka.id,this.handle,this.Lf.x,this.Lf.y,a,b)]);this.view.la();y(this.view,new Pa(this.view))}};function Qa(){}
Qa.prototype={log:r("ServerRenderer"),start:function(){},Ee:function(a,b,c){var d=document.createElement("form"),e=document.createElement("input"),f=document.createElement("input");document.body.appendChild(d);d.appendChild(e);d.appendChild(f);if(c){var g=document.createElement("input");g.type="hidden";g.name="filename";g.value=c;d.appendChild(g)}d.method="post";d.action="http://zwibbler.com/server.cgi";e.type="hidden";e.name="type";e.value=b;f.type="hidden";f.name="document";f.value=a.save("zwibbler3");
d.submit();document.body.removeChild(d)}};function Ra(a){this.code="en";if("string"===typeof a){a=a.split("\n");for(var b=/^([ \t]*)([^:]+):([^:]+):(.*)/,c={},d=0;d<a.length;d++){var e=b.exec(a[d]);if(e){var f=e[2],g=e[3],e=e[4];f in c||(c[f]={});g in c[f]&&this.log("Warning: Replacing %s:%s",f,g);c[f][g]=e}}a=c}this.data=a}Ra.prototype={log:r("LANGUAGE"),vc:function(){var a=this;return function(b,c){return Sa(a,arguments)}},get:function(a,b){return Sa(this,arguments)}};
function Sa(a,b){var c=b[0],d="<not translated:"+c+">";a.code in a.data&&c in a.data[a.code]&&(d=a.data[a.code][c]);for(c=1;c<b.length;c++)d=d.replace("^"+c,b[c]);return d}function Ta(a,b){a.code=b};function Ua(a,b,c,d){this.Qg=a;this.Pa=b;this.te=c;this.data=d;this.id="-1"}Ua.prototype={log:r("TRANS"),Zd:function(a){for(var b=0;b<this.Pa.length;b++)this.Pa[b].Zd(a)}};function z(){this.Sd=!1;this.Fa={}}
z.prototype={log:r("EventEmitter"),emit:function(a,b){var c,d=this;this.Fa||(this.Fa={});c=Array.prototype.slice.call(arguments,1);setTimeout(function(){var b,f,g,h,l=!1;if(a in d.Fa)for(h=d.Fa[a],f=0,g=h.length;f<g;f++)b=h[f],d.Sd||l||(d.log("Emit %s",a),l=!0),b.apply(null,c)},0);return this},rf:function(a,b){var c;this.Fa||(this.Fa={});c=Array.prototype.slice.call(arguments,1);var d,e,f,g,h=!1;if(a in this.Fa)for(g=this.Fa[a],e=0,f=g.length;e<f;e++)d=g[e],this.Sd||h||(this.log("Emit %s",a),h=!0),
d.apply(null,c);return this},on:function(a,b){this.Fa||(this.Fa={});this.bind(a,b);return this},bind:function(a,b){a in this.Fa?this.Fa[a].push(b):this.Fa[a]=[b];return b}};function Va(a){z.call(this);this.aa=a;this.pe=!1;a.$("display","none");this.duration=200;this.right=!0;a:{a=(document.body||document.documentElement).style;for(var b="transition",c=["Moz","Webkit","Khtml","O","ms"],b=b.charAt(0).toUpperCase()+b.substr(1),d=0;d<c.length;d++)if("string"===typeof a[c[d]+b]){Wa=c[d];a=!0;break a}a=!1}this.vd=a;this.prefix=Wa;this.ad=null;this.vd&&(a=this.aa.outerWidth(),this.$("TransitionProperty","transform"),this.$("Transform","translate("+a+"px,0)"))}var Wa;
Va.prototype={log:r("SlidingPanel",!1),show:function(a,b){var c=this;this.ad&&(clearTimeout(this.ad),this.ad=null);!1!==b&&(b=!0);this.pe=!0;this.aa.show();var d=this.aa.outerWidth();this.aa.Ga();"right"===a?(this.left=!1,this.aa.$("left",""+(n(window).width()-d)+"px")):this.left=!0;b&&(c.Ib=new aa,c.Ib.zIndex=c.aa.$("z-index"),c.Ib.insertBefore=c.aa,c.Ib.show(function(){c.Ga()}));c.vd?(c.$("TransitionDuration","0"),window.setTimeout(function(){c.aa.$("display","block");c.left?c.$("Transform","translate(-"+
d+"px,0)"):c.$("Transform","translate("+d+"px,0)");c.$("TransitionDuration",""+c.duration+"ms");window.setTimeout(function(){c.$("Transform","translate(0,0)");window.setTimeout(function(){c.emit("show")},c.duration)},1)},1)):(c.aa.$("display","block"),c.emit("show"))},$:function(a,b){a=""!==this.prefix?this.prefix+a:a.charAt(0).toLowerCase()+a.substr(1);this.aa[0].style[a]=b},eb:function(){return this.pe},Ga:function(){var a=this;if(!this.ad){this.pe=!1;a.Ib&&a.Ib.Ga();var b=this.aa.outerWidth();
a.vd?this.left?a.$("Transform","translate(-"+b+"px,0)"):a.$("Transform","translate("+b+"px,0)"):a.aa.$("display","none");a.vd?this.ad=window.setTimeout(function(){a.aa.$("display","none");a.emit("hide")},a.duration):a.emit("hide")}}};Va.prototype=n.extend({},z.prototype,Va.prototype);function Xa(){var a=this;z.call(this);window.addEventListener("message",function(b){Ya(a,b)},!1);window.parent.postMessage('{"event": "ready"}',"*")}Xa.prototype={log:r("Api")};
function Ya(a,b){function c(a){"ticket"in d&&(a={ticket:d.ticket,args:a},window.parent.postMessage(window.JSON.stringify(a),"*"))}var d;try{d=window.JSON.parse(b.data)}catch(e){a.log("Error parsing %s from %s",b.data,b.origin);return}a.log("Received %s",b.data);if(d["function"]in a.Fa)for(var f=a.Fa[d["function"]],g=0;g<f.length;g++)(0,f[g])(d.args,c)}Xa.prototype=n.extend({},z.prototype,Xa.prototype);function Za(a,b){var c=this;z.call(this);this.Sg=b;this.aa=n(a);this.current=0;if(!b){this.aa.$("overflow-y","scroll");this.aa.$("text-align","center");var d=n("<input>").La("type","button").La("value","Add Page");this.aa.append(d);d.click(function(){c.oa.md(c.oa.dd(c.oa.Lc()+1))});d=n("<input>").La("type","button").La("value","Delete Page");this.aa.append(d);d.click(function(){c.oa.qf(c.oa.Lc())});this.enabled=!1}this.Cb=[]}
Za.prototype={log:r("PageSelector"),xb:function(a){this.log("Set page %s",a);this.page<this.Cb.length&&n(this.Cb[this.page]).$("border-color","transparent");this.page=a;this.page<this.Cb.length&&n(this.Cb[this.page]).$("border-color","#9fb3e7")}};
function $a(a,b){var c=Da(a.aa[0]);a.Sg||(n(c).$("margin-left","10px"),n(c).$("margin-right","10px"),n(c).$("margin-top","5px"),n(c).$("margin-bottom","5px"));n(c).$("border-width","3px");a.log("Make canvas for page %s, currentPage is %s",b,a.page);b===a.page?n(c).$("border-color","#9fb3e7"):n(c).$("border-color","transparent");n(c).$("border-style","solid");a.Cb.push(c);c.page=b;n(c).click(function(){a.oa.md(c.page)});return c}
function ab(a){a.log("Regenerate page views.");var b=a.aa.width()-6,c=a.aa.height()-6,d=a.oa.xc(),e=a.oa.xf();e.x=0;e.y=0;c>b?c=b/e.width*e.height:b=c/e.height*e.width;for(var f=0;f<d;f++){var g;g=f===a.Cb.length?$a(a,f):a.Cb[f];g.width=b;g.height=c;g=g.getContext("2d");g.save();g.fillStyle="#ffffff";g.fillRect(0,0,b,c);g.scale(b/e.width,b/e.width);a.oa.la(g,{page:f});g.restore()}for(;f<a.Cb.length;f++)n(a.Cb[f]).remove();a.Cb.length=d}
function bb(a,b){function c(){null===e&&d.enabled&&(e=setTimeout(function(){ab(d);d.xb(d.oa.Lc());e=null},100))}var d=a,e=null;a.oa=b;b.on("document-changed",function(){c()});b.on("resource-loaded",function(){c()});b.on("set-page",function(a){d.xb(a)})}function cb(a,b){a.enabled=b;a.enabled&&a.oa&&setTimeout(function(){ab(a)},10)}Za.prototype=n.extend({},z.prototype,Za.prototype);function db(a,b){this.Ba(a,b)}db.prototype={Ba:function(a,b){this.ea=b;this.kh=!0},la:function(a){a.moveTo(this.ea.x,this.ea.y)},Uc:function(){return null},bc:function(){return{x:1,y:0}}};function eb(a,b,c,d,e){this.Ba(a,b,c,d,e)}
eb.prototype={Ba:function(a,b,c,d,e){this.ea=b;this.pa=a;this.Dg=!0;this.kc=e;this.Zf=d;c.next();this.Vd=c.next();this.Wd=c.next();this.moveTo=this.Cc=null;this.format()},log:r("LINE"),format:function(){var a=C(this.pa.ea.x,this.pa.ea.y,this.ea.x,this.ea.y);this.Qc=this.length=a;var b=this.pa.ea.clone();if(this.pa.Dg&&this.kc){this.kc=Math.min(this.kc,a/2,this.pa.length/2);a=D(this.pa.ea.x,this.pa.ea.y,this.ea.x,this.ea.y);b.x+=a.x*this.kc;b.y+=a.y*this.kc;var a=this.pa,c=this.kc,d=D(a.yb.x,a.yb.y,
a.ea.x,a.ea.y),e=a.ea.clone();e.x-=d.x*c;e.y-=d.y*c;a.Cc=e;a.Qc-=c;c=a.Qc/10*a.Zf;10<c&&(c=10);var d=a.yb.x,f=a.yb.y,g=e.x,h=e.y,d=d+c,f=f+c;a.Ma=new u(d+a.Vd*(g+c-d),f+a.Vd*(h+c-f));d=a.yb.x-c;g=e.x-c;f=a.yb.y-c;h=e.y-c;a.Sa=new u(d+a.Wd*(g-d),f+a.Wd*(h-f));this.Qc-=this.kc}this.yb=b;null===this.Cc&&(this.Cc=this.ea);a=this.Qc/10*this.Zf;10<a&&(a=10);e=b.x;c=b.y;d=this.ea.x;f=this.ea.y;e+=a;c+=a;this.Ma=new u(e+this.Vd*(d+a-e),c+this.Vd*(f+a-c));e=b.x-a;d=this.ea.x-a;c=b.y-a;f=this.ea.y-a;this.Sa=
new u(e+this.Wd*(d-e),c+this.Wd*(f-c))},de:function(a){this.pa=a;this.format();this.pa.Cc&&(this.moveTo=this.pa.Cc)},la:function(a){this.kc&&(this.moveTo&&a.moveTo(this.moveTo.x,this.moveTo.y),a.quadraticCurveTo(this.pa.ea.x,this.pa.ea.y,this.yb.x,this.yb.y));a.bezierCurveTo(this.Ma.x,this.Ma.y,this.Sa.x,this.Sa.y,this.Cc.x,this.Cc.y)},Uc:function(){return this.pa?D(this.pa.ea.x,this.pa.ea.y,this.Ma.x,this.Ma.y):null},bc:function(){return D(this.Sa.x,this.Sa.y,this.ea.x,this.ea.y)}};
function fb(a,b,c){this.Ba(a,b,c)}
fb.prototype={Ba:function(a,b,c){this.ea=b;this.pa=a;this.$f=c;var d=C(a.ea.x,a.ea.y,b.x,b.y);d||(d=1);var e=(b.x-a.ea.x)/d,f=(b.y-a.ea.y)/d;this.Sa=new u(b.x-d*c*e,b.y-d*c*f);if(b=a.Sa){var g=D(a.pa.ea.x,a.pa.ea.y,a.ea.x,a.ea.y),h=C(a.pa.ea.x,a.pa.ea.y,a.ea.x,a.ea.y),e=.5*(e+g.x),f=.5*(f+g.y);b.x=a.ea.x-h*c*e;b.y=a.ea.y-h*c*f}this.Ma=new u(a.ea.x+d*c*e,a.ea.y+d*c*f);this.length=d},de:function(a){this.pa=a;var b=a.Sa,c=(this.ea.x-a.ea.x)/this.length,d=(this.ea.y-a.ea.y)/this.length,e=this.$f;if(b){var f=
D(a.pa.ea.x,a.pa.ea.y,a.ea.x,a.ea.y),g=C(a.pa.ea.x,a.pa.ea.y,a.ea.x,a.ea.y),c=.5*(c+f.x),d=.5*(d+f.y);b.x=a.ea.x-g*e*c;b.y=a.ea.y-g*e*d}this.Ma=new u(a.ea.x+this.length*e*c,a.ea.y+this.length*e*d)},la:function(a){a.bezierCurveTo(this.Ma.x,this.Ma.y,this.Sa.x,this.Sa.y,this.ea.x,this.ea.y)},Uc:function(){return this.pa?D(this.pa.ea.x,this.pa.ea.y,this.Ma.x,this.Ma.y):null},bc:function(){return 0<this.$f?D(this.Sa.x,this.Sa.y,this.ea.x,this.ea.y):D(this.pa.ea.x,this.pa.ea.y,this.ea.x,this.ea.y)}};
function gb(a,b,c){this.Ba(a,b,c)}gb.prototype={Ba:function(a,b,c){this.control=b;this.ea=c},la:function(a){a.quadraticCurveTo(this.control.x,this.control.y,this.ea.x,this.ea.y)},Uc:function(){return this.pa?D(this.pa.ea.x,this.pa.ea.y,this.control.x,this.control.y):null},bc:function(){return D(this.control.x,this.control.y,this.ea.x,this.ea.y)}};function hb(a,b,c,d){this.Ba(a,b,c,d)}
hb.prototype={Ba:function(a,b,c,d){this.control=b;this.ea=c;this.Vg=d},la:function(a){a.arcTo(this.control.x,this.control.y,this.ea.x,this.ea.y,this.Vg)}};function ib(a,b,c,d){this.Ba(a,b,c,d)}ib.prototype={Ba:function(a,b,c,d){this.Ma=b;this.Sa=c;this.ea=d;this.pa=a},la:function(a){a.bezierCurveTo(this.Ma.x,this.Ma.y,this.Sa.x,this.Sa.y,this.ea.x,this.ea.y)},Uc:function(){return this.pa?D(this.pa.ea.x,this.pa.ea.y,this.Ma.x,this.Ma.y):null},bc:function(){return D(this.Sa.x,this.Sa.y,this.ea.x,this.ea.y)}};
function jb(a,b,c,d,e){this.Ba(a,b,c,d,e)}
jb.prototype={log:r("SEGMENT"),Ba:function(a,b,c,d,e){this.pa=a;this.Ad=b;e*=2;var f=2*d.next()-1;d.next();d=this.pa.bc();if(!this.pa.kh&&d){var g=C(a.ea.x,a.ea.y,b.x,b.y);this.Ma=new u(a.ea.x+.5522847498*d.x*g,a.ea.y+.5522847498*d.y*g)}else this.Ma=new u(a.ea.x+.5522847498*(b.x-a.ea.x),a.ea.y+.5522847498*(b.y-a.ea.y));this.Sa=new u(c.x-.5522847498*(c.x-b.x)*(1-f*e),c.y-.5522847498*(c.y-b.y)*(1-f*e));this.ea=c},de:function(a){this.pa=a;var b=this.pa.bc();if(b){var c=C(a.ea.x,a.ea.y,this.Ad.x,this.Ad.y);
this.Ma=new u(a.ea.x+.5522847498*b.x*c,a.ea.y+.5522847498*b.y*c)}else this.Ma=new u(a.ea.x+.5522847498*(this.Ad.x-this.pa.ea.x),a.ea.y+.5522847498*(this.Ad.y-this.pa.ea.y))},la:function(a){a.bezierCurveTo(this.Ma.x,this.Ma.y,this.Sa.x,this.Sa.y,this.ea.x,this.ea.y)},Uc:function(){return this.pa?D(this.pa.ea.x,this.pa.ea.y,this.Ma.x,this.Ma.y):null},bc:function(){return D(this.Sa.x,this.Sa.y,this.ea.x,this.ea.y)}};var E=[],kb=null,lb=r("ImageLoader");function mb(){var a=[];lb("Timeout running... %s images remaining",E.length);for(var b=0;b<E.length;b++)E[b].complete?E[b].vc(E[b],E[b].qd):5E3>E[b].fe?(E[b].fe+=250,a.push(E[b])):E[b].vc(E[b],E[b].qd);E=a;E.length?setTimeout(mb,250):(lb("Timeout Stopped"),kb=!1)}
function nb(a,b){function c(){lb("LoadFn called. complete=%s",d.complete);if(d.complete)for(var a=0;a<E.length;a++){if(E[a]===d){E.splice(a,1);b(d,d.qd);break}}else kb||(kb=!0,setTimeout(mb,250),d.fe=250)}var d=document.createElement("img");E.push(d);d.vc=b;d.qd=a;d.fe=0;d.addEventListener?(d.addEventListener("load",function(){c()},!1),d.addEventListener("error",function(){lb("Error loading %s",a);b(null,d.qd)},!1)):(d.attachEvent("onload",function(){c()}),d.attachEvent("onerror",function(){lb("Error loading %s",
a);b(null,d.qd)}));d.src=a};function ob(){}
ob.prototype={log:r("MJAX"),load:function(a){var b,c,d=this;c=n("<script>").La("type","text/x-mathjax-config");c.text("MathJax.Hub.Config({\n   extensions: [\"mml2jax.js\"],\n   mml2jax: { \n   },\n   jax: ['input/MathML', 'output/SVG']\n});");n(document.body).append(c);c=n("<script>").La("type","text/javascript");c.La("src","http://cdn.mathjax.org/mathjax/latest/MathJax.js?delayStartupUntil=loaded");n(document.body).append(c);this.log("Loading mathjax");b=setInterval(function(){if("MathJax"in window)return d.log("MathJax finished loading."),
clearInterval(b),window.MathJax.Hub.Startup.onload(),a&&a(),MathJax.Hub.Startup.signal.Interest(function(a){return d.log("%s",a)})},500)},Yg:function(a,b){var c,d,e=this;c=window.MathJax.Hub.queue;d=Aa(n("<div>"),a);d.$("position","absolute");d.$("z-index","10000");d.$("background","#cccccc");d.$("display","block");n(document.body).append(d);c.Push(["Typeset",window.MathJax.Hub,d[0]]);c.Push(function(){var a,c,h,l,k,p,q,t,x,v,w,B,A;c=d.find("svg");if(0===c.length)e.log("Failed to render MJax -- no SVG found"),
d.$("display","none"),b&&b(null);else{l=c[0].getBoundingClientRect();x=2*l.width;l=2*l.height;t=c.find("use");B=0;for(A=t.length;B<A;B++)a=t[B],a=n(a),k=a.La("href"),v=a.La("x")||0,w=a.La("y")||0,h=a.La("transform")||"",e.log("USE HREF=%s x=%s y=%s... cloning",k,v,w),k=za(n(k).clone()),h=""!==h?h+(",translate("+v+","+w+")"):"translate("+v+","+w+")",k.La("transform",h),a.length&&a[0].parentNode.replaceChild(k[0],a[0]);h=document.createElement("svg");w=c[0].childNodes;t=0;for(v=w.length;t<v;t++)a=w[t],
h.appendChild(a.cloneNode(!0));c.La("id","hello");c='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" '+('viewBox="'+c[0].getAttribute("viewBox")+'" ');c=c+('width="'+x+'" ')+('height="'+l+'" ');c+=">";c+=h.innerHTML;c+="</svg>";d.remove();c="data:image/svg+xml,"+encodeURIComponent(c);q=new Image;q.src=c;q=n(q);q.$("position","absolute");q.$("z-index","10000");q.$("top","100px");q.$("width",""+x+"px");q.$("height",""+l+"px");q.$("visibility","hidden");n(document.body).append(q);e.log("img loaded: %s",
q[0].complete);p=setInterval(function(){e.log("img loaded: %s",q[0].complete);if(q[0].complete&&(clearInterval(p),b))return b(q[0])},100)}})}};function pb(){z.apply(this,arguments);this.jc=[];this.Kb=!1;this.canvas=this.Re=null}pb.prototype={log:r("FORMAT",!0),add:function(a,b,c,d,e){var f,g,h,l;l=this.jc;g=0;for(h=l.length;g<h;g++)f=l[g],f.type===b&&f.ka===a&&(f.pd=!0);this.log("Request URL %s",c);this.jc.push({ka:a,type:b,url:c,Pg:d,ve:e,pd:!1});this.check()},ef:function(a){this.Re=a;this.check()},check:function(){for(var a=0;!this.Kb&&a<this.jc.length;)this.jc[a].pd?this.jc.shift():(qb(this,this.jc[0]),a+=1);this.Kb||this.emit("done")}};
function qb(a,b){a.Kb=!0;a.log("Processing request for item %s url=%s",b.ka.id,b.url);0===b.type.indexOf("image")?nb(b.url,function(c,d){null!==c?(a.log("Image request completed for item %s url %s",b.ka.id,d),b.ve(c,d)):a.log("Image request failed for url %s",d);a.Kb=!1;b.pd=!0;a.check()}):0===b.type.indexOf("math")?null===a.Re?a.Kb=!1:a.Re.Yg(b.url,function(c){a.log("MathJax request completed for item %s",b.ka.id);b.ve(c,b.url);a.Kb=!1;b.pd=!0;a.check()}):n.hg({url:b.url,data:b.Pg,dataType:"json",
success:function(c){b.pd||(a.log("Request completed for item %s",b.ka.id),b.ve(c),a.emit("reformat",b.ka),a.Kb=!1,a.jc.shift(),a.check())},error:function(b,d,e){a.log("Error: %s %s",d,e);a.Kb=!1;a.jc.shift();a.check()}})}pb.prototype=n.extend({},z.prototype,pb.prototype);function rb(a,b){if(!a)throw b||"Assertion failed";}function sb(a){rb("number"===typeof a,"Expected a number")}function tb(a){return"object"===typeof a&&"[object Array]"===Object.prototype.toString.apply(a)}function ub(a){return"number"===typeof a};function vb(){this.Da=[];this.next=0}
vb.prototype={log:r("TRANSLIST"),qa:function(a,b,c){var d;c=c||null;d=this.Da.length?this.Da[this.Da.length-1].id:"0";this.Da.length=this.next;null===c?(this.Da.push(new Ua(d,b,a.Ca,null)),this.Ra(a)):(this.Da.push(new Ua(d,b,c,null)),this.next+=1)},ye:function(a,b,c,d){if(b.Qg!==(this.Da.length?this.Da[this.Da.length-1].id:"0"))throw"ERROR! mismatched parent id";if(b.te!==a.Ca)throw"ERROR! mismatched base id";this.Da.length=this.next;this.Da.push(b);return this.Ra(a,c,d)},Ra:function(a,b,c){var d,
e,f,g;b=b||null;c=c||null;if(this.next===this.Da.length)return!1;rb(a.Ca===this.Da[this.next].te);g=this.Da[this.next].Pa;e=0;for(f=g.length;e<f;e++)d=g[e],b&&d.Zc(a,b),c&&wb(d,a,c),d.Ra(a);this.next+=1;return!0},Ua:function(a,b,c){var d,e,f;b=b||null;c=c||null;if(0===this.next)return!1;this.next-=1;d=this.Da[this.next].Pa;if(0!==d.length){for(e=f=d.length-1;0<=f&&!(0>e);e=f+=-1)d[e].Ua(a),b&&d[e].Zc(a,b),c&&wb(d[e],a,c);xb(a,this.Da[this.next].te)}},Ic:function(){return 0<this.next},Hc:function(){return this.next<
this.Da.length}};function yb(a){this.keys={};1===arguments.length&&this.add(arguments[0]);1===arguments.length&&"object"===typeof arguments[0]&&this.add(arguments[0])}
yb.prototype={contains:function(a){return a in this.keys},add:function(a){var b,c;if("string"===typeof a||"number"===typeof a)this.keys[a]=!0;else if("object"===typeof a)if("[object Array]"===Object.prototype.toString.apply(a))for(c=0;c<a.length;c++)b=a[c],this.keys[b]=!0;else for(b in a)a.hasOwnProperty(b)&&(this.keys[b]=!0);else return rb(!1,"Arg must be an array")},remove:function(a){delete this.keys[a]},Jb:function(){var a,b;b=[];for(a in this.keys)this.keys.hasOwnProperty(a)&&b.push(a);return b},
clear:function(){this.keys={}}};function Bb(a){var b,c;c=[];for(b in a.keys)a.keys.hasOwnProperty(b)&&c.push(parseFloat(b));return c};function Cb(a){this.Ba(a)}Cb.prototype={Ba:function(a){if("string"===typeof a){for(;8>a.length;)a+=a;for(var b=16777619,c=0;c<a.length;c++)b=(16777619*b^a.charCodeAt(c))&4294967295;a=b}this.Rf=a;this.reset()},reset:function(){this.Od=this.Nd=this.Rf},next:function(){this.Od=36969*(this.Od&65535)+(this.Od>>16);this.Nd=18E3*(this.Nd&65535)+(this.Nd>>16);return((this.Od<<16)+this.Nd)/4294967295/2+.5}};function F(a,b){for(var c in a)a.hasOwnProperty(c)&&!b.hasOwnProperty(c)&&(b[c]=a[c])};function Db(){z.call(this);this.aa=document.createElement("div");this.aa.style.width="50px";this.aa.style.height="320px";this.aa.style.border="none";this.Ac={};this.ge=1;this.buttons=[];this.wc=0}
Db.prototype={width:function(){return parseInt(this.aa.style.width,10)},focus:function(a){0<this.buttons.length&&(0<arguments.length&&(Eb(this,!1),this.wc=a),Eb(this,!0))},blur:function(){0<this.buttons.length&&Eb(this,!1)},Gb:function(a,b){if(0!==this.buttons.length){var c="next"===a||"previous"===a;c&&Eb(this,!1);switch(a){case "next":this.wc=Math.min(this.wc+1,this.buttons.length-1);break;case "previous":this.wc=Math.max(this.wc-1,0);break;case "enter":this.buttons[this.wc].yd(b)}c&&(Eb(this,!0),
b.stopPropagation(),b.preventDefault())}},moveTo:function(a,b){n(this.aa).$("left",""+a+"px");n(this.aa).$("top",""+b+"px")},show:function(a){this.aa.style.display=a||0===arguments.length?"block":"none"},log:r("TOOLBAR"),lb:function(a,b,c){function d(){var a=e.style.background;e.style.background="#e7d69f";f.style.background="#e7d69f";var b=e.style.background;setTimeout(function(){e.style.background===b&&(e.style.background=a,f.style.background=a)},200)}var e=document.createElement("div"),f=document.createElement("img"),
g=this;e.style.display="inline";e.style.cssFloat="left";e.style.overflow="hidden";e.style.width="50px";e.style.height="50px";e.style.margin="1px";f.src=a;f.aa=e;f.style.cursor="hand";f.setAttribute("title",b);f.draggable=!1;e.appendChild(f);n(f).bind("load",function(){g.log("Toolbar image loaded; %sx%s",f.width,f.height);var a=(50-f.height)/2;f.style.marginLeft=(50-f.width)/2+"px";f.style.marginTop=a+"px"});this.aa.appendChild(e);var h=this.buttons.length;c&&(n(e).bind("touchstart",function(a){a.preventDefault();
g.log("Got touchstart");d();c(a);g.emit("click",a)}),n(e).click(function(a){g.log("Got a click");d();c(a);g.focus(h);g.emit("click",a)}));this.ge+=51;this.buttons.push({element:e,yd:c});return f}};function Fb(a,b){for(var c in a.Ac)a.Ac.hasOwnProperty(c)&&(a.Ac[c].aa.style.background="#ffffff",a.Ac[c].style.background="#ffffff");b in a.Ac?(c=a.Ac[b],a.log("Highlight %s",b),c.aa.style.background="#9fb3e7",c.style.background="#9fb3e7"):a.log("Failed to highlight %s",b)}
function Gb(a,b,c,d,e){a.Ac[b]=a.lb(d,c,e)}function Eb(a,b){a.buttons[a.wc].element.style.outline=b?"1px dotted gray":"none"}F(z.prototype,Db.prototype);function Hb(){z.call(this);this.Ba()}
Hb.prototype={Ba:function(){this.keys={};this.Sd=!0;this.mh=new RegExp("alt backspace cmd command control ctrl del delete down end enter esc escape f4 home ins insert left meta pagedown pageup right shift up \u2318".split(" ").sort(function(a,c){return c.length-a.length}).join("|"),"g");var a=this;this.Ag=function(b){for(var c=a.translate(b),d=0;d<c.length;d++)a.log("action: %s",c[d]),a.rf("*",c[d],b)}},log:r("KEYMAP"),map:function(a,b){for(var c=a.toLowerCase().split(","),d=b.split(","),e=0;e<c.length;e++)for(var f=
0;f<d.length;f++)Ib(this,c[e],d[f])},translate:function(a){var b=[],c="";a.keyCode&&(c+=a.keyCode);a.shiftKey&&(c+="-shift");a.ctrlKey&&(c+="-control");a.altKey&&(c+="-alt");a.metaKey&&(c+="-meta");a=c;a in this.keys&&(b=this.keys[a]);this.log("%s",a);return b},ac:function(a,b){for(var c=this.translate(a),d=0;d<c.length;d++)b(c[d])}};function Jb(a,b){n(b).bind("keydown",a.Ag)}
function Ib(a,b,c){if(0!==b.length){var d=b.match(a.mh)||[],e=!1,f=!1,g=!1,h=!1,l=[],k;for(k=0;k<d.length;k++)switch(d[k]){case "alt":g=!0;break;case "control":case "ctrl":f=!0;break;case "shift":e=!0;break;case "shift":e=!0;break;case "home":l.push(36);break;case "end":l.push(35);break;case "pageup":l.push(33);break;case "pagedown":l.push(34);break;case "delete":case "del":l.push(46);break;case "backspace":l.push(8);break;case "up":l.push(38);break;case "right":l.push(39);break;case "down":l.push(40);
break;case "left":l.push(37);break;case "escape":case "esc":l.push(27);break;case "enter":l.push(13);break;case "f4":l.push(115);break;case "meta":case "command":case "cmd":case "\u2318":h=!0;break;default:alert("key entry not found: "+d[k])}d=function(b){e&&-1===b.indexOf("-shift")&&(b+="-shift");f&&-1===b.indexOf("-control")&&(b+="-control");g&&-1===b.indexOf("-alt")&&(b+="-alt");h&&-1===b.indexOf("-meta")&&(b+="-meta");a.log("Keyboard mapping: %s->%s",b,c);if(b in a.keys){for(var d=0,k=a.keys[b],
d=0;d<k.length&&k[d]!==c;d++);d===k.length&&a.keys[b].push(c)}else a.keys[b]=[c]};if(0===l.length)switch(b=b.toUpperCase().charAt(b.length-1),b){case "=":d("107-shift");d("187");d("61");break;case "+":d("107");d("61-shift");break;case "-":d("109");d("189");d("173");break;default:l.push(b.charCodeAt(0))}for(k=0;k<l.length;k++)d(""+l[k])}}F(z.prototype,Hb.prototype);function Kb(){var a=document.createElement("input");n(a).La("type","range");if("range"===a.type)return a.fh=function(b,c){a.min=b;a.max=c},a.zg=function(){return a.value},a.Wf=function(b){a.value=b},a;var b=n("<div>");b.$("display","inline-block");b.$("vertical-align","top");b.$("height","1em");b.$("width","10em");b.$("padding","0.25em");b.$("position","relative");var c=n("<div>");c.$("top","50%");c.$("height","0");c.$("border-top","1px solid black");c.$("border-bottom","1px solid #888888");c.$("position",
"absolute");c.$("left","0");c.$("right","0");var d=n("<div>");d.$("height","1em");d.$("left","0px");d.$("background","#888888");d.$("border-top","1px solid #cccccc");d.$("border-left","1px solid #cccccc");d.$("border-bottom","1px solid #000000");d.$("border-right","1px solid #000000");d.$("width","0.5em");d.$("position","absolute");d.$("cursor","pointer");b.append(c);b.append(d);b[0].type="range";b[0].min=0;b[0].max=100;b[0].value=0;b[0].onchange=function(){};b[0].fh=function(a,c){b[0].min=a;b[0].max=
c};b[0].Wf=function(a){b[0].value=a;var c=b.width()-d.width();a=a/b[0].max*c;a=Math.round(a);a=Math.max(a,0);a=Math.min(a,b.width());d.$("left",""+a+"px")};b[0].zg=function(){return b[0].value};var e,f,g,h=r("RANGE");wa(n(d),function(a){g=!0;e=a.pageX;f=parseInt(d.$("left"),10);h("Mousedown at %s, ox=%s",e,f);a.stopPropagation();a.preventDefault()});wa(n(b),function(a){var c=b.width()-d.width(),h=a.pageX-n(b).offset().left,h=Math.max(h,0),h=Math.min(h,c);d.$("left",""+h+"px");e=a.pageX;f=h;h=h/c*
(b[0].max-b[0].min)+b[0].min;h=Math.round(h);b[0].value=h;b[0].onchange();g=!0});ua(n(b),function(a){if(g){var c=b.width()-d.width();a=a.pageX-e+f;a=Math.max(a,0);a=Math.min(a,c);d.$("left",""+a+"px");a=a/c*(b[0].max-b[0].min)+b[0].min;a=Math.round(a);b[0].value=a;b[0].onchange()}});va(n(document.body),function(){g=!1});return b[0]};function u(a,b){this.x=a;this.y=b}u.prototype.Db=function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))};u.prototype.toString=function(){return"("+this.x+", "+this.y+")"};function Lb(a,b){return a.x===b.x&&a.y===b.y}u.prototype.clone=function(){return new u(this.x,this.y)};function Mb(a,b){this.width=a;this.height=b}function C(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))}function D(a,b,c,d){var e=C(a,b,c,d);return 0===e?{x:1,y:0}:{x:(c-a)/e,y:(d-b)/e}}
function Nb(a){a.x*=-1;a.y*=-1;return a}function G(a,b,c,d){this.x=a;this.y=b;this.width=c;this.height=d;0>this.width&&(this.x+=this.width,this.width=-this.width);0>this.height&&(this.y+=this.height,this.height=-this.height)}function Ob(a){if(0===a.length)return new G(0,0,0,0);for(var b=a[0].x,c=a[0].x,d=a[0].y,e=a[0].y,f=1;f<a.length;f++)a[f].x<b&&(b=a[f].x),a[f].x>c&&(c=a[f].x),a[f].y<d&&(d=a[f].y),a[f].y>e&&(e=a[f].y);return new G(b,d,c-b,e-d)}
G.prototype={save:function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},clone:function(){return new G(this.x,this.y,this.width,this.height)},contains:function(a){return this.x<=a.x&&this.x+this.width>a.x+a.width&&this.y<=a.y&&this.y+this.height>a.y+a.height},Lb:function(a,b){return this.x<=a&&this.x+this.width>a&&this.y<=b&&this.y+this.height>b},dc:function(a,b){void 0===b&&(b=a);this.x-=a/2;this.y-=b/2;this.width+=a;this.height+=b},transform:function(a){var b,c,d;b=a.apply(this.x,
this.y);c=a.apply(this.x+this.width,this.y);d=a.apply(this.x+this.width,this.y+this.height);a=a.apply(this.x,this.y+this.height);this.x=Math.min(b.x,c.x,d.x,a.x);this.y=Math.min(b.y,c.y,d.y,a.y);this.width=Math.max(b.x,c.x,d.x,a.x)-this.x;this.height=Math.max(b.y,c.y,d.y,a.y)-this.y},right:function(){return this.x+this.width},bottom:function(){return this.y+this.height}};function Pb(a){return new u(a.x+a.width/2,a.y+a.height/2)}
function Qb(a,b,c){b<a.x?(a.width+=a.x-b,a.x=b):b>a.x+a.width&&(a.width=b-a.x);c<a.y?(a.height+=a.y-c,a.y=c):c>a.y+a.height&&(a.height=c-a.y)}function Rb(a,b){b.x<a.x&&(a.width+=a.x-b.x,a.x=b.x);b.y<a.y&&(a.height+=a.y-b.y,a.y=b.y);b.x+b.width>a.x+a.width&&(a.width+=b.x+b.width-a.x-a.width);b.y+b.height>a.y+a.height&&(a.height+=b.y+b.height-a.y-a.height)}
function H(a){if(0===arguments.length)this.m11=1,this.m21=this.m12=0,this.m22=1,this.wa=this.va=0;else if(1===arguments.length){if(6!==arguments[0].length)throw"Bad array initializer for Matrix.";this.m11=arguments[0][0];this.m12=arguments[0][1];this.m21=arguments[0][2];this.m22=arguments[0][3];this.va=arguments[0][4];this.wa=arguments[0][5]}else if(6===arguments.length)this.m11=arguments[0],this.m12=arguments[1],this.m21=arguments[2],this.m22=arguments[3],this.va=arguments[4],this.wa=arguments[5];
else throw"Bad initializer for Matrix.";}m=H.prototype;m.toString=function(){return"[ "+this.m11+" "+this.m12+" "+this.va+"\n   "+this.m21+" "+this.m22+" "+this.wa+"\n   0 0 1 ]"};m.Jb=function(){return[this.m11,this.m12,this.m21,this.m22,this.va,this.wa]};m.kb="Matrix";
m.multiply=function(a){var b=new H;b.m11=this.m11*a.m11+this.m12*a.m21;b.m21=this.m21*a.m11+this.m22*a.m21;b.m12=this.m11*a.m12+this.m12*a.m22;b.m22=this.m21*a.m12+this.m22*a.m22;b.va=this.m11*a.va+this.m12*a.wa+this.va;b.wa=this.m21*a.va+this.m22*a.wa+this.wa;return b};m.apply=function(a,b){return new u(this.m11*a+this.m12*b+this.va,this.m21*a+this.m22*b+this.wa)};function Sb(a,b){b.transform(a.m11,a.m21,a.m12,a.m22,a.va,a.wa)}
m.clone=function(){return new H(this.m11,this.m12,this.m21,this.m22,this.va,this.wa)};m.inverse=function(){var a=this.m11*this.m22-this.m12*this.m21;return new H(this.m22/a,-this.m12/a,-this.m21/a,this.m11/a,(this.m12*this.wa-this.va*this.m22)/a,(this.va*this.m21-this.m11*this.wa)/a)};
function Tb(a,b,c,d){void 0===c?(this.m11=a,this.m21=this.m12=0,this.m22=b,this.Nf=this.Mf=this.wa=this.va=0):(this.m11=a,this.m21=this.m12=0,this.m22=b,this.va=c-a*c,this.wa=d-b*d,this.Mf=c,this.Nf=d);this.qh=a;this.rh=b}Tb.prototype.inverse=function(){return new Tb(1/this.qh,1/this.rh,this.Mf,this.Nf)};F(H.prototype,Tb.prototype);function Ub(a,b,c){var d=Math.cos(a),e=Math.sin(a);this.m11=d;this.m12=e;this.m21=-e;this.m22=d;this.va=-b*d-c*e+b;this.wa=b*e-c*d+c;this.re=a;this.x=b;this.y=c}
Ub.prototype.inverse=function(){return new Ub(-this.re,this.x,this.y)};F(H.prototype,Ub.prototype);function Vb(a,b,c){var d=Math.cos(2*a),e=Math.sin(2*a);this.m11=d;this.m21=this.m12=e;this.m22=-d;this.va=-b*d-c*e+b;this.wa=-b*e+c*d+c;this.re=a;this.x=b;this.y=c}Vb.prototype.inverse=function(){return new Vb(-this.re,this.x,this.y)};F(H.prototype,Vb.prototype);function I(a,b){this.m11=1;this.m21=this.m12=0;this.m22=1;this.va=a;this.wa=b}I.prototype.inverse=function(){return new I(-this.va,-this.wa)};
F(H.prototype,I.prototype);function Wb(a,b,c,d,e,f,g,h,l,k){if(!(8<++Xb)){var p=(b+d)/2,q=(c+e)/2,t=(d+f)/2,x=(e+g)/2,v=(f+h)/2,w=(g+l)/2,B=(p+t)/2,A=(q+x)/2,t=(t+v)/2,x=(x+w)/2,mc=(B+t)/2,nc=(A+x)/2,zb=h-b,Ab=l-c;d=Math.abs((d-h)*Ab-(e-l)*zb);f=Math.abs((f-h)*Ab-(g-l)*zb);(d+f)*(d+f)<k*(zb*zb+Ab*Ab)?a.push(new u(mc,nc)):(Wb(a,b,c,p,q,B,A,mc,nc,k),Wb(a,mc,nc,t,x,v,w,h,l,k))}Xb-=1}var Xb=0;
function Yb(a,b,c,d,e,f,g,h){if(!(8<++Xb)){var l=(b+d)/2,k=(c+e)/2,p=(d+f)/2,q=(e+g)/2,t=(l+p)/2,x=(k+q)/2,v=f-b,w=g-c;d=Math.abs((d-f)*w-(e-g)*v);d*d<=h*(v*v+w*w)?a.push(new u(t,x)):(Yb(a,b,c,l,k,t,x,h),Yb(a,t,x,p,q,f,g,h))}Xb-=1}function Zb(a,b,c){var d,e,f,g,h,l,k,p,q=0;if(3>a.length)return 0;f=a[a.length-1].x;g=a[a.length-1].y;for(p=0;p<a.length;p++)d=a[p].x,e=a[p].y,d>f?(h=f,k=d,l=g,g=e):(h=d,k=f,l=e),d<b===b<=f&&(c-l)*(k-h)<(g-l)*(b-h)&&(q=!q),f=d,g=e;return q}
function $b(a){this.closed=!1;this.da=[];a instanceof G&&(this.moveTo(a.x,a.y),this.lineTo(a.x+a.width,a.y),this.lineTo(a.x+a.width,a.y+a.height),this.lineTo(a.x,a.y+a.height),this.lineTo(a.x,a.y),this.close())}var ac=[3,3,7,5,1],bc=[1,1,3,2,0];
$b.prototype={moveTo:function(a,b){this.da.push(0,a,b)},lineTo:function(a,b){this.da.push(1,a,b)},bezierCurveTo:function(a,b,c,d,e,f){this.da.push(2,a,b,c,d,e,f)},quadraticCurveTo:function(a,b,c,d){this.da.push(3,a,b,c,d)},close:function(){this.da.push(4)},la:function(a){for(var b=0;b<this.da.length;){switch(this.da[b]){case 0:a.moveTo(this.da[b+1],this.da[b+2]);break;case 1:a.lineTo(this.da[b+1],this.da[b+2]);break;case 2:a.bezierCurveTo(this.da[b+1],this.da[b+2],this.da[b+3],this.da[b+4],this.da[b+
5],this.da[b+6]);break;case 3:a.quadraticCurveTo(this.da[b+1],this.da[b+2],this.da[b+3],this.da[b+4]);break;case 4:a.closePath();break;default:alert("Error!")}b+=ac[this.da[b]]}},transform:function(a){for(var b=0,c,d;b<this.da.length;){d=bc[this.da[b]];for(c=0;c<d;c++){var e=a.apply(this.da[b+1+2*c],this.da[b+1+2*c+1]);this.da[b+1+2*c]=e.x;this.da[b+1+2*c+1]=e.y}b+=ac[this.da[b]]}},clone:function(){var a=new $b;a.da=this.da.concat();return a},append:function(a){this.da=this.da.concat(a.da)}};
function cc(a,b,c){for(var d=0,e=0,f=c[0],g,h=new u(0,0),l;d<a.da.length;){switch(a.da[d]){case 0:l=a.da[d+1];g=a.da[d+2];b.moveTo(l,g);h=new u(l,g);break;case 1:l=a.da[d+1];var k=g=a.da[d+2],p=new u(l,k);g=h.Db(p);if(!(0>=g)){for(;g>f;)h.x+=(p.x-h.x)*f/g,h.y+=(p.y-h.y)*f/g,e&1?b.moveTo(h.x,h.y):b.lineTo(h.x,h.y),g-=f,e=(e+1)%c.length,f=c[e];g<=f&&(h=new u(l,k),e&1?b.moveTo(h.x,h.y):b.lineTo(h.x,h.y),f-=g)}}d+=ac[a.da[d]]}}
function dc(a,b){for(var c=0,d,e,f=new G(a.da[1],a.da[2],0,0),g;c<a.da.length;){switch(a.da[c]){case 0:case 1:d=a.da[c+1];e=a.da[c+2];Qb(f,d,e);break;case 2:var h=g=[],l=a.da[c+5],k=a.da[c+6];d!==l&&e!==k&&Wb(h,d,e,a.da[c+1],a.da[c+2],a.da[c+3],a.da[c+4],l,k,b*b);h.push(new u(l,k));for(d=0;d<g.length;d++)Qb(f,g[d].x,g[d].y);d=a.da[c+5];e=a.da[c+6];break;case 3:h=g=[];l=a.da[c+3];k=a.da[c+4];d!==l&&e!==k&&Yb(h,d,e,a.da[c+1],a.da[c+2],l,k,b*b);h.push(new u(l,k));for(d=0;d<g.length;d++)Qb(f,g[d].x,g[d].y);
d=a.da[c+3];e=a.da[c+4]}c+=ac[a.da[c]]}return f}function ec(a,b,c,d,e){var f;if(2>=d-c)e.push(a[c]);else{var g=a[c],h=a[d-1],l=0,k=0;for(f=c+1;f<d;f++){var p,q=a[f],t=g.x;p=g.y;var x=q.x,q=q.y,v=h.x-t,w=h.y-p,B=((x-t)*v+(q-p)*w)/(v*v+w*w);1<B?B=1:0>B&&(B=0);t=t+B*v-x;p=p+B*w-q;p=Math.sqrt(t*t+p*p);p>l&&(l=p,k=f)}0<k&&l>b?(ec(a,b,c,k,e),ec(a,b,k,d,e)):e.push(g)}}function fc(a,b){var c=[];ec(a,b,0,a.length,c);0<a.length&&0<c.length&&!Lb(a[a.length-1],c[c.length-1])&&c.push(a[a.length-1]);return c}
function J(a){this.ta=[];if(1===arguments.length){var b=arguments[0];b instanceof G?(this.ta.push(new u(b.x,b.y)),this.ta.push(new u(b.right(),b.y)),this.ta.push(new u(b.right(),b.bottom())),this.ta.push(new u(b.x,b.bottom()))):b instanceof Array?this.ta=b:alert("Bad parameter passed to Polygon() constructor.")}}
J.prototype={transform:function(a){for(var b=0;b<this.ta.length;b++)this.ta[b]=a.apply(this.ta[b].x,this.ta[b].y)},add:function(a,b){this.ta.push(new u(a,b))},Lb:function(a,b){return Zb(this.ta,a,b)},clone:function(){return new J(this.ta.slice(0))},dc:function(a){for(var b=[],c=0;c<this.ta.length;c++){var d=this.ta[0===c?this.ta.length-1:c-1],e=this.ta[c],f=this.ta[c===this.ta.length-1?0:c+1],g=C(d.x,d.y,e.x,e.y),h=C(f.x,f.y,e.x,e.y);b.push({x:e.x+((e.x-d.x)/g+(e.x-f.x)/h)/Math.sqrt(2)*a,y:e.y+((e.y-
d.y)/g+(e.y-f.y)/h)/Math.sqrt(2)*a})}this.ta=b},la:function(a){if(!(1>this.ta.length)){a.moveTo(this.ta[0].x,this.ta[0].y);for(var b=1;b<this.ta.length;b++)a.lineTo(this.ta[b].x,this.ta[b].y);a.closePath()}}};
function gc(a,b,c){for(var d=a.length-1,e=d+1,f=d+2,g=[],h=0;h<e;h++){g.push([]);for(var l=0;l<f;l++)g[h].push(0)}for(e=1;e<d;e++)g[e][e-1]=1/(a[e]-a[e-1]),g[e][e]=2*(1/(a[e]-a[e-1])+1/(a[e+1]-a[e])),g[e][e+1]=1/(a[e+1]-a[e]),g[e][d+1]=3*((b[e]-b[e-1])/((a[e]-a[e-1])*(a[e]-a[e-1]))+(b[e+1]-b[e])/((a[e+1]-a[e])*(a[e+1]-a[e])));g[0][0]=2/(a[1]-a[0]);g[0][1]=1/(a[1]-a[0]);g[0][d+1]=3*(b[1]-b[0])/((a[1]-a[0])*(a[1]-a[0]));g[d][d-1]=1/(a[d]-a[d-1]);g[d][d]=2/(a[d]-a[d-1]);g[d][d+1]=3*(b[d]-b[d-1])/((a[d]-
a[d-1])*(a[d]-a[d-1]));a=g.length;for(d=0;d<a;d++){e=0;f=Number.NEGATIVE_INFINITY;for(b=d;b<a;b++)g[b][d]>f&&(e=b,f=g[b][d]);f=g;h=e;l=f[d];f[d]=f[h];f[h]=l;0===g[e][b]&&console.log("matrix is singular!");for(b=d+1;b<a;b++){for(e=d+1;e<a+1;e++)g[b][e]-=g[b][d]/g[d][d]*g[d][e];g[b][d]=0}}for(b=a-1;0<=b;b--)for(d=g[b][a]/g[b][b],c[b]=d,e=b-1;0<=e;e--)g[e][a]-=g[e][b]*d,g[e][b]=0}
function hc(a,b,c,d){for(var e=1;b[e]<a;)e++;a=(a-b[e-1])/(b[e]-b[e-1]);return(1-a)*c[e-1]+a*c[e]+a*(1-a)*((d[e-1]*(b[e]-b[e-1])-(c[e]-c[e-1]))*(1-a)+(-d[e]*(b[e]-b[e-1])+(c[e]-c[e-1]))*a)};function ic(a,b){this.Ba(a,b)}m=ic.prototype;
m.Ba=function(a,b){z.call(this);this.Sd=!0;this.id=a;this.canvas=Da(document.body);this.canvas.style.position="absolute";this.canvas.style.border="none";this.ga=this.canvas.getContext("2d");this.Sb=b;this.width=32;this.height=500;this.canvas.width=this.width;this.canvas.height=this.height;var c=this;n(this.canvas).bind("click",function(a){c.jb(a)});n(this.canvas).bind("mousedown",function(a){c.Ya(a)});n(document.body).bind("mousemove",function(a){c.Za(a)});n(document.body).bind("mouseup",function(a){c.fb(a)});
n(this.canvas).bind("touchstart",function(a){c.$a(a)});n(document.body).bind("touchmove",function(a){c.$a(a)});n(document.body).bind("touchend",function(a){c.$a(a)});this.Xa=null;this.Na=!1;this.ig="#c0c0c0";this.of="#808080";this.borderWidth=1;this.Rb=0;this.Qb=100;this.he=10;this.position=5;this.format()};m.log=r("SCROLLBAR",!0);m.moveTo=function(a,b){this.canvas.style.left=""+a+"px";this.canvas.style.top=""+b+"px"};
function jc(a,b,c){a.width=b;a.height=c;a.canvas.width=a.width;a.canvas.height=c;a.format();a.la()}m.Ga=function(){this.canvas.style.display="none"};m.show=function(){this.canvas.style.display="block"};
m.format=function(){var a;a=this.Sb?this.width:this.height;var b=this.he/this.Qb*a;a*=(this.position-this.Rb)/this.Qb;this.Xa=this.Sb?new G(a,0,b-1,this.height-1):new G(0,a,this.width-1,b-1);this.Xa.x=Math.round(this.Xa.x)+.5;this.Xa.y=Math.round(this.Xa.y)+.5;this.Xa.width=Math.round(this.Xa.width);this.Xa.height=Math.round(this.Xa.height)};
m.la=function(){this.ga.beginPath();this.ga.fillStyle=this.ig;this.ga.strokeStyle=this.of;this.ga.lineWidth=this.borderWidth;this.ga.rect(this.borderWidth/2,this.borderWidth/2,this.width-this.borderWidth,this.height-this.borderWidth);this.ga.fill();this.ga.stroke();this.ga.beginPath();this.ga.fillStyle=this.of;this.ga.strokeStyle="#000000";this.ga.rect(this.Xa.x,this.Xa.y,this.Xa.width,this.Xa.height);this.ga.fill();this.ga.stroke()};
function kc(a,b){var c=n(a.canvas).offset();if("touchstart"===b.type||"touchend"===b.type||"touchmove"===b.type)b=b.changedTouches[0];return new u(b.pageX-c.left,b.pageY-c.top)}m.$a=function(a){switch(a.type){case "touchstart":this.Ya(a);break;case "touchend":this.fb(a);break;case "touchmove":this.Za(a)}};m.jb=function(){};function lc(a,b){var c;c=a.Sb?b.x/a.width*a.Qb+a.Rb:b.y/a.height*a.Qb+a.Rb;c=Math.min(c,a.Qb-a.he+a.Rb);return c=Math.max(c,a.Rb)}
m.Ya=function(a){a.preventDefault();a=kc(this,a);this.Xa.Lb(a.x,a.y)?this.Sb?(this.offset=a.x-this.Xa.x,a.x-=this.offset):(this.offset=a.y-this.Xa.y,a.y-=this.offset):(this.position=lc(this,a),this.offset=0,this.Sb?this.Xa.x=(this.position-this.Rb)/this.Qb*this.width:this.Xa.y=(this.position-this.Rb)/this.Qb*this.height,this.emit("scroll",this.position),this.la());this.Na=!0};
m.Za=function(a){this.Na&&(this.Na&&"mousemove"===a.type&&("buttons"in a&&0===a.buttons||0===a.which)?this.Na=!1:(a.preventDefault(),a=kc(this,a),this.Sb?a.x-=this.offset:a.y-=this.offset,this.position=lc(this,a),this.emit("scroll",this.position),this.format(),this.la()))};m.fb=function(){this.Na&&(this.Na=!1)};function oc(a){return a.Sb?a.height:a.width}ic.prototype=n.extend({},z.prototype,ic.prototype);function pc(a,b,c,d,e){this.view=a;this.handle=b;this.sh=c;this.view.Ie=this.handle instanceof qc;this.Cf=!1;this.Ya(d,e)}function rc(a){for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b}
pc.prototype={log:r("TransformSelectionBehaviour"),$a:function(a){var b;if(!this.Cf){for(b=0;b<a.touches.length;){b=a.touches[b];b=s(this.view,b.pageX,b.pageY);"touchmove"===a.type&&this.Za(b.x,b.y,a);break}for(b=0;b<a.changedTouches.length;){b=a.changedTouches[b];b=s(this.view,b.pageX,b.pageY);"touchend"===a.type&&this.fb(b.x,b.y,a);break}}},Oc:function(a){this.log("%s scale=%s rotation=%s",a.type,a.scale,a.rotation);this.Cf=!0;var b=this.Rc.x+this.Rc.width/2,c=this.Rc.y+this.Rc.height/2,d=a.scale;
this.view.ae||(d=1);b=(new Tb(d,d,b,c)).multiply(new Ub(-a.rotation/180*Math.PI,b,c));c=b.inverse();for(d=0;d<this.sa.length;d++)sc(this.sa[d],b.multiply(this.gd[d]),this.ed[d].multiply(c)),this.sa[d].format(this.view.ga,this.view.nb);this.view.$d=b;this.view.la();if("gestureend"===a.type){for(d=0;d<this.sa.length;d++)sc(this.sa[d],this.gd[d],this.ed[d]);this.view.qa([new K(rc(this.sa),b,b.inverse())]);tc(this)}},Ya:function(a,b){this.log("onMouseDown(%s,%s)",a,b);this.Tc=this.view.Wa(new u(a,b));
var c=this.sa=this.view.Mc();this.gd=[];this.ed=[];for(var d=0;d<c.length;d++)this.gd.push(L(c[d])),this.ed.push(uc(c[d]));this.Rc=new G(this.view.pb.x,this.view.pb.y,this.view.pb.width,this.view.pb.height);this.og=Pb(this.Rc).x;this.pg=Pb(this.Rc).y},Za:function(a,b){var c=this,d=this.view.Wa(new u(a,b));a=d.x;b=d.y;for(var d=this.handle.Jd(new u(d.x-this.Tc.x,d.y-this.Tc.y)),e=d.inverse(),f=0;f<this.sa.length;f++)sc(this.sa[f],d.multiply(this.gd[f]),this.ed[f].multiply(e)),this.sa[f].format(this.view.ga,
this.view.nb);this.view.$d=d;this.handle instanceof qc&&(this.view.$e=a,this.view.af=b);this.view.la(function(){if(c.handle instanceof qc){var d=c.view.ga;d.save();d.beginPath();d.strokeStyle="#0050B7";d.lineWidth=1/c.view.scale;d.moveTo(c.og,c.pg);d.lineTo(a,b);d.stroke();d.restore()}})},fb:function(a,b){this.log("onMouseUp(%s,%s)",a,b);var c=this.view.Wa(new u(a,b));a=c.x;b=c.y;if(Lb(c,this.Tc))this.sh?(c=this.view.ia.ib(a,b,this.view.Ka))&&c.Me()&&(this.log("Didn't move, and has edit mode. Selecting node %s",
c.id),M(this.view),this.view.Aa=c):this.log("Didn't move, but toggleEditNode=false");else{for(var c=this.handle.Jd(new u(c.x-this.Tc.x,c.y-this.Tc.y)),d=0;d<this.sa.length;d++)sc(this.sa[d],this.gd[d],this.ed[d]);this.view.qa([new K(rc(this.sa),c,c.inverse())])}tc(this)},ic:function(){this.log("onDoubleClick")}};function tc(a){var b=new H;a.view.$d=b;a.view.Ie=!0;vc(a.view);a.view.update(!0);N(a.view)};function wc(a){this.view=a;this.Fd=!1;this.uc=this.xa=null;this.multiline=a.ca.get("multilineText");this.hf="normal";a.ca.get("iPadNoScrollText")&&null!==navigator.userAgent.match(/iPad/i)&&(this.hf="top")}
wc.prototype={log:r("Text"),cc:function(){this.log("Entering text mode");this.view.canvas.style.cursor="text"},yc:function(){this.Fd&&xc(this);this.view.canvas.style.cursor="default";this.log("Leaving text mode");this.xa&&(this.xa.parentNode.removeChild(this.xa),this.xa=null)},$a:function(a){for(var b=0;b<a.touches.length;b++){var c=a.touches[b],c=s(this.view,c.pageX,c.pageY);"touchstart"===a.type&&this.Ya(c.x,c.y,a)}},Ya:function(a,b){if(this.Fd&&(this.log("Editing somewhere else on mousedown; submit that first."),
xc(this),this.view.ca.get("autoPickTool"))){N(this.view);return}var c=this.view.ia.ib(a,b,this.view.Ka);yc(this,c,a,b)},cancel:function(){this.xa&&(this.xa.parentNode.removeChild(this.xa),this.view.oa.emit("edit-text-hidden"));this.xa=null;this.Fd=!1;this.Aa&&(this.Aa.oe=!1,this.view.la())},Za:function(){},Gb:function(a){this.log("keyboard: %s",a);"cancel"===a&&null===this.xa&&(N(this.view),this.view.ha.emit("goto-toolbar"))},Ub:function(a){this.log("Set text colour to %s",a.Qa);this.view.setProperty("textFillStyle",
a.Qa)}};
function xc(a){var b=a.xa.value;a.cancel();if(a.Aa&&a.Aa.ma("text")===b)a.log("Text was not changed.");else if(null===a.Aa&&""===b)a.log("No text entered.");else if(a.Aa)a.log("Update text in node %s",a.Aa.id),a.view.qa([new zc([a.Aa.id],"text",b)]);else{a.log("Create new text node.");var c=a.view.ia.Ca,d=new I(a.uc.x,a.uc.y);a.view.qa([new O("TextNode",{text:b,fontSize:a.view.ya.fontSize,fontName:a.view.ya.fontName,textFillStyle:a.view.ya.textFillStyle,layer:a.view.Ka,wrap:a.view.ca.get("multilineText")}),new K([c],
d,d.inverse())])}}
function yc(a,b,c,d){function e(){a.xa&&(a.log("Set editBox height to %s",""+a.xa.scrollHeight+"px"),a.xa.style.height=""+a.xa.scrollHeight+"px",a.xa.style.width=""+a.xa.scrollWidth+"px");l=null}var f,g,h=0;b&&b.Ld()?(a.Aa=b,"top"!==a.hf&&"TextNode"===b.type()&&(a.Aa.oe=!0),a.view.la(),a.uc=new u(b.rect.x,b.rect.y),f=b.ma("fontName"),g=b.ma("fontSize"),h=b.tb().width*a.view.scale):(a.Aa=null,a.uc=new u(c,d),f=a.view.ya.fontName,g=a.view.ya.fontSize);a.xa=document.createElement("textarea");document.body.appendChild(a.xa);
b=n(a.xa).height();h&&(a.xa.style.width=""+h+"px");h=Ac(a.view,a.uc.x,a.uc.y);a.xa.style.position="absolute";a.xa.style.fontFamily=f;a.xa.style.fontSize=""+g*a.view.scale+"px";a.xa.style.overflow="auto";a.xa.style.zIndex=a.view.Nc()+1;"top"===a.hf?(f=n(a.view.canvas).offset(),g=n(a.view.canvas).width(),h=n(a.xa).width(),a.xa.style.left=""+(f.left+g/2-h/2)+"px",a.xa.style.top=""+f.top+"px"):(a.xa.style.left=""+Math.round(h.x)+"px",a.xa.style.top=""+Math.round(h.y)+"px");a.Fd=!0;a.uc=new u(c,d+b);a.Aa&&
(a.xa.value=a.Aa.ma("text"));var l=null,l=setTimeout(e,0);n(a.xa).bind("keydown",function(b){27===b.keyCode&&a.multiline||13===b.keyCode&&(b.shiftKey||!a.multiline)?(a.log("Enter pressed. create text."),xc(a),a.view.ua.eb&&Bc(a.view),a.view.ha.rf("goto-canvas"),a.view.ca.get("autoPickTool")&&N(a.view)):27===b.keyCode?(a.log("ESC pressed; cancel."),a.cancel(),N(a.view),a.view.ha.emit("goto-toolbar")):13===b.keyCode&&(l||(l=setTimeout(e,0)))});setTimeout(function(){a.xa&&a.xa.focus()},100);a.xa.focus();
a.view.oa.emit("edit-text-shown",a.xa)};function Cc(a,b,c,d,e,f){this.view=a;this.nodeType=b;this.ba=c;this.width=d;this.height=e;this.Zg=f;this.state="initial";this.ka=this.Tc=null}
Cc.prototype={log:r("DrawShape"),cc:function(){this.log("Entering DrawShapeBehaviour");this.view.canvas.style.cursor="crosshair"},yc:function(){this.log("Leaving DrawShapeBehaviour");this.ka&&(this.view.ia.removeNode(this.ka),this.view.update(),this.ka=null)},Gb:function(a){"cancel"===a&&N(this.view)},$a:function(a){var b;"touchstart"===a.type?(b=a.changedTouches[0],b=s(this.view,b.pageX,b.pageY),this.Ya(b.x,b.y)):"touchmove"===a.type?(b=a.changedTouches[0],b=s(this.view,b.pageX,b.pageY),this.Za(b.x,
b.y,a)):"touchend"===a.type&&(b=a.changedTouches[0],b=s(this.view,b.pageX,b.pageY),this.fb(b.x,b.y,a))},Ya:function(a,b){"initial"===this.state&&(this.start=new u(a,b),this.state="predraw",this.log("initial -> predraw"))},Za:function(a,b,c){a=new u(a,b);"predraw"===this.state&&10<this.start.Db(a)&&(this.create(),this.state="drawing",this.log("predraw -> drawing"));"drawing"===this.state&&(this.transform(this.start,a,c.ctrlKey),this.view.update())},fb:function(a,b,c){"predraw"===this.state?(this.create(),
this.transform(this.start,null,c.ctrlKey),this.qa(),N(this.view)):"drawing"===this.state&&(this.transform(this.start,new u(a,b),c.ctrlKey),this.qa(),N(this.view))},create:function(){this.ka=Dc(this.nodeType,this.view.ia.Ca++);Ec(this.ka,this.ba);Fc(this.view.ia,this.ka)},transform:function(a,b,c){var d,e;if(b)if("circle"===this.Zg)d=a,a=a.Db(b),e=2*a/this.width,a=2*a/this.height;else{e=[a,b];if(0===e.length)d=new u(0,0);else{d=e[0].x;for(var f=e[0].y,g=1;g<e.length;g++)d+=e[g].x,f+=e[g].y;d=new u(d/
e.length,f/e.length)}e=(b.x-a.x)/this.width;a=(b.y-a.y)/this.height}else d=a,a=e=1;c&&(a=e=Math.min(e,a));c=new I(d.x,d.y);c=c.multiply(new Tb(e,a));sc(this.ka,c,c.inverse());Gc(this.view.ia,this.ka.id)},qa:function(){this.ba.matrix=L(this.ka);this.ba.inverse=uc(this.ka);this.view.ia.removeNode(this.ka);this.ka=null;this.view.qa([new O(this.nodeType,this.ba)])}};function Hc(a,b,c,d){this.ka=a;this.Fb=b;this.Ye=c;this.origin=d;a=this.Fb.apply(c.x,c.y);this.x=a.x;this.y=a.y}Hc.prototype={Jd:function(a){var b=1,c=1,d=this.Fb.inverse(),e=d.apply(this.x+a.x,this.y+a.y);a=new u(this.Ye.x-this.origin.x,this.Ye.y-this.origin.y);e=new u(e.x-this.origin.x,e.y-this.origin.y);e=(e.x*a.x+e.y*a.y)/(a.x*a.x+a.y*a.y);0!==a.x&&0!==a.y?c=b=e:0!==a.x?b=e:c=e;return this.Fb.multiply(new Tb(b,c,this.origin.x,this.origin.y)).multiply(d)}};
function qc(a,b,c,d){this.ka=a;this.Fb=b;this.Ye=c;this.origin=this.Fb.apply(d.x,d.y);a=this.Fb.apply(c.x,c.y);this.x=a.x;this.y=a.y;this.nh=Math.atan2(this.y-this.origin.y,this.x-this.origin.x)}qc.prototype={Jd:function(a){return new Ub(-(Math.atan2(this.y+a.y-this.origin.y,this.x+a.x-this.origin.x)-this.nh),this.origin.x,this.origin.y)}};function Ic(a,b){this.ka=a;this.Fb=b;this.y=this.x=0}Ic.prototype={Jd:function(a){return new I(a.x,a.y)}};function Jc(){this.text="";this.font="10px Arial";this.uf="Arial";this.fontSize=10;this.ab=[];this.rect=new G(0,0,0,this.fontSize);this.lf="left";this.$c="top"}m=Jc.prototype;m.log=r("TextBox");function Kc(a,b,c){switch(b){case "left":case "centre":case "right":a.$c=b;break;case null:break;default:a.log("Unknnown alignment: %s",b)}switch(c){case "top":case "middle":case "bottom":a.lf=c;break;case null:break;default:a.log("Unknnown alignment: %s",c)}}
m.format=function(a,b,c){this.font=""+this.fontSize+"px "+this.uf;this.ab.length=0;var d,e;a.font=this.font;var f=0;this.rect.width=0;if(0===b){var g=this.text.split("\n");for(d=0;d<g.length;d++){var h=g[d];e=a.measureText(h).width;f+=this.fontSize;this.ab.push({x:0,y:f,width:e,text:h});this.rect.width=Math.max(this.rect.width,e)}}else{var h=g=0,l=!1;for(d=0;d<this.text.length;d++){var k=this.text.charAt(d);e=a.measureText(this.text.substr(g,d-g+1)).width;"\n"===k?l=!0:e>b?h?(d=h,l=!0):d>g&&(d-=1,
l=!0):" "===k&&(h=d);l&&(e=a.measureText(this.text.substr(g,d-g)).width,f+=this.fontSize,this.ab.push({x:0,y:f,width:e,text:this.text.substr(g,d-g+1)}),g=d+1,h=0,l=!1,this.rect.width=Math.max(this.rect.width,e))}e&&(f+=this.fontSize,this.ab.push({x:0,y:f,width:e,text:this.text.substr(g,d-g)}),this.rect.width=Math.max(this.rect.width,e))}this.rect.x=0;this.rect.y=0;this.rect.height=f;if("centre"===this.$c)for(d=0;d<this.ab.length;d++)a=this.ab[d],a.x=this.rect.width/2-a.width/2;else if("right"===this.$c)for(d=
0;d<this.ab.length;d++)a=this.ab[d],a.x=this.rect.width-a.width;b&&"centre"===this.$c?this.rect.x=b/2-this.rect.width/2:b&&"right"===this.$c&&(this.rect.x=b-this.rect.width);c&&"middle"===this.lf?this.rect.y=c/2-this.rect.height/2:c&&"bottom"===this.lf&&(this.rect.y=c-this.rect.height)};m.la=function(a,b,c){this.fillText(a,b,c)};
m.fillText=function(a,b,c){a.textBaseline="alphabetic";a.font=this.font;for(var d=0;d<this.ab.length;d++){var e=this.ab[d];a.fillText(e.text,this.rect.x+e.x+b,this.rect.y+e.y+c)}};m.strokeText=function(a,b,c){a.textBaseline="alphabetic";a.font=this.font;for(var d=0;d<this.ab.length;d++){var e=this.ab[d];a.strokeText(e.text,this.rect.x+e.x+b,this.rect.y+e.y+c)}};function P(a){Q(this,a,P)}var Lc={fillStyle:"#cccccc",strokeStyle:"#000000",lineWidth:2,shadow:!1};
P.prototype={Me:function(){return!1},Oe:function(){return null},Ge:function(){},Ld:function(){return"text"in this.ba},clone:function(a){a=new this.constructor(a());Ec(a,this.ba);return a},type:function(){return"BaseNode"},setProperty:function(a,b){if(a in this.ba||"tag"===a)this.ba[a]=b},ma:function(a){return this.ba[a]},tb:function(){return this.rect},wf:function(){return new J(this.rect)},Nc:function(){return this.ma("zIndex")||0},transform:function(a,b){this.ba.matrix=a.multiply(this.ba.matrix);
this.ba.inverse=this.ba.inverse.multiply(b)},format:function(){},ib:function(a,b){var c=uc(this).apply(a,b);return this.Xb.Lb(c.x,c.y)?this:null},hidden:function(){return this.oe},If:function(){},la:function(a){a.save();var b=this.ba.matrix;a.transform(b.m11,b.m21,b.m12,b.m22,b.va,b.wa);a.strokeStyle=this.ba.strokeStyle;a.fillStyle=this.ba.fillStyle;a.lineWidth=this.ba.lineWidth;this.ba.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");this.qc(a);a.restore()},
qc:function(){}};function sc(a,b,c){a.ba.matrix=b;a.ba.inverse=c}function uc(a){return a.ba.inverse}function L(a){return a.ba.matrix}function Mc(a){return null!==a.parent&&null!==a.parent.parent&&"PageNode"!==a.parent.type()}function Nc(a){return void 0!==a.children}function Oc(a){return(a=a.ma("layer"))?""+a:"default"}function Ec(a,b){for(var c in b)b.hasOwnProperty(c)&&a.setProperty(c,b[c])}function Pc(a,b){for(var c in b)b.hasOwnProperty(c)&&(a.ba[c]=b[c])}
function Q(a,b,c){a.id=b;a.ba={};Pc(a,Lc);a.rect=new G(0,0,1,1);a.ba.matrix=new H;a.ba.inverse=new H;a.ba.layer="default";a.parent=null;a.constructor=c;a.oe=!1;a.Xb=new G(0,0,1,1)}var Qc={};function Rc(a,b){b.prototype=n.extend({},P.prototype,b.prototype);Qc[a]=b}function Dc(a,b){return a in Qc?new Qc[a](b):null};function Sc(a){this.Ba(a)}m=Sc.prototype;m.Ba=function(a){Q(this,a,Sc);this.parent=null;this.children=[]};m.type=function(){return"GroupNode"};m.clone=function(a){for(var b=new Sc(a()),c=0;c<this.children.length;c++){var d=this.children[c].clone(a);d.parent=b;b.children.push(d)}return b};m.setProperty=function(a,b){for(var c=0;c<this.children.length;c++)this.children[c].setProperty(a,b)};
m.format=function(a,b){for(var c=0;c<this.children.length;c++)this.children[c].format(a,b),0===c?this.rect=this.children[c].rect.clone():Rb(this.rect,this.children[c].rect)};m.la=function(a){for(var b=0;b<this.children.length;b++)this.children[b].la(a)};m.ib=function(a,b){for(var c=this.children.length-1;0<=c;c--){var d=this.children[c].ib(a,b);if(d)return d}return null};function Tc(a,b){for(var c=0;c<a.children.length;c++)if(b===a.children[c])return c;return-1}F(P.prototype,Sc.prototype);
Rc("GroupNode",Sc);function Uc(a){Q(this,a,Uc);this.children=[]}Uc.prototype={log:r("PAGE",!0),type:function(){return"PageNode"},format:function(){},ib:function(){return null},la:function(){}};F(Sc.prototype,Uc.prototype);Rc("PageNode",Uc);function Vc(a){Q(this,a,Vc);this.log("New BrushNode created.");this.ba.points=[];this.ba.strokeStyle="#ff00ff";this.ba.lineWidth=10;this.ta=[];this.inverse=null}
Vc.prototype={log:r("BRUSH",!0),type:function(){return"BrushNode"},setProperty:function(a,b){"fillStyle"===a&&(a="strokeStyle");a in this.ba&&(this.ba[a]=b)},format:function(){var a,b,c,d;this.ta.length=0;b=this.ba.points;a=c=0;for(d=b.length-1;c<=d;a=c+=2)this.ta.push(new u(b[a],b[a+1]));a=Ob(this.ta);this.Xb=a.clone();a.dc(this.ba.lineWidth+3,this.ba.lineWidth+3);a=new J(a);a.transform(this.ba.matrix);this.rect=Ob(a.ta);this.inverse=this.ba.matrix.inverse()},ib:function(a,b){var c;if(this.rect.Lb(a,
b)){c=this.inverse.apply(a,b);var d;a:{d=this.ta;var e=c.x;c=c.y;for(var f=this.ba.lineWidth/2,f=f*f,g=1;g<d.length;g++){var h=d[g-1].x,l=d[g-1].y,k=d[g].x-h,p=d[g].y-l,q=((e-h)*k+(c-l)*p)/(k*k+p*p);1<q?q=1:0>q&&(q=0);h=h+q*k-e;l=l+q*p-c;if(h*h+l*l<=f){d=!0;break a}}d=!1}if(d)return this}return null},qc:function(a){var b,c,d,e;c=this.ba.points;if(0!==c.length){a.save();a.beginPath();a.lineCap="round";a.lineJoin="round";a.moveTo(c[0],c[1]);b=d=2;for(e=c.length-1;d<=e;b=d+=2)a.lineTo(c[b],c[b+1]);a.stroke();
if(Wc){a.beginPath();b=d=0;for(e=c.length-1;d<=e;b=d+=2)a.rect(c[b]-2,c[b+1]-2,4,4);a.fillStyle="#0000ff";a.fill()}a.restore()}}};var Wc=!1;Rc("BrushNode",Vc);function Xc(a,b,c,d,e){this.view=a;this.Of=b;this.Qa=c;this.lineWidth=d;this.mode=e;this.Na=!1;this.Ef=!0;this.Vb=[]}
Xc.prototype={log:r("Brush"),cc:function(){this.view.canvas.style.cursor="crosshair"},reset:function(){this.Na=!1;this.Vb=[]},$a:function(a){var b,c,d,e;if("touchstart"===a.type)for(e=a.changedTouches,c=0,d=e.length;c<d;c++)a=e[c],a=s(this.view,a.pageX,a.pageY),this.Vb.push([a]);else if("touchmove"===a.type){e=a.changedTouches;c=0;for(d=e.length;c<d;c++){a=e[c];b=a=s(this.view,a.pageX,a.pageY);for(var f=void 0,g=void 0,h=void 0,l=void 0,k=void 0,p=void 0,f=null,g=1E6,p=this.Vb,l=0,k=p.length;l<k;l++)if(h=
p[l],null===f||h[h.length-1].Db(b)<g)f=h,g=h[h.length-1].Db(b);b=f;a.x===b[b.length-1].x&&a.y===b[b.length-1].y||b.push(a)}this.view.la()}else"touchend"===a.type&&0===a.touches.length&&this.qa()},Ya:function(a,b){var c;c=this.view.Wa(new u(a,b));this.Na=!0;this.Vb.push([c])},Hf:function(a){var b,c,d,e,f,g,h;a.strokeStyle=this.Qa;a.lineCap="round";a.Eg="round";a.lineWidth=this.lineWidth;a.beginPath();g=this.Vb;d=0;for(f=g.length;d<f;d++)for(c=g[d],a.moveTo(c[0].x,c[0].y),b=e=1,h=c.length-1;e<=h;b=
e+=1)b=c[b],a.lineTo(b.x,b.y);a.stroke()},Za:function(a,b){var c;c=this.view.Wa(new u(a,b));this.Na&&(this.yb=this.Vb[0][this.Vb[0].length-1],c.x!==this.yb.x||c.y!==this.yb.y)&&(this.Vb[0].push(c),this.view.la())},fb:function(a,b){this.Za(a,b);this.Na=!1;this.qa()},qa:function(){var a,b,c,d,e,f,g,h,l,k;a=[];l=this.Vb;f=0;for(h=l.length;f<h;f++)if(e=l[f],"brush"===this.mode){if(c=[],1===e.length&&e.push(new u(e[0].x+.1,e[0].y+.1)),1<e.length){d=b=0;for(g=e.length-1;b<=g;d=b+=1)c.push(e[d].x),c.push(e[d].y);
a.push(new O("BrushNode",{points:c,strokeStyle:this.Qa,lineWidth:this.lineWidth,layer:this.view.Ka}))}}else{if("shapes"===this.mode){e=fc(e,20);c=e;g=k=b=e=k=d=void 0;if(!(3>c.length)){e=c[0];b=c[c.length-1];g=40>e.Db(b);for(d=0;d<c.length;d++){var p=c[d];for(k=d+1;k<c.length;k++){var q=c[k];20>Math.abs(p.x-q.x)?q.x=p.x:20>Math.abs(p.y-q.y)&&(q.y=p.y)}}p=Pb(Ob(c));for(d=0;d<c.length;d++)k=c[d],20>Math.abs(k.x-p.x)&&(k.x=p.x),20>Math.abs(k.y-p.y)&&(k.y=p.y);g&&(e.x=b.x,e.y=b.y)}e=c}else if("freehand"===
this.mode){c=e;c=fc(c,2);d=[];e=[];b=[];for(g=0;g<c.length;g++)d.push(g),e.push(c[g].x),b.push(c[g].y);k=[];p=[];gc(d,e,k);gc(d,b,p);q=[];for(g=0;g<c.length;g+=.25)q.push(new u(hc(g,d,e,k),hc(g,d,b,p)));e=c=q}if(1<e.length){c=new Yc;c.moveTo(e[0].x,e[0].y);b=Lb(e[0],e[e.length-1]);d=g=1;for(k=e.length-1;g<=k;d=g+=1)c.lineTo(e[d].x,e[d].y);b&&c.close();a.push(new O("PathNode",{commands:c.Jb(),strokeStyle:this.Qa,lineWidth:this.lineWidth,fillStyle:this.view.Ob,sloppiness:0,layer:this.view.Ka}))}}this.view.qa(a);
M(this.view);Zc(this.view);this.reset()},yc:function(){this.view.canvas.style.cursor="default";this.view.la()},Ub:function(a){1===a.button&&(this.Qa=this.view.Nb=a.Qa)},Gb:function(a){this.log("keyboard: %s",a);"cancel"===a&&(this.log("ESC pressed. Abort brush and go back to toolbar."),N(this.view),this.view.ha.emit("goto-toolbar"))}};function $c(a){Q(this,a,$c);this.ub=null}
$c.prototype={log:r("CUSTOM"),type:function(){return"CustomNode"},setProperty:function(a,b){var c;null===this.ub&&"type"===a&&(c=ad[b],this.ub=new c);this.ub&&this.ub.setProperty?this.ub.setProperty(a,b):P.prototype.setProperty.call(this,a,b)},ma:function(a){return this.ub&&this.ub.setProperty?this.ub.getProperty(a):P.prototype.ma.call(this,a)},format:function(a){"format"in this.ub?this.ub.format(a):alert("Error: custom item must have a format(ctx) function");a=this.ub.rect;this.rect=new G(a.x,a.y,
a.width,a.height)},la:function(a){this.ub.draw(a)}};Rc("CustomNode",$c);function bd(a){Q(this,a,bd);this.ba.data="";this.ba.locked=!1;this.element=null;this.Dd="";this.bb=null;this.$b=new H}
bd.prototype={log:r("DomNode",!0),type:function(){return"DomNode"},setProperty:function(a,b){if("data"===a)this.element&&(n(this.element).remove(),this.Dd=this.element=null);else if("border"===a||"lockSize"===a||"lockRotate"===a){this.ba[a]=b;return}P.prototype.setProperty.call(this,a,b)},Uf:function(a){this.log("Node %s receives DOM element and requests reformat",this.id);this.element=a;this.element.style.position="absolute";"IFRAME"!==a.tagName&&(this.element.style.pointerEvents="none");n(n(this.Je.canvas)[0].parentNode).append(this.element);
this.width=this.element.offsetWidth;this.height=this.element.offsetHeight;this.element.style.top="0px";this.element.style.left="0px";this.element.style.zIndex="-1";cd(this,"transformOrigin","top left");this.Je.emit("reformat",this)},format:function(a,b){null===this.element&&this.Dd!==this.ma("data")&&b&&(this.Dd=this.ma("data"),this.Je=b,this.log("DomNode %s requests conversion to DOM element",this.id),this.Je.emit("convert-dom-request",this.Dd,this.id));if(this.element){var c=this.$b,c=c.multiply(L(this));
1===c.m11&&1===c.m22&&0===c.m12&&0===c.m21?(cd(this,"transform",""),this.element.style.left=""+c.va+"px",this.element.style.top=""+c.wa+"px"):(this.element.style.left="0px",this.element.style.top="0px",cd(this,"transform","matrix("+c.m11+","+c.m21+","+c.m12+","+c.m22+","+c.va+","+c.wa+")"));this.rect.x=0;this.rect.y=0;this.rect.width=this.width;this.rect.height=this.height}else this.rect.x=0,this.rect.y=0,this.rect.width=100,this.rect.height=22;this.bb=new J(this.rect);this.Xb=this.rect.clone();this.rect.transform(L(this));
this.bb.transform(L(this));if(c=this.ba.border)this.rect.dc(c),this.Af=this.bb.clone(),this.Af.dc(c/2),this.bb.dc(c)},qc:function(a){!a.oc||a.oc.m11===this.$b.m11&&a.oc.m21===this.$b.m21&&a.oc.m12===this.$b.m12&&a.oc.m22===this.$b.m22&&a.oc.va===this.$b.va&&a.oc.wa===this.$b.wa||(this.log("Moving DOM element as result of draw zooming"),this.$b=a.oc,this.format(a,null));if(this.element){var b=this.ba.border;if(b){var c=this.Af;a.setTransform(1,0,0,1,0,0);a.beginPath();a.lineWidth=b;a.strokeStyle="#cccccc";
console.log(c);a.moveTo(c.ta[0].x,c.ta[0].y);a.lineTo(c.ta[1].x,c.ta[1].y);a.lineTo(c.ta[2].x,c.ta[2].y);a.lineTo(c.ta[3].x,c.ta[3].y);a.lineTo(c.ta[0].x,c.ta[0].y);a.closePath();a.stroke()}}else a.beginPath(),a.lineWidth=1,a.fillStyle="#888888",a.strokeStyle="#CCCCCC",a.rect(0,0,100,22),a.stroke(),a.font="20px Arial",a.textBaseline="top",a.fillText("DomNode",0,0)},ib:function(a,b){return!this.ba.locked&&this.rect.Lb(a,b)&&this.bb.Lb(a,b,3)?this:null},If:function(){this.element&&n(this.element).remove()}};
function cd(a,b,c){for(var d=b.charAt(0).toUpperCase()+b.substr(1),e=["ms","Webkit","O","Moz"],f=0;f<e.length;f++)a.element.style[e[f]+d]=c;a.element.style[b]=c}Rc("DomNode",bd);function dd(a){Q(this,a,dd);this.ba.url="";this.Ia=null;this.width=100;this.height=20;this.bb=new J;this.tc=[];this.Tb=new G(0,0,this.width,this.height);this.hb=new G(0,0,this.width,this.height)}
dd.prototype={log:r("IMAGE",!0),type:function(){return"ImageNode"},setProperty:function(a,b){this.ba[a]=b;"url"===a&&(this.Ia=null)},format:function(a,b){function c(a,b,c){k.tc.push({x:k.hb.x+a*k.hb.width,y:k.hb.y+b*k.hb.height,Sb:c})}var d,e,f,g,h,l=this;null===this.Ia&&"ImageSurface"in window?(this.Ia=new ImageSurface(this.ba.url),this.Tb=new G(0,0,this.Ia.width,this.Ia.height)):null===this.Ia?(this.Tb=new G(0,0,this.width,this.height),b.add(this,"image",this.ba.url,null,function(a){l.log("Got image response.");
l.Ia=a;return b.emit("reformat",l)})):this.Tb=new G(0,0,this.Ia.width,this.Ia.height);this.hb=ed(this);this.rect=this.hb.clone();if(d=this.ma("boundingPolygon")){f=[];e=g=0;for(h=d.length-1;g<=h;e=g+=2)f.push(new u(d[e],d[e+1]));this.bb=new J(f)}else this.bb=new J(this.rect);this.Xb=this.rect.clone();this.bb.transform(this.ba.matrix);this.rect.transform(this.ba.matrix);this.tc.length=0;var k=this;c(.5,0,!0);c(1,.5,!1);c(.5,1,!0);c(0,.5,!1)},wf:function(){return this.bb},ib:function(a,b){return!this.ba.locked&&
this.bb.Lb(a,b,3)?this:null},qc:function(a){var b,c,d,e,f=!1;if(this.Ia)try{if(a.drawImage(this.Ia,this.hb.x,this.hb.y,this.hb.width,this.hb.height,this.hb.x,this.hb.y,this.hb.width,this.hb.height),fd){c=this.bb.ta;a.save();a.setTransform(1,0,0,1,0,0);a.beginPath();a.lineWidth=2;a.strokeStyle="#000000";a.moveTo(c[0].x,c[0].y);b=d=1;for(e=c.length-1;d<=e;b=d+=1)a.lineTo(c[b].x,c[b].y);a.closePath();a.stroke();a.restore()}}catch(g){this.log("Error drawing image: %s",g.message),f=g}if(null===this.Ia||
f)a.save(),a.lineWidth=1,a.strokeStyle="#cccccc",a.strokeRect(0,0,this.width,this.height),a.restore()},Me:function(){return!0},Ge:function(a,b){a.save();a.lineWidth=1*b;a.strokeStyle="#0050B7";for(var c=L(this),d=0;d<this.tc.length;d++){var e=this.tc[d],f=c.apply(e.x,e.y),g,h,l,k;e.Sb?(g=20,l=h=0,k=3,e=f.x-10,f=f.y-6):(g=0,h=20,l=3,k=0,e=f.x-6,f=f.y-10);for(var p=0;5>p;p++)a.moveTo(e,f),a.lineTo(e+g*b,f+h*b),e+=l*b,f+=k*b}a.stroke();a.restore()},Oe:function(a,b,c){var d=L(this);c*=10;for(var e=0;e<
this.tc.length;e++){var f=this.tc[e],f=d.apply(f.x,f.y);if(f.x-c<=a&&a<f.x+c&&f.y-c<=b&&b<f.y+c)return e}return null},yf:function(a){a=this.tc[a];return L(this).apply(a.x,a.y)},kd:function(a,b,c){var d=ed(this);b=uc(this).apply(b,c);0===a&&0<=b.y?(d.height-=b.y-d.y,d.y=b.y):1===a&&b.x<this.Tb.width?d.width=b.x-d.x:2===a&&b.y<this.Tb.height?d.height=b.y-d.y:3===a&&0<=b.x&&(d.width-=b.x-d.x,d.x=b.x);d.x=Math.max(d.x,0);d.y=Math.max(d.y,0);d.width=Math.min(d.width,this.Tb.width);d.height=Math.min(d.height,
this.Tb.height);d.width=Math.max(1,d.width);d.height=Math.max(1,d.height);this.ba.crop=[d.x,d.y,d.width,d.height].join()}};function ed(a){var b=a.ba.crop;a=new G(0,0,a.Tb.width,a.Tb.height);b&&(b=b.split(","),a.x=parseFloat(b[0]),a.y=parseFloat(b[1]),a.width=parseFloat(b[2]),a.height=parseFloat(b[3]));return a}var fd=!1;Rc("ImageNode",dd);function gd(a){Q(this,a,gd);this.ba.mathml="";this.Ia=null;this.width=100;this.height=20;this.bb=new J;this.Hh=!1}
gd.prototype={log:r("MATHNODE",!0),type:function(){return"MathNode"},setProperty:function(a,b){this.ba[a]=b;"mathml"===a&&(this.Ia=null)},format:function(a,b){var c=this;null===this.Ia?(this.rect=new G(0,0,this.width,this.height),b.add(this,"math",this.ba.mathml,null,function(a){c.log("Got math response.");c.Ia=a;if(c.Ia)return b.emit("reformat",c)})):(this.Xg=this.Ia.width,this.Wg=this.Ia.height,this.rect=new G(0,0,this.Xg,this.Wg));this.bb=new J(this.rect);this.bb.transform(this.ba.matrix);this.rect.transform(this.ba.matrix)},
ib:function(a,b){return!this.ba.locked&&this.bb.Lb(a,b,3)?this:null},qc:function(a){if(null===this.Ia)a.save(),a.lineWidth=1,a.strokeStyle="#cccccc",a.strokeRect(0,0,this.width,this.height),a.restore();else try{a.drawImage(this.Ia,0,0)}catch(b){this.log("Error: %s",b)}}};Rc("MathNode",gd);function hd(a){Q(this,a,hd);this.ud="UnknownNode";this.width=100;this.height=20;this.Ta=new Jc;Kc(this.Ta,"centre","middle")}
hd.prototype={log:r("UNKNOWN",!0),type:function(){return this.ud},setProperty:function(a,b){this.ba[a]=b},format:function(a){this.log("Formatting placeholder for %s",this.ud);this.rect=new G(0,0,this.width,this.height);this.rect.transform(this.ba.matrix);this.Ta.format(a,this.width,this.height)},qc:function(a){this.log("Drawing placeholder for for %s",this.ud);a.save();a.lineWidth=1;a.fillStyle="#888888";a.fillRect(0,0,this.width,this.height);a.fillStyle="#000000";this.Ta.la(a,0,0);a.restore()}};
Rc("UnknownNode",hd);function id(a){Q(this,a,id);Pc(this,jd);this.ba.text="lorum ipsum dolor";this.Ta=new Jc}
id.prototype={log:r("TEXT",!0),type:function(){return"TextNode"},setProperty:function(a,b){this.ba[a]=b;if("fontName"===a||"text"===a)this.path=null;"textFillStyle"===a?this.ba.fillStyle=b:"fillStyle"===a&&(this.ba.textFillStyle=b)},format:function(a){var b,c=this.Ta;b=this.ba.fontSize;c.uf=this.ba.fontName;c.fontSize=b;this.Ta.text=this.ba.text;b=this.ba.matrix;c=b.apply(0,0);b=b.apply(1,0);c=c.Db(b);Kc(this.Ta,this.ba.textAlign,"top");!0===this.ma("wrap")?(b=this.ba.baseWidth,void 0===b&&(this.Ta.format(a,
0,0),b=Math.max(this.Ta.rect.width,10),this.ba.baseWidth=b,this.log("Formatting text for first time; baseWidth=%s",b)),c=Math.ceil(c*b),this.Ta.format(a,c,0),a=this.Ta.rect.height,this.Xb=new G(0,0,b,a)):(this.Ta.format(a,0,0),c=this.Ta.rect.width,a=this.Ta.rect.height,this.Xb=new G(0,-(0+this.ma("fontSize")),c,a));a=new J(new G(0,0,this.Ta.rect.x+this.Ta.rect.width,this.Ta.rect.y+this.Ta.rect.height));a.transform(L(this));this.rect=Ob(a.ta);a=this.ma("lineWidth")+0;this.rect.dc(a,a)},la:function(a){if(0!==
this.ba.text.length){a.save();if(this.ma("wrap")){var b;b=L(this);var c=b.m11,d=b.m21,e=b.m12,f=b.m22,g=Math.sqrt(c*c+d*d),h=Math.sqrt(e*e+f*f);b=new H(c/g,e/h,d/g,f/h,b.va,b.wa);Sb(b,a)}else Sb(L(this),a);a.strokeStyle=this.ba.strokeStyle;a.fillStyle=this.ba.fillStyle;a.lineWidth=this.ba.lineWidth;b=0;this.ba.wrap||(b=-(0+this.ma("fontSize")));this.ba.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");0<this.ba.lineWidth&&this.Ta.strokeText(a,0,b);this.Ta.fillText(a,
0,b);a.restore()}}};id.prototype=n.extend({},P.prototype,id.prototype);var jd={textFillStyle:"#000000",fontName:"Arial",fontSize:20,lineWidth:0,fillStyle:"#000000",wrap:!1,textAlign:"left"};Rc("TextNode",id);function kd(a){this.Ba(a)}var ld={strokeStyle:"#000000",fillStyle:"#ffffff",textFillStyle:"#000000",fontName:"Arial",fontSize:20,lineWidth:2,dashes:"",smoothness:.3,sloppiness:.5,shadow:!1,closed:!1,arrowSize:0,arrowStyle:"simple",doubleArrow:!1,text:"",roundRadius:0},md=[2,2,4,5,6,2,4,0];m=kd.prototype;m.Ba=function(a){Q(this,a,kd);Pc(this,ld);this.ba.closed=!1;this.ba.commands=[];this.ra=[];this.wd=0;this.ba.seed=0;this.Ab=new id(0);this.Ab.setProperty("text",this.ba.text)};m.log=r("PATHNODE");
m.moveTo=function(a,b){var c=this.ba.commands;c.push(0);c.push(a);c.push(b)};m.type=function(){return"PathNode"};m.Ld=function(){return!0===this.ba.closed};function nd(a,b){var c=a.ba.commands;a.ba.commands=b;return c}m.setProperty=function(a,b){P.prototype.setProperty.apply(this,arguments);"fontName"===a||"fontSize"===a||"text"===a?this.Ab.setProperty(a,b):"textFillStyle"===a&&this.Ab.setProperty("fillStyle",b)};
m.yf=function(a){for(var b=0,c=this.ba.commands,d=0;d<a;d++)b+=md[c[b]]+1;return L(this).apply(c[b+1],c[b+2])};m.kd=function(a,b,c){for(var d=0,e=this.ba.commands,f=0;f<a;f++)d+=md[e[d]]+1;f=this.ba.inverse.apply(b,c);e[d+1]=f.x;e[d+2]=f.y;if(0===a&&this.ba.closed){for(a=null;d<e.length;)f=md[e[d]],2<=f&&(a=d),d+=f+1;a&&(d=a,f=this.ba.inverse.apply(b,c),e[d+1]=f.x,e[d+2]=f.y)}};function od(a,b){for(var c=a.ba.commands,d=0,e=0;e<b;e++)d+=md[c[d]]+1;c.splice(d,md[c[d]]+1)}
m.format=function(a,b){this.origin=null;this.ra.length=0;for(var c=new u(0,0),d=this.ba.commands,e=null,f,g,h=this.ba.matrix,l=new Cb(this.ba.seed),k=0;k<d.length;){switch(d[k++]){case 0:c=h.apply(d[k++],d[k++]);this.ra.push(new db(e,c));null===this.origin&&(this.origin=c);break;case 1:c=h.apply(d[k++],d[k++]);this.ra.push(new eb(e,c,l,this.ba.sloppiness,this.ba.roundRadius));break;case 2:c=h.apply(d[k++],d[k++]);f=h.apply(d[k++],d[k++]);this.ra.push(new gb(e,f,c));break;case 3:c=h.apply(d[k++],d[k++]);
f=h.apply(d[k++],d[k++]);g=d[k++];this.ra.push(new hb(e,f,c,g));break;case 4:c=h.apply(d[k++],d[k++]);f=h.apply(d[k++],d[k++]);g=h.apply(d[k++],d[k++]);this.ra.push(new ib(e,f,g,c));break;case 5:c=h.apply(d[k++],d[k++]);this.ra.push(new fb(e,c,this.ba.smoothness));break;case 6:c=h.apply(d[k++],d[k++]);f=h.apply(d[k++],d[k++]);this.ra.push(new jb(e,f,c,l,this.ba.sloppiness));break;case 7:this.ba.closed=!0;break;default:k++}e=this.ra[this.ra.length-1]}this.ba.closed&&4<=this.ra.length&&this.ra[1].de&&
(this.ra[1].de(e),e.ea=this.origin);this.wd=this.ra.length;pd(this,l);this.rect.x=this.origin.x;this.rect.y=this.origin.y;this.rect.width=0;this.rect.height=0;c=this.ba.dashes.split(",");this.Cd=[];for(k=0;k<c.length;k++)d=parseFloat(c[k]),isNaN(d)||this.Cd.push(d);k=this.Cd.length?2:16;c=new $b;for(d=0;d<this.ra.length;d++)this.ra[d].la(c);f=l=d=0;for(e=new $b;d<c.da.length;){switch(c.da[d]){case 0:l=c.da[d+1];f=c.da[d+2];e.moveTo(l,f);break;case 1:l=c.da[d+1];f=c.da[d+2];e.lineTo(l,f);break;case 2:g=
h=[];var p=c.da[d+5],q=c.da[d+6];l!==p&&f!==q&&Wb(g,l,f,c.da[d+1],c.da[d+2],c.da[d+3],c.da[d+4],p,q,k*k);g.push(new u(p,q));for(l=0;l<h.length;l++)e.lineTo(h[l].x,h[l].y);l=c.da[d+5];f=c.da[d+6];break;case 3:g=h=[];p=c.da[d+3];q=c.da[d+4];l!==p&&f!==q&&Yb(g,l,f,c.da[d+1],c.da[d+2],p,q,k*k);g.push(new u(p,q));for(l=0;l<h.length;l++)e.lineTo(h[l].x,h[l].y);l=c.da[d+3];f=c.da[d+4];break;case 4:e.close()}d+=ac[c.da[d]]}this.ld=e;this.rect=dc(this.ld,k);k=this.ld.clone();k.transform(uc(this));this.Xb=
dc(k,3);k=this.ba.lineWidth;this.rect.dc(2*k+1,2*k+1);8>this.rect.width&&(this.rect.x+=this.rect.width/2-4,this.rect.width=8);8>this.rect.height&&(this.rect.y+=this.rect.height/2-4,this.rect.height=8);this.ba.closed&&(c=Pb(this.rect),this.Ab.format(a,b),k=c.x-this.Ab.rect.x-this.Ab.rect.width/2,c=c.y-this.Ab.rect.y-this.Ab.rect.height/2,this.Ab.transform(new I(k,c),new I(-k,-c)),this.Ab.format(a,b))};
function pd(a,b){function c(a,c){var g,p,q,t;g=a.x-c.x*e;p=a.y-c.y*e;q=g+c.y*e/2;t=p-c.x*e/2;g+=-c.y*e/2;p+=c.x*e/2;d.ra.push(new db(d.ra[d.ra.length-1],new u(g,p)));d.ra.push(new fb(d.ra[d.ra.length-1],a,f));d.ra.push(new fb(d.ra[d.ra.length-1],new u(q,t),f));"solid"===d.ba.arrowStyle&&d.ra.push(new eb(d.ra[d.ra.length-1],new u(g,p),b,d.ba.smoothness,0))}a.Bg=0<a.ba.arrowSize&&!a.ba.closed&&0<a.ra.length;if(a.Bg){var d=a,e=a.ba.arrowSize,f=a.ba.smoothness,g=a.ra[a.ra.length-1];c(g.ea,g.bc());a.ba.doubleArrow&&
c(a.ra[0].ea,Nb(a.ra[1].Uc()))}}m.close=function(){this.ba.commands.push(7)};
m.qc=function(a){var b=this.ba.inverse;a.save();a.lineJoin="round";a.transform(b.m11,b.m21,b.m12,b.m22,b.va,b.wa);a.beginPath();a.lineCap="round";a.Eg="round";for(b=0;b<this.ra.length;b++)this.ra[b].la(a);this.ba.closed&&(a.closePath(),a.fill(),a.shadowColor="rgba(0,0,0,0.0)");this.Cd.length&&0<this.ba.lineWidth&&(a.beginPath(),cc(this.ld,a,this.Cd),a.lineCap="butt");0<this.ba.lineWidth&&a.stroke();if(this.ba.arrowSize&&"solid"===this.ba.arrowStyle){a.beginPath();for(b=this.wd;b<this.ra.length;b++)this.ra[b].la(a);
a.fillStyle=this.ba.strokeStyle;a.fill()}this.ba.closed&&this.Ab.la(a);a.restore()};
m.ib=function(a,b){if(a>=this.rect.x-8&&a<this.rect.x+8+this.rect.width&&b>=this.rect.y-8&&b<this.rect.y+8+this.rect.height)if(this.ba.closed){for(var c=this.ld,d=0,e,f=[];d<c.da.length;){var g=bc[c.da[d]];for(e=0;e<g;e++)f.push(new u(c.da[d+1+2*e],c.da[d+1+2*e+1]));d+=ac[c.da[d]]}if(Zb(f,a,b))return this}else{a:{for(var c=this.ld,h=0,d=g=0,l,k,p;d<c.da.length;){switch(c.da[d]){case 0:h=c.da[d+1];g=c.da[d+2];break;case 1:e=c.da[d+1];f=c.da[d+2];k=e-h;l=f-g;p=k*k+l*l;p=((a-h)*k+(b-g)*l)/p;1<p?p=1:
0>p&&(p=0);h+=p*k;l=g+p*l;g=h-a;l-=b;g=g*g+l*l;if(8>=g){c=!0;break a}h=e;g=f}d+=ac[c.da[d]]}c=!1}if(c)return this}return null};m.lineTo=function(a,b){var c=this.ba.commands;c.push(1);c.push(a);c.push(b)};m.Ae=function(a,b){var c=this.ba.commands;c.push(5);c.push(a);c.push(b)};m.Me=function(){return!1!==this.ba.editable};
m.Oe=function(a,b,c){c*=8;if(a>=this.origin.x-c&&a<this.origin.x+c&&b>=this.origin.y-c&&b<this.origin.y+c)return 0;for(var d=0;d<this.wd;d++)if(a>=this.ra[d].ea.x-c&&a<this.ra[d].ea.x+c&&b>=this.ra[d].ea.y-c&&b<this.ra[d].ea.y+c)return d;return null};m.Ge=function(a,b){a.save();a.lineWidth=1*b;a.strokeStyle="#0050B7";var c=4*b;a.strokeRect(this.origin.x-c,this.origin.y-c,2*c,2*c);for(var d=1;d<this.wd;d++)a.strokeRect(this.ra[d].ea.x-c,this.ra[d].ea.y-c,2*c,2*c);a.restore()};F(P.prototype,kd.prototype);
function Yc(a){this.Ba(a)}
Yc.prototype={Ba:function(a){this.da=void 0===a?[]:a},xe:function(a,b,c){for(var d=0,e=0;e<a;e++)d+=md[this.da[d]]+1;this.da[d+1]=b;this.da[d+2]=c},moveTo:function(a,b){this.da.push(0);this.da.push(a);this.da.push(b)},lineTo:function(a,b){this.da.push(1);this.da.push(a);this.da.push(b)},Ae:function(a,b){this.da.push(5);this.da.push(a);this.da.push(b)},arcTo:function(a,b,c,d,e){this.da.push(3);this.da.push(c);this.da.push(d);this.da.push(a);this.da.push(b);this.da.push(e)},close:function(){this.da.push(7)},
Jb:function(){return this.da}};function R(a,b,c,d,e){a.da.push(6);a.da.push(d);a.da.push(e);a.da.push(b);a.da.push(c)}Rc("PathNode",kd);function qd(a,b,c,d){this.view=a;this.ka=null;this.type=b;this.url=c||"";this.ba=d||{}}
qd.prototype={cc:function(){this.view.canvas.style.cursor="crosshair";rd(this.view,"click-to-place-first-point-of-line");this.view.la();this.Ve=this.view.ia.Ca;this.tf=new u(0,0);this.fd=new u(0,0);this.ka=null},log:r("DRAWLINES"),reset:function(){this.cc()},$a:function(a){"touchstart"===a.type?(a=a.changedTouches[0],a=s(this.view,a.pageX,a.pageY),10<a.Db(this.fd)?this.jb(a.x,a.y):(this.jb(a.x,a.y),this.jb(a.x,a.y),this.ic(a.x,a.y))):"touchmove"===a.type&&(a=a.changedTouches[0],a=s(this.view,a.pageX,
a.pageY),this.Za(a.x,a.y))},Gb:function(a){"cancel"===a&&(null!==this.ka&&this.view.Cg&&"curves"===this.type&&this.qa(),null!==this.ka&&(this.view.ia.removeNode(this.ka),xb(this.view.ia,this.Ve)),this.view.ua.eb?this.view.ha.emit("goto-toolbar"):N(this.view))},jb:function(a,b){var c=this.view.Wa(new u(a,b));a=c.x;b=c.y;if("stampline"===this.type&&null===this.ka)this.ka=Dc("StampLineNode",this.view.ia.Ca++),this.ka.setProperty("x1",a),this.ka.setProperty("y1",b),this.ka.setProperty("x2",a),this.ka.setProperty("y2",
b),this.ka.setProperty("url",this.url),Fc(this.view.ia,this.ka),rd(this.view,"click-to-set-the-end-of-the-line"),this.view.update(),this.index=1;else if("stampline"===this.type&&this.ka)this.view.ia.removeNode(this.ka),xb(this.view.ia,this.Ve),this.view.qa([new O("StampLineNode",{x1:this.ka.ma("x1"),y1:this.ka.ma("y1"),x2:this.ka.ma("x2"),y2:this.ka.ma("y2"),url:this.url,layer:this.view.Ka})]),this.reset();else if(null===this.ka){this.ka=new kd(this.view.ia.Ca++);this.ka.setProperty("seed",Math.round(65535*
Math.random()));this.ka.setProperty("strokeStyle",this.view.Pb);this.ka.setProperty("lineWidth",this.view.ya.lineWidth);this.ka.setProperty("sloppiness",this.view.ya.sloppiness);this.ka.setProperty("smoothness",this.view.ya.smoothness);for(var d in this.ba)this.ba.hasOwnProperty(d)&&this.ka.setProperty(d,this.ba[d]);Fc(this.view.ia,this.ka);"arrow"===this.type&&this.ka.setProperty("arrowSize",15);this.ka.moveTo(a,b);sd(this,a,b);this.index=1;rd(this.view,"click-to-place-another-point-or-double-click-to-end-the-line");
this.view.update();this.tf=new u(a,b)}else!this.view.ua.eb||"lines"!==this.type&&"arrow"!==this.type?"arrow"!==this.type&&8>this.tf.Db(new u(a,b))?(this.log("Clicked close to start; automatically closing path"),this.ka.close(),this.qa(),N(this.view)):(sd(this,a,b),this.index+=1,Gc(this.view.ia,this.ka.id),this.view.update()):(this.qa(),N(this.view),this.view.ha.emit("goto-toolbar"));this.fd.x=a;this.fd.y=b},Za:function(a,b){var c=this.view.Wa(new u(a,b));a=c.x;b=c.y;this.ka&&(this.ka.kd(this.index,
a,b),this.ka.format(this.view.ga,this.view.nb),this.view.la(),this.fd.x=a,this.fd.y=b)},ic:function(a,b){this.view.Wa(new u(a,b));if(this.ka&&1<this.index){var c=this.index;od(this.ka,c);od(this.ka,c-1);this.qa()}this.view.ca.get("autoPickTool")?N(this.view):this.reset()},qa:function(){var a=this.ka,b=a.ra[a.ra.length-1];8>=C(b.ea.x,b.ea.y,a.origin.x,a.origin.y)&&a.close();this.view.ia.removeNode(this.ka);xb(this.view.ia,this.Ve);var a={arrowSize:"arrow"===this.type?15:0,commands:this.ka.ma("commands"),
seed:this.ka.ma("seed"),fillStyle:this.view.Ob,strokeStyle:this.view.Pb,lineWidth:this.view.ya.lineWidth,sloppiness:this.view.ya.sloppiness,smoothness:this.view.ya.smoothness,layer:this.view.Ka},c;for(c in this.ba)this.ba.hasOwnProperty(c)&&(a[c]=this.ba[c]);this.view.qa([new O("PathNode",a)]);this.ka=null},yc:function(){this.view.canvas.style.cursor="default";rd(this.view,null);this.view.la()},Ub:function(a){var b;1===a.button?(this.view.Ob=a.Qa,this.view.Nb=a.Qa,b="fillStyle"):(this.view.Pb=a.Qa,
b="strokeStyle");this.view.setProperty(b,a.Qa)}};function sd(a,b,c){"curves"===a.type||"arrow"===a.type?a.ka.Ae(b,c):a.ka.lineTo(b,c)};function S(){}S.prototype={Zd:function(a){var b,c,d,e;this.id&&(this.id=a(this.id));if(this.za&&0<this.za.length){e=[];b=c=0;for(d=this.za.length-1;0<=d?c<=d:c>=d;b=0<=d?++c:--c)e.push(this.za[b]=a(this.za[b]));return e}},log:r("ACTION"),Zc:function(a,b){return wb(this,a,b)},toString:function(){return""+this.kb+"()"}};function wb(a,b,c){var d;d=a.za?a.za.concat():[];a.id&&d.push(a.id);return td(b,d,c)}function O(a,b,c,d){this.type=a;this.Td=c;this.index=d;this.ba=b}
O.prototype={kb:"CreateAction",Ra:function(a){var b=a.Ca++;this.ka=Dc(this.type,b);if(!this.ka)if(this.type in ad)this.ka=new $c(b),this.ka.setProperty("type",this.type);else{this.log("Bad node type: %s",this.type);var b=this.ka=Dc("UnknownNode",b),c=this.type;b.ud=c;b.Ta.text=c;b.log("Creating placeholder for node type %s",c)}Ec(this.ka,this.ba);void 0===this.Td&&(this.Td=a.vb[a.sb].id,this.index=-1);b=T(a,this.Td);U(a,b,this.ka,this.index);this.log("Add %s to parent %s index %s",this.ka.type(),
b.type(),this.index)},toString:function(){return""+this.kb+"("+this.type+", "+JSON.stringify(this.ba)+", parent="+this.Td+", index="+this.index+")"},Ua:function(a){a.removeNode(this.ka)},Zc:function(a,b){return b.add(a.Ca)}};O.prototype=n.extend({},S.prototype,O.prototype);function ud(a){this.za=a;this.gc=[]}
ud.prototype={kb:"DeleteAction",Ra:function(a){var b,c,d,e;this.gc.length=0;e=this.za;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),this.gc.push({ka:b,parent:b.parent,index:a.removeNode(b)})},Ua:function(a){var b,c,d,e;if(0!==this.gc.length)for(e=this.gc,c=0,d=e.length;c<d;c++)b=e[c],U(a,b.parent,b.ka,b.index)}};ud.prototype=n.extend({},S.prototype,ud.prototype);function zc(a,b,c){this.za=a;this.name=b;this.value=c;this.hc=[]}
zc.prototype={kb:"SetAction",Ra:function(a){var b,c,d,e;this.hc.length=0;e=this.za;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),this.hc.push(b.ma(this.name)),b.setProperty(this.name,this.value)},Ua:function(a){var b,c,d,e;if(0!==this.za.length)for(b=d=0,e=this.za.length-1;0<=e?d<=e:d>=e;b=0<=e?++d:--d)c=T(a,this.za[b]),c.setProperty(this.name,this.hc[b])}};zc.prototype=n.extend({},S.prototype,zc.prototype);function K(a,b,c){this.za=a;this.Fb=b;this.inverse=c}
K.prototype={kb:"TransformAction",Ra:function(a){var b,c,d,e;e=this.za;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),b.transform(this.Fb,this.inverse)},Ua:function(a){var b,c,d,e;e=this.za;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),b.transform(this.inverse,this.Fb)},Zd:function(a){var b,c,d;if(0!==this.za.length)for(b=c=0,d=this.za.length-1;0<=d?c<=d:c>=d;b=0<=d?++c:--c)this.za[b]=a(this.za[b])}};K.prototype=n.extend({},S.prototype,K.prototype);function vd(a,b){this.id=a;this.da=b}
vd.prototype={kb:"SetPathAction",Ra:function(a){this.Jg=nd(T(a,this.id),this.da)},Ua:function(a){nd(T(a,this.id),this.Jg)}};vd.prototype=n.extend({},S.prototype,vd.prototype);function Oa(a,b,c,d,e,f){this.id=a;this.handle=b;this.Kg=c;this.Lg=d;this.x=e;this.y=f}Oa.prototype={kb:"MoveEditHandleAction",Ra:function(a){return T(a,this.id).kd(this.handle,this.x,this.y)},Ua:function(a){return T(a,this.id).kd(this.handle,this.Kg,this.Lg)}};Oa.prototype=n.extend({},S.prototype,Oa.prototype);
function wd(a){this.za=a;this.gc=[]}
wd.prototype={kb:"GroupAction",Ra:function(a){var b,c,d,e;this.gc.length=0;e=this.za;c=0;for(d=e.length;c<d;c++)b=e[c],b=T(a,b),this.gc.push({ka:b,parent:b.parent,index:Tc(b.parent,b)});this.ka=a.Jc(this.za)},Ua:function(a){var b,c;if(0!==this.za.length){for(b=c=this.za.length-1;0<=c&&!(0>b);b=c+=-1)b=this.gc[b],U(a,b.parent,b.ka,b.index);a.removeNode(this.ka)}},Zc:function(a,b){return b.add(a.Ca)},toString:function(){return"GroupAction("+JSON.stringify(this.za)+")"}};
wd.prototype=n.extend({},S.prototype,wd.prototype);function xd(a){this.za=a;this.Kd=[]}
xd.prototype={kb:"UngroupAction",Ra:function(a){var b,c,d,e,f,g,h,l,k;d={};l=this.za;e=0;for(g=l.length;e<g;e++)if(b=l[e],b=T(a,b),Nc(b)&&!(b.id in d))for(d[b.id]=!0,c={ka:b,parent:b.parent,children:b.children.concat(),index:a.removeNode(b)},this.Kd.push(c),k=c.children,f=0,h=k.length;f<h;f++)b=k[f],U(a,c.parent,b,-1)},Ua:function(a){var b,c,d,e;if(0!==this.Kd.length){for(b=d=this.Kd.length-1;0<=d&&!(0>b);b=d+=-1)if(b=this.Kd[b],0!==b.children.length){for(c=e=b.children.length-1;0<=e&&!(0>c);c=e+=
-1)U(a,b.ka,b.children[c],-1);U(a,b.parent,b.ka,b.index)}a.Gd()}}};xd.prototype=n.extend({},S.prototype,xd.prototype);function yd(a,b,c){var d,e,f;if(Nc(a))for(f=a.children,d=0,e=f.length;d<e;d++)a=f[d],yd(a,b,c);else a.transform(b,c)}function zd(a,b){this.za=a;this.offset=b;this.sa=[]}
zd.prototype={kb:"DuplicateAction",Ra:function(a){var b,c,d,e,f,g,h;e=new I(this.offset,this.offset);c=e.inverse();this.sa.length=0;d=function(){return a.Ca++};h=this.za;f=0;for(g=h.length;f<g;f++)b=h[f],b=T(a,b).clone(d),yd(b,e,c),Fc(a,b),this.sa.push(b)},Ua:function(a){var b,c;if(0!==this.sa.length)for(b=c=this.sa.length-1;0<=c&&!(0>b);b=c+=-1)a.removeNode(this.sa[b])},Zc:function(a,b){var c,d,e;c=a.Ca;d=td(a,this.za).length;c=e=c;for(d-=1;e<=d;c=e+=1)b.add(c)}};
zd.prototype=n.extend({},S.prototype,zd.prototype);function Ad(a,b){this.za=a;this.type=b;this.sa=[];this.We=[]}
Ad.prototype={kb:"ChangeOrderAction",Ra:function(a){var b,c,d,e,f,g;this.We.length=0;this.sa.length=0;g=this.za;e=0;for(f=g.length;e<f;e++)switch(b=g[e],b=T(a,b),d=b.parent,c=a.removeNode(b),this.We.push(c),this.sa.push(b),this.type){case Bd:U(a,d,b,-1);break;case Cd:U(a,d,b,0);break;case Dd:0<c?U(a,d,b,c-1):U(a,d,b,c);break;case Ed:c<d.children.length?U(a,d,b,c+1):U(a,d,b,c)}},Ua:function(a){var b,c,d,e;if(0!==this.za.length)for(b=e=this.za.length-1;0<=e&&!(0>b);b=e+=-1)c=this.sa[b],d=c.parent,a.removeNode(c),
U(a,d,c,this.We[b])}};Ad.prototype=n.extend({},S.prototype,Ad.prototype);var Bd=0,Cd=1,Ed=2,Dd=3;function Fd(a){this.ba=a}Fd.prototype={kb:"SetDocumentProperties",Ra:function(a){var b;this.hc={};for(b in this.ba)this.ba.hasOwnProperty(b)&&(this.hc[b]=a.ma(b),a.setProperty(b,this.ba[b]))},Ua:function(a){for(var b in this.hc)this.hc.hasOwnProperty(b)&&a.setProperty(b,this.hc[b])}};Fd.prototype=n.extend({},S.prototype,Fd.prototype);function Gd(a){z.apply(this,arguments);this.Da=new vb;this.sa={};this.Pc=new yb;this.Gd=this.vf=!0;this.Ca=0;this.Se=[];this.root=new Sc(this.Ca++);this.sa[this.root.id]=this.root;this.Pf=this.Da.next;this.ba={};this.Ne=new yb;this.bg=new yb;this.vb=[];this.sb=0;a||(Hd(this,this.root),this.xb(this.dd(0)))}
Gd.prototype={log:r("DOC"),empty:function(){return 0===this.root.children.length},De:function(){return this.Pf!==this.Da.next},qa:function(a,b){this.Se.length=0;if(b){this.log("Performing actions without adding to undo stack");for(var c=0;c<a.length;c++)a[c].Ra(this)}else this.Da.qa(this,a);return this.Se},Ua:function(){this.Da.Ua(this)},Ra:function(){this.Da.Ra(this)},Ic:function(){return this.Da.Ic()},Hc:function(){return this.Da.Hc()},format:function(a,b){var c,d,e,f,g;d=this.vf?this.sa:this.Pc.keys;
e=[];for(c in d)d.hasOwnProperty(c)&&e.push(this.sa[c]);g=Id(this,e);d=0;for(f=g.length;d<f;d++)c=g[d],c.format(a,b);this.Pc.clear();this.vf=!1;return e.length},la:function(a){function b(b){Jd(f,function(c){f.Ne.contains(Oc(c))||c.Nc()===b&&(c.hidden()||c.la(a))})}var c,d,e,f=this;c=Bb(this.bg);c.sort();d=0;for(e=c.length;d<e;d++)b(c[d])},ib:function(a,b,c){var d;d=null;Jd(this,function(e){Oc(e)===c&&e.ib(a,b)&&(null===d||d.Nc()<=e.Nc())&&(d=e)});return d},ac:function(a,b){var c;c=function(d){var e,
f,g;if(d.children)for(a&&b(d),g=d.children,e=0,f=g.length;e<f;e++)d=g[e],c(d);else b(d)};c(this.root)},Jc:function(a){var b,c,d,e;b=new Sc(this.Ca++);Fc(this,b);d=0;for(e=a.length;d<e;d++)c=a[d],U(this,b,this.sa[c],-1);return b},removeNode:function(a,b){var c,d,e=this;void 0===b&&(b=!0);c=Tc(a.parent,a);0<=c&&(a.parent.children.splice(c,1),a.parent=null,b&&(d=function(b){var c,h,l;delete e.sa[b.id];a.If();e.Pc.remove(b.id);if(Nc(b))for(l=b.children,c=0,h=l.length;c<h;c++)b=l[c],d(b)},d(a)));"PageNode"===
a.type()&&(this.vb.splice(c,1),c===this.sb&&(this.log("Removed current page."),this.xb(Math.min(c,this.vb.length-1))));return c},tb:function(){var a,b,c,d;a=d=c=b=null;this.ac(!1,function(e){if(null===b||e.rect.x<b)b=e.rect.x;if(null===c||e.rect.right()>c)c=e.rect.right();if(null===d||e.rect.y<d)d=e.rect.y;if(null===a||e.rect.bottom()>a)a=e.rect.bottom()});return null===b?new G(0,0,10,10):new G(b,d,c-b,a-d)},ma:function(a){return this.ba[a]},setProperty:function(a,b){void 0===b?a in this.ba&&delete this.ba[a]:
this.ba[a]=b},od:function(a,b){this.log("showLayer(%s, %s)",a,b);b?this.Ne.remove(a):this.Ne.add(a)},dd:function(a){this.log("Adding page to document with index %s",a);if(a>this.vb.length)return this.log("Error: Can insert page with index %s",a),-1;var b=Dc("PageNode",this.Ca++);U(this,this.root,b,a);return a},xc:function(){return this.vb.length},xb:function(a){if(0<=a&&a<this.vb.length)return this.log("Set current page to %s/%s",a,this.vb.length),this.sb=a,!0;this.log("Tried to set page to non-existing %s",
a);return!1}};function Kd(a){var b=816,c=1056;"width"in a.ba&&(b=a.ba.width);"height"in a.ba&&(c=a.ba.height);return new Mb(b,c)}function Ld(a){if("width"in a.ba)return new G(0,0,a.ba.width,a.ba.height);a=a.tb();a.width+=a.x;a.height+=a.y;a.x=0;a.y=0;return a}function U(a,b,c,d){c.parent&&a.removeNode(c,!1);-1===d?b.children.push(c):b.children.splice(d,0,c);Hd(a,c);a.Gd=!0;"PageNode"===c.type()&&(-1===d?a.vb.push(c):a.vb.splice(d,0,c));c.parent=b}
function Md(a,b,c){var d,e,f,g,h,l,k,p,q,t;0===b.indexOf("zwibblerclip.")&&(b=b.substr(13));f=JSON.parse(b);b=[];h=a.Ca;q=0;for(t=f.length;q<t;q++)if(e=f[q],"GroupAction"===e.type)b.push(new wd(e.members)),c.push(h++);else if("CreateAction"===e.type){p=e.properties;l={};for(g in p)p.hasOwnProperty(g)&&(k=p[g],"[object Array]"===Object.prototype.toString.apply(k)&&"Matrix"===k[0]&&(k.splice(0,1),k=new H(k)),l[g]=k);b.push(new O(e.node,l));c.push(h++)}d=a.Ca;g=function(b){a.log("Remap %s -> %s",b,b+
d);return b+d};e=0;for(f=b.length;e<f;e++)c=b[e],c.Zd(g);return b}function Nd(a,b,c,d){var e,f,g,h;if(Nc(b)){e=[];h=b.children;f=0;for(g=h.length;f<g;f++)b=h[f],d=Nd(a,b,c,d),e.push(d-1);c.push({type:"GroupAction",members:e})}else{a=b.ba;g={};for(e in a)a.hasOwnProperty(e)&&(f=a[e],f instanceof H&&(f=["Matrix",f.m11,f.m12,f.m21,f.m22,f.va,f.wa]),g[e]=f);c.push({type:"CreateAction",node:b.type(),properties:g})}return d+1}
function Od(a,b){var c;c=0;a.Gd&&(a.Gd=!1,a.ac(!0,function(a){a.Kf=c++}));b.sort(function(a,b){return a.Kf-b.Kf})}function Jd(a,b){function c(a){if(a.children)for(var e=0;e<a.children.length;e++)c(a.children[e]);else"PageNode"!==a.type()&&b(a)}c(a.vb[a.sb])}function td(a,b,c){var d,e,f,g;void 0===c&&(c=new yb);e=function(a){var b,d,f,g;c.add(a.id);if(Nc(a)){f=a.children;g=[];b=0;for(d=f.length;b<d;b++)a=f[b],g.push(e(a));return g}};f=0;for(g=b.length;f<g;f++)d=b[f],e(a.sa[d]);return c}
function Id(a,b){var c,d,e,f,g;e=[];c={};f=0;for(g=b.length;f<g;f++){for(d=b[f];Mc(d);)d=d.parent;d.id in c||(c[d.id]=!0,e.push(d))}Od(a,e);return e}function Pd(a,b){var c=[];Jd(a,function(a){b.contains(a.tb())&&c.push(a)});return c}function Qd(a){a.Da=new vb}function T(a,b){var c;sb(b);return b in a.sa?(c=a.sa[b],a.Pc.add(b),c):null}function Fc(a,b){U(a,a.vb[a.sb],b,-1)}function Gc(a,b){sb(b);a.Pc.add(b)}
function Hd(a,b,c){var d,e,f,g;void 0===c&&(c=!0);rb("id"in b,"Must be a node");if(!(b.id in a.sa)&&(a.sa[b.id]=b,a.Se.push(b),Nc(b)))for(g=b.children,e=0,f=g.length;e<f;e++)d=g[e],Hd(a,d,c);c&&a.Pc.add(b.id);a.bg.add(b.Nc())}function xb(a,b){sb(b);a.Ca=b;a.log("nextId now %s",b)}n.extend({},z.prototype,Gd.prototype);var Rd=r("DOC");Gd.prototype.save=function(a){if("list"===a)return Sd(this);if("zwibbler3"===a)return a=Sd(this),"zwibbler3."+window.JSON.stringify(a);throw"Unknown save format: "+a;};function Td(a){if("{"===a.charAt(0))return Ud(a);if(0===a.indexOf("zwibbler3.")){var b=window.JSON.parse(a.substr(10));return Vd(b)}if(0===a.indexOf("zwibblerclip."))return b=new Gd(!1),a=Md(b,a,[]),b.qa(a),Qd(b),b;throw"Format detection failed.";}
function Ud(a){var b=r("IMPORT"),c=new Gd,d=c.Ca,e,f,g,h,l,k=[];l=function(a){var b=new H;b.m11=a.m11;b.m12=a.m12;b.m21=a.m21;b.m22=a.m22;b.va=a.dx;b.wa=a.dy;return b};g=function(a){var b=0;"arrowSize"in a&&(b=a.arrowSize,a=a.path);var c=l(a.matrix),b={strokeStyle:a.strokeStyle,fillStyle:a.fillStyle,lineWidth:a.lineWidth,smoothness:a.smoothness,sloppiness:a.sloppiness,shadow:a.shadow,arrowSize:b,seed:Math.round(65535*Math.random())};if("textNode"in a){var e=a.textNode;b.fontSize=e.fontSize;b.fontName=
e.fontName;b.text=e.text;b.textFillStyle="textFillStyle"in e?e.textFillStyle:e.fillStyle}"path"in a&&(a=a.path);var f=a.startX,g=a.startY,e=a.closed,h=new Yc;a=a.segments;f=c.apply(f,g);h.moveTo(f.x,f.y);for(f=0;f<a.length;f++){var p=a[f];switch(p.type){case 1:g=c.apply(p.x,p.y);h.lineTo(g.x,g.y);break;case 2:g=c.apply(p.x,p.y);h.Ae(g.x,g.y);break;case 3:g=c.apply(p.x1,p.y1);p=c.apply(p.x,p.y);R(h,g.x,g.y,p.x,p.y);break;default:throw"Unknown path segment type: "+p.type;}}e&&h.close();b.commands=h.Jb();
k.push(new O("PathNode",b));d+=1};e=function(a,b){for(var c=[],e=a.children,g=e.length-1;0<=g;g--){var h=d;try{f(e[g],b+1)}catch(l){continue}c.push(h)}0<b&&(d+=1,k.push(new wd(c)))};h=function(a){var b=l(a.matrix),b=b.multiply(new I(0,1.3*a.fontSize));a={fillStyle:a.fillStyle,lineWidth:0,text:a.text,fontName:a.fontName,fontSize:a.fontSize,matrix:b,inverse:b.inverse()};k.push(new O("TextNode",a));d+=1};f=function(a,b){switch(a.type){case "Node":e(a,b);break;case "PathNode":case "ArrowNode":g(a);break;
case "TextNode":h(a);break;default:throw"Unknown node type: "+a.type;}};var p;try{p=window.JSON.parse(a)}catch(q){a=a.replace(/\\\\/g,"\\").replace(/\\"/g,'"');try{p=window.JSON.parse(a)}catch(t){a=a.replace(",",",\n");try{p=eval("("+a+")")}catch(x){throw b("Couldn't parse file."),"Couldn't parse file.";}}}b("Successfully parsed!");f(p,0);c.qa(k);return c}
function Wd(a){function b(){for(var a=[],b=0;4>b;b++)a.push(Math.random());return a}function c(a){var e={},f;e.type="Node";f=L(a);e.matrix={m11:f.m11,m12:f.m12,m21:f.m21,m22:f.m22,dx:f.va,dy:f.wa};e.children=[];if(Nc(a))for(f=0;f<a.children.length;f++)e.children.push(c(a.children[f]));if("BaseNode"!==a.type()&&"GroupNode"!==a.type())if("TextNode"===a.type())e.type="TextNode",e.fillStyle=a.ma("textFillStyle"),e.fontName=a.ma("fontName"),e.fontSize=a.ma("fontSize"),e.text=a.ma("text");else if("PathNode"===
a.type()){f=e;0<a.ma("arrowSize")&&!a.ma("closed")&&(e.type="ArrowNode",e.arrowSize=a.ma("arrowSize"),f={},e.path=f);e.type="PathNode";""!==a.ma("text")&&(f={},f.fillStyle=a.ma("textFillStyle"),f.fontName=a.ma("fontName"),f.fontSize=a.ma("fontSize"),f.text=a.ma("text"),e.textNode=f);var g=a.ba.commands;if(3>g.length)throw"Tried to export empty path.";e.strokeStyle=a.ma("strokeStyle");e.fillStyle=a.ma("fillStyle");e.lineWidth=a.ma("lineWidth");e.smoothness=a.ma("smoothness");e.sloppiness=a.ma("sloppiness");
e.startX=g[1];e.startY=g[2];e.closed=a.ma("closed");e.segments=[];e.shadow=a.ma("shadow");e.seed=a.ma("seed");for(f=3;f<g.length;)1===g[f]?e.segments.push({type:1,x:g[f+1],y:g[f+2],r:b()}):5===g[f]?e.segments.push({type:2,x:g[f+1],y:g[f+2]}):6===g[f]&&e.segments.push({type:3,x:g[f+1],y:g[f+2],x1:g[f+3],y1:g[f+4],r:b()}),f+=md[g[f]]+1}else throw"Unknown node type: "+a.type();return e}return window.JSON.stringify(c(a))}
function Sd(a){function b(a,d){var e={id:d.id,type:d.type()};c.push(e);a&&(e.parent=a.id);var f=d.ba,p;for(p in f)f.hasOwnProperty(p)&&("matrix"===p?e[p]=f[p].Jb():"inverse"!==p&&(e[p]=f[p]));if(Nc(d))for(e=0;e<d.children.length;e++)b(d,d.children[e])}var c=[],d={type:"document"},e=!1,f;for(f in a.ba)a.ba.hasOwnProperty(f)&&(d[f]=a.ba[f],e=!0);e&&c.push(d);b(null,a.root);return c}
function Vd(a){function b(a,c){var d;if(void 0!==a){d={};for(var e in a)a.hasOwnProperty(e)&&"children"!==e&&"parent"!==e&&"id"!==e&&"type"!==e&&("matrix"===e?(d[e]=new H(a[e]),d.inverse=d.matrix.inverse()):d[e]=a[e]);e=h;0!==a.id&&f.push(new O(a.type,d,c,-1));g[a.id]=h;h+=1;if(void 0!==a.children)for(d=0;d<a.children.length;d++)b(a.children[d],e)}}var c,d,e;a=window.JSON.parse(window.JSON.stringify(a));var f=[],g={},h=0,l={},k=!1;for(c=0;c<a.length;c++)if(e=a[c],"document"===e.type)delete e.type,
f.push(new Fd(e));else{"PageNode"===e.type&&(k=!0);if("parent"in e){if(!(e.parent in l))throw"Error: child "+e.id+" references parent "+e.parent+" before it was defined.";d=l[e.parent];void 0!==d.children?d.children.push(e):d.children=[e]}"GroupNode"!==e.type&&"PageNode"!==e.type||void 0!==e.children||(e.children=[]);l[e.id]=e}k||(h+=1);b(l[0],h);Rd(JSON.stringify(g));for(c=0;c<f.length;c++)Rd(f[c].toString());a=new Gd(k);a.qa(f);Qd(a);return a};var Xd={base64:function(a){var b="",c,d,e,f,g,h=0,l={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,"+":62,"/":63,"=":64};for(a=a.replace(/[^A-Za-z0-9\-_\=\+\/]/g,"");h<a.length;)c=l[a.charAt(h++)],d=l[a.charAt(h++)],f=l[a.charAt(h++)],g=l[a.charAt(h++)],
c=c<<2|d>>4,d=(d&15)<<4|f>>2,e=(f&3)<<6|g,b+=String.fromCharCode(c),64!==f&&(b+=String.fromCharCode(d)),64!==g&&(b+=String.fromCharCode(e));return b}};function Yd(){this.items=[]}Yd.prototype={};function Zd(a,b,c){a.items.push({type:"menu",display:b,hd:c})}function $d(a){a.items.push({type:"separator"})}function V(a,b,c){a.items.push({type:"normal",display:b,event:c,rg:void 0})};function ae(a){for(var b=[],c=0;c<a;c++)b.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890"[Math.floor(63*Math.random())]);return b.join("")}"object"===typeof module&&(exports.Gh=ae);function be(a){a=a.replace(/\+/g," ");return window.decodeURIComponent?window.decodeURIComponent(a):unescape(a)}function ce(){var a,b=a=a||window.location.hash,c,d,e,f;a={};e=b.indexOf("#");0<=e&&(b=b.substr(e+1));e=b.indexOf("#");0<=e&&(b=b.substr(0,e));b=b.split("&");e=0;for(f=b.length;e<f;e++)c=b[e],d=c.split("="),c=be(d[0]),d=1<d.length?be(d[1]):"",c.length&&(a[c]=d);return a};var de,ee,fe;fe=document.getElementsByTagName("script");ee=fe[fe.length-1];de=void 0!==ee.getAttribute.length?ee.src:ee.getAttribute("src",-1);
function ge(a){var b,c;this.options={autoPickTool:!0,background:"clear",backgroundImage:null,colourPicker:"wheel",colourPalette:"#000000 #ffffff #000088 #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" "),debug:!1,defaultBrushColour:"#000000",defaultBrushWidth:10,defaultFillStyle:"#e0e0e0",defaultFont:"Arial",defaultFontSize:20,defaultLineWidth:2,defaultPaperSize:"none",defaultRoundRectRadius:10,defaultSmoothness:"smooth",defaultStrokeStyle:"#000000",
defaultText:"Lorum ipsum dolor",defaultTextFillStyle:"#000000",defaultZoom:1,fonts:["Arial","Times New Roman"],gridSpacing:20,imageFolder:"$SCRIPT",iPadNoScrollText:!0,keyBringToFront:"Home",keyCancel:"ESC",keyCopy:"Ctrl+C,\u2318+C",keyCurveTool:"C",keyCut:"Ctrl+X,\u2318+X",keyDelete:"Delete,Backspace",keyDown:"Down",keyDuplicate:"Ctrl+D",keyEnter:"Enter",keyGroup:"Ctrl+G",keyLeft:"Left",keyLineTool:"L",keyMoveDown:"PageDown",keyMoveUp:"PageUp",keyNext:"Down,Right",keyNextPage:"Shift+PageDown",keyPaste:"Ctrl+V,\u2318+V",
keyPrevious:"Left,Up",keyPreviousPage:"Shift+Pageup",keyRedo:"Ctrl+Shift+Z",keyRight:"Right",keySelectNone:"ESC",keySendToBack:"End",keyUndo:"Ctrl+Z",keyUngroup:"Ctrl+Shift+G",keyUp:"Up",keyZoomIn:"+,Shift+=",keyZoomNormal:"=",keyZoomOut:"-",keyZoomToPage:"F4",keyZoomToWidth:"Shift+F4",language:"en",multilineText:!1,nudge:10,pageView:!1,pageSelectorDiv:"",pasteOffset:10,readOnly:!1,scrollbars:!0,setFocus:!0,showArrowTool:!0,showBackgroundSelector:!1,showBrushTool:!0,showCircleTool:!0,showColourPanel:!0,
showCopyPaste:!0,showCurveTool:!0,showDebug:!1,showFontNameProperty:!0,showFontSizeProperty:!0,showHints:!0,showImageSelector:!1,showImageTool:!1,showKeyboardHelp:!0,showLineTool:!0,showMathTool:!1,showMenu:!1,showMoveToFrontBack:!1,showPageSelector:!1,showPickTool:!0,showPropertyPanel:!1,showRoundRectTool:!1,showShapeBrushTool:!1,showSloppinessProperty:!0,showSmoothnessProperty:!0,showSquareTool:!0,showTextTool:!0,showToolbar:!0,showUndoRedo:!0,sloppy:!1,snap:0,symmetry:0,textMode:"interactive",
useTouch:"auto"};for(c in a)a.hasOwnProperty(c)&&(c in this.options||alert("Zwibbler: Unknown option '"+c+"'"),this.options[c]=a[c]);a=ce();for(c in a)a.hasOwnProperty(c)&&this.set(c,a[c]);""===he()?(this.Ea=this.options.imageFolder.replace("$SCRIPT/",""),this.Ea=this.Ea.replace("$SCRIPT","")):this.Ea=this.options.imageFolder.replace("$SCRIPT",he());""!==this.Ea&&"/"!==this.Ea[this.Ea.length-1]&&(this.Ea+="/");"auto"===this.options.useTouch&&(c="ontouchstart"in window||"onmsgesturechange"in window,
this.log("Detected touch support: %s",c));for(b in this.options)this.options.hasOwnProperty(b)&&this.log("%s=%s",b,this.options[b])}
ge.prototype={log:r("CONFIG"),set:function(a,b,c){if(!(a in this.options))return this.log("Error: %s is not a configuration option.",a),!1;if("defaultZoom"===a){if("page"!==b&&"width"!==b&&!ub(b)&&(b=parseFloat(b),isNaN(b)))return this.log("Error: Config option %s must be a number or 'page' or 'width'",a),!1}else if("string"===typeof b)if("number"===typeof this.options[a]){if(b=parseFloat(b),isNaN(b))return this.log("Error: Config option %s expects a number",a),!1}else"boolean"===typeof this.options[a]&&
(b="1"===b||"true"===b||""===b);this.log("Set config %s=%s",a,b);this.options[a]=b;c||this.emit("update",a,b);return!0},hh:function(){return this.options.showBrushTool},Yf:function(){return this.options.showPropertyPanel},ih:function(){return this.options.showColourPanel},mc:function(){return this.options.showDebug},jh:function(){return this.options.showToolbar},get:function(a){return this.options[a]},nc:function(){return"auto"===this.options.useTouch?"ontouchstart"in window||"onmsgesturechange"in
window:this.options.useTouch}};function ie(a,b){for(var c in a.options)if(a.options.hasOwnProperty(c)&&0===c.indexOf("key")){for(var d="",e=0;e<c.length;e++)var f=c.charAt(e),d=f===f.toUpperCase()?d+("-"+f.toLowerCase()):d+f;b.map(a.options[c],d.substr(4))}}function je(a){a=a.get("pageSelectorDiv");return a instanceof HTMLElement?a:""!==a&&n(a).length?n(a)[0]:null}function he(){var a,b;b=de;a=b.lastIndexOf("/");return b=0<=a?b.substr(0,a+1):""}ge.prototype=n.extend({},z.prototype,ge.prototype);function ke(a,b,c,d){this.view=a;this.wa=this.va=0;this.Na=!1;this.Of=b;this.Ya(c,d)}
ke.prototype={log:r("SELECT"),$a:function(a){"touchmove"===a.type?(a=le(this.view,a.changedTouches[0]),this.Za(a.x,a.y)):"touchend"===a.type&&(a=le(this.view,a.changedTouches[0]),this.fb(a.x,a.y))},Ya:function(a,b){this.va=a;this.wa=b;this.Na=!0},Za:function(a,b){if(this.Na){var c=this.view.ga,d=this;this.view.la(function(){c.save();c.strokeStyle="#0050B7";c.lineWidth=2/d.view.scale;c.fillStyle="rgba(0, 80, 183, 0.2)";var e=new G(d.va+.5,d.wa+.5,a-d.va,b-d.wa);c.fillRect(e.x,e.y,e.width,e.height);
c.strokeRect(e.x,e.y,e.width,e.height);c.restore()})}},fb:function(a,b){this.Na=!1;M(this.view);for(var c=this.view,d=Pd(c.ia,new G(this.va,this.wa,a-this.va,b-this.wa)),e=0;e<d.length;e++)me(c,d[e]);Zc(this.view);this.view.la();this.view.na=this.Of}};function Pa(a){this.Ba(a)}
Pa.prototype={Ba:function(a){this.view=a;rd(this.view,"");this.nc=this.view.ca.nc();this.Qf=1;this.nc&&(this.Qf=2)},log:r("DefaultBehaviour"),cc:function(){this.log("Entering pick tool.");this.view.canvas.style.cursor="default"},yc:function(){this.log("Leaving pick tool.")},$a:function(a){for(var b,c=0;c<a.touches.length;c++)b=a.touches[c],b=s(this.view,b.pageX,b.pageY),"touchstart"===a.type?this.Ya(b.x,b.y,a):"touchend"===a.type&&this.fb(b.x,b.y)},Ya:function(a,b,c){this.log("onMouseDown");if(this.view.ca.get("readOnly"))this.log("readOnly mode: Ignoring click.");
else{var d;a:{var e=this.view;if(!e.Aa){d=e.mf/e.scale;for(var f=0;f<e.lc.length;f++){var g=e.lc[f];if(g.x-d<=a&&a<g.x+d&&g.y-d<=b&&b<g.y+d){d=g;break a}}}d=null}if(d)y(this.view,new pc(this.view,d,!1,a,b));else{if(e=this.view.selection.length){var e=this.view,g=ne(e),h=n(e.canvas).offset(),f=oc(e.qb);"changedTouches"in c?(d=c.changedTouches[0].pageX-h.left-g,g=c.changedTouches[0].pageY-h.top-g):(d=c.pageX-h.left-g,g=c.pageY-h.top-g);e=e.Dc&&d>e.canvas.width-e.Dc.width-f&&g<e.Dc.height}e&&this.view.ha.emit("menu.delete",
{});if(this.view.Aa&&(e=this.view.Aa,d=e.Oe(a,b,1/this.view.scale*this.Qf),null!==d)){y(this.view,new Na(this.view,e,d,a,b));return}if(e=this.view.ia.ib(a,b,this.view.Ka))this.log("layer=%s active=%s",Oc(e),this.view.Ka),this.view.ha.emit("node-clicked",e.id);e&&Oc(e)===this.view.Ka?(d=e===this.view.Aa,f=e.ob===this.view.ob,this.log("wasEditNode: %s, wasSelected: %s",d,f),f||(c.shiftKey||M(this.view),me(this.view,e),Zc(this.view)),y(this.view,new pc(this.view,new Ic(e,L(e)),!d&&f,a,b))):(c=this.view,
c.selection.length&&c.Sf.Lb(a,b)?y(this.view,new pc(this.view,new Ic(this.view.selection[0],L(this.view.selection[0])),!0,a,b)):(this.view.Aa=null,y(this.view,new ke(this.view,this,a,b))))}}},fb:function(){this.log("onMouseUp")},Gb:function(a,b){this.log("keyboard: %s",a);var c=!0;switch(a){case "bring-to-front":this.view.ha.emit("menu.bringToFront",{});break;case "send-to-back":this.view.ha.emit("menu.sendToBack",{});break;case "left":oe(this.view,-1,0)||(this.view.Ja=Math.min(this.view.Ja+16,0),
W(this.view),this.view.la());break;case "right":oe(this.view,1,0)||(this.view.Ja=Math.max(-(this.view.canvas.width*this.view.scale-this.view.canvas.width),this.view.Ja-16),W(this.view),this.view.la());break;case "up":oe(this.view,0,-1)||(this.view.Ha=Math.min(this.view.Ha+16,0),W(this.view),this.view.la());break;case "down":oe(this.view,0,1)||(this.view.Ha=Math.max(-(this.view.canvas.height*this.view.scale-this.view.canvas.height),this.view.Ha-16),W(this.view),this.view.la());break;case "select-none":M(this.view);
Zc(this.view);this.view.la();this.view.ua.eb&&this.view.ha.emit("goto-toolbar");break;case "duplicate":this.view.ha.emit("menu.duplicate",{});break;case "move-up":this.view.ha.emit("menu.moveUp",{});break;case "move-down":this.view.ha.emit("menu.moveDown",{});break;case "delete":this.view.ha.emit("menu.delete",{});break;case "curve-tool":pe(this.view);break;case "line-tool":qe(this.view);break;case "group":this.view.ha.emit("menu.group",{});break;case "ungroup":this.view.ha.emit("menu.ungroup",{});
break;case "undo":this.view.ha.emit("menu.undo",{});break;case "redo":this.view.ha.emit("menu.redo",{});break;case "cut":this.view.ha.emit("menu.cut",{});break;case "copy":this.view.ha.emit("menu.copy",{});break;case "paste":this.view.ha.emit("menu.paste",{});break;case "zoom-normal":var d=re(this.view);this.view.scale=1;this.view.Ja=-d.x;this.view.Ha=-d.y;W(this.view);this.view.la();break;case "zoom-in":this.view.ie();break;case "zoom-out":this.view.je();break;default:c=!1}c&&(b.preventDefault(),
b.stopPropagation())},Ub:function(a){var b;1===a.button?(this.view.Ob=a.Qa,this.view.Nb=a.Qa,b="fillStyle"):(this.view.Pb=a.Qa,b="strokeStyle");this.view.setProperty(b,a.Qa)},ic:function(a,b){this.log("onDoubleClick");var c=this.view.ia.ib(a,b,this.view.Ka);this.log("hittest: %s, hasText: %s",null!==c,null!==c&&c.Ld());c&&c.Ld()?(this.log("Text double-clicked."),se(this.view),yc(this.view.na,c,a,b)):c&&"MathNode"===c.type()&&this.view.ha.emit("math.edit",X(this.view)[0])}};function te(){return"localStorage"in window&&null!==window.localStorage}var ue={};for(var ve=[],we=0;4>we;we++)ve.push(String.fromCharCode(">2$-".charCodeAt(we)^"zwibbler3".charCodeAt(we%9)));for(var xe=[115,116,114,111,107,101,84,101,120,116],ye=[],ze=0;ze<xe.length;ze++)ye.push(String.fromCharCode(xe[ze]));
function Ae(a,b,c,d,e,f){this.ca=e;this.language=f;this.rb=c;this.ha=d;this.canvas=a[0];this.ga=this.canvas.getContext("2d");this.ee=!0===e.get("pageView");Be(this);this.ua={eb:!1,Na:!1,we:!1,x:100,y:100};this.na=null;y(this,new Pa(this));this.cb=null;this.Eb=new ic("horizontal",!0);this.canvas.parentNode.appendChild(this.Eb.canvas);this.qb=new ic("vertical",!1);this.canvas.parentNode.appendChild(this.qb.canvas);this.Yb="none";this.Vc=0;this.bf=this.ae=!0;this.lc=[];this.Ka="default";e.nc()&&(this.Dc=
document.createElement("img"),this.Dc.setAttribute("src",e.Ea+"wd-trash.png"));var g=this;this.nb=new pb;this.nb.canvas=this.canvas;this.nb.on("reformat",function(a){g.log("Node %s requests reformat",a.id);a.id in g.ia.sa&&(g.log("   Reformatting... zoom=%s",g.Yb),Gc(g.ia,a.id),g.update(),Ce(g),g.oa.emit("resource-loaded"))});this.nb.on("convert-dom-request",function(a,b){g.ha.emit("convert-dom-request",a,b)});this.Aa=this.se=null;this.pc=4;this.ca.nc()?(this.mf=4*this.pc,this.pc=9):this.mf=2*this.pc;
this.ha.bind("menu.undo",function(){g.Ua()});this.ha.bind("menu.redo",function(){g.Ra()});this.ha.bind("menu.copy",function(){g.Yc()});this.ha.bind("menu.cut",function(){g.Yc();De(g)});this.ha.bind("menu.paste",function(){g.Ud()});this.ha.bind("menu.duplicate",function(){g.duplicate()});this.ha.bind("menu.moveUp",function(){g.Qd()});this.ha.bind("menu.moveDown",function(){g.Pd()});this.ha.bind("menu.bringToFront",function(){g.xd()});this.ha.bind("menu.sendToBack",function(){g.be()});this.ha.bind("menu.group",
function(){g.group()});this.ha.bind("menu.ungroup",function(){g.rd()});this.ha.bind("menu.delete",function(){De(g)});this.ha.bind("menu.outline-none",function(){g.setProperty("lineWidth",0)});this.ha.bind("menu.outline-pencil",function(){g.setProperty("lineWidth",1)});this.ha.bind("menu.outline-pen",function(){g.setProperty("lineWidth",2)});this.ha.bind("menu.outline-marker",function(){g.setProperty("lineWidth",4)});this.ha.bind("menu.shadow-none",function(){g.setProperty("shadow",!1)});this.ha.bind("menu.shadow",
function(){g.setProperty("shadow",!0)});this.ha.bind("menu.font.FG Virgil",function(){g.setProperty("fontName","FG Virgil")});this.ha.bind("menu.font.Stinky Kitty",function(){g.setProperty("fontName","Stinky Kitty")});this.ha.bind("menu.font.Arial",function(){g.setProperty("fontName","Arial")});this.ha.bind("menu.font.Times New Roman",function(){g.setProperty("fontName","Times New Roman")});this.ha.bind("menu.sloppiness-draftsman",function(){g.setProperty("sloppiness",0)});this.ha.bind("menu.sloppiness-artist",
function(){g.setProperty("sloppiness",.25)});this.ha.bind("menu.sloppiness-Cartoonist",function(){g.setProperty("sloppiness",.5)});this.ha.bind("menu.sloppiness-child",function(){g.setProperty("sloppiness",1)});this.ha.bind("menu.sloppiness-drunk",function(){g.setProperty("sloppiness",2)});this.ha.bind("menu.insert.cylinder",function(){var a=g.ia.Ca,b=new Yc([]);b.moveTo(100,100);b.lineTo(200,100);b.lineTo(200,200);R(b,200,225,150,225);R(b,100,225,100,200);b.lineTo(100,100);b.close();var c=new Yc;
c.moveTo(100,100);R(c,100,75,150,75);R(c,200,75,200,100);R(c,200,125,150,125);R(c,100,125,100,100);c.close();g.qa([new O("PathNode",{commands:b.Jb(),layer:g.Ka}),new O("PathNode",{commands:c.Jb(),layer:g.Ka}),new wd([a,a+1])])});this.qb.on("scroll",function(a){g.Ha=-a*g.scale;g.la()});this.Eb.on("scroll",function(a){g.Ja=-a*g.scale;g.la()});Ee(this);this.Sc(b);(a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)?(this.log("Using requestAnimationFrame"),
this.requestAnimationFrame=a):this.log("Emulating requestAnimationFrame");this.He=!1;this.Fe=null;this.ca.on("update",function(a,b){g.Xe(a,b)});n(document).on("webkitfullscreenchange",function(){0<=navigator.userAgent.search("Safari")&&0>navigator.userAgent.search("Chrome")&&(g.log("SAFARI WORKAROUND: Disabling requestAnimationFrame."),g.requestAnimationFrame=Ae.prototype.requestAnimationFrame)})}
Ae.prototype={log:r("VIEW"),requestAnimationFrame:function(a){a()},cf:function(a){this.log("setActiveLayer(%s)",a);this.Ka=a;M(this);Zc(this);this.la()},od:function(a,b){this.ia.od(a,b);b||a!==this.Ka||(M(this),Zc(this));this.la()},Sc:function(a){this.ia=a;this.scale=1;this.Ha=this.Ja=0;this.selection=[];this.Aa=null;this.ob=1;this.pb=new G(0,0,0,0);this.Sf=new J(this.pb);this.$d=new H;this.Ie=!0;this.af=this.$e=0;this.bd=null;this.Ob="#ffffff";this.Nb=this.ca.options.defaultBrushColour;this.Pb=this.ca.options.defaultStrokeStyle;
this.ya={};this.ya.lineWidth=this.ca.options.defaultLineWidth;this.ya.sloppiness=.5;this.ya.fontName=this.ca.options.defaultFont;this.ya.fontSize=this.ca.options.defaultFontsize;this.ya.smoothness=.3;this.ya.textFillStyle=this.ca.options.defaultTextFillStyle;this.sc=this.ca.get("defaultBrushWidth");a=re(this);this.Ja=-a.x;this.Ha=-a.y;W(this);this.ia.format(this.ga,this.nb);"none"!==this.Yb?this.zoom(this.Yb):(this.zoom(this.ca.get("defaultZoom")),this.la())},Xe:function(a,b){var c=!1;switch(a){case "defaultBrushColour":this.Nb=
b;this.na&&this.na.Ef&&(this.na.Qa=b);break;case "defaultFillStyle":this.Ob=this.ya.fillStyle=b;break;case "defaultStrokeStyle":this.Pb=b;this.ya.strokeStyle=b;break;case "defaultLineWidth":this.ya.lineWidth=b;break;case "defaultFont":this.ya.fontName=b;break;case "defaultFontSize":this.ya.fontSize=b;break;case "defaultTextFillStyle":this.ya.textFillStyle=b;break;case "defaultBrushWidth":this.sc=b;this.na&&this.na.Ef&&(this.na.lineWidth=b);break;case "snap":case "background":Ee(this);c=!0;break;case "symmetry":c=
!0;break;case "readOnly":!0===b&&(N(this),M(this),Zc(this),c=!0)}c&&this.la()},ef:function(a){this.nb.ef(a)},zoom:function(a){var b,c=this.canvas.width-20;b="width"in this.ia.ba;this.Yb=a;b||this.log("WARNING: Cannot zoom to page/width because the document size has not been set.");if(ub(a))this.scale=a;else if("none"===a||this.ia.empty()||!b)this.scale=1,this.Ha=this.Ja=0;else if("page"===a){b=re(this);var d=c=0;this.scale=Math.min(this.canvas.width/b.width,this.canvas.height/b.height);this.scale*
b.width<this.canvas.width&&(c+=(this.canvas.width-this.scale*b.width)/2/this.scale);this.scale*b.height<this.canvas.height&&(d+=(this.canvas.height-this.scale*b.height)/2/this.scale);this.Ja=-(b.x-c)*this.scale;this.Ha=-(b.y-d)*this.scale;this.log("RECT=%s scale=%s tx=%s",b,this.scale,this.Ja);this.Yb=a}else"width"===a&&(b=re(this),this.scale=c/b.width,this.Ja=-b.x*this.scale,this.Ha=-b.y*this.scale,this.log("RECT=%s scale=%s tx=%s ty=%s",b,this.scale,this.Ja,this.Ha),this.Yb=a);W(this);this.la()},
Gb:function(a,b){var c;if(this.ua.eb){var d=0,e=0,f=this.ca.get("nudge");switch(a){case "right":d=f;break;case "left":d=-f;break;case "down":e=f;break;case "up":e=-f;break;case "enter":this.na.jb?(this.ua.Na=!1,c="click"):(this.ua.Na=!this.ua.Na,c=this.ua.Na?"mousedown":"mouseup")}if(d||e)this.ua.x+=d,this.ua.x=Math.max(this.ua.x,0),this.ua.x=Math.min(this.canvas.width,this.ua.x),this.ua.y+=e,this.ua.y=Math.max(this.ua.y,0),this.ua.y=Math.min(this.canvas.height,this.ua.y),this.la(),c="mousemove";
c?(b.preventDefault(),b.stopPropagation(),this.la(),e=n(this.canvas).offset(),d=this.ua.x+e.left,e=this.ua.y+e.top,this.log("Simulate a %s at (%s,%s)",c,d,e),f=document.createEvent("MouseEvents"),f.initMouseEvent(c,!0,!0,window,0,d,e,d,e,!1,!1,!1,!1,this.ua.Na?1:0,null),this.canvas.dispatchEvent(f),c=!0):c=!1}else c=!1;if(!c){this.na.Gb&&this.na.Gb(a,b);switch(a){case "next-page":this.xb(this.ia.sb+1);break;case "previous-page":this.xb(this.ia.sb-1);break;case "zoom-to-page":this.zoom("page");break;
case "zoom-to-width":this.zoom("width")}b.preventDefault();b.stopPropagation()}},Wb:function(a){this.ua.eb=!0;this.ua.Na=!1;this.ua.we=a;this.log("Showing keyboard cursor, caret=%s",a);this.la()},Cg:function(){return this.ua.eb},Wa:function(a){var b=this.ca.get("snap"),c;0<b?(c=Math.round(a.x/b)*b,a=Math.round(a.y/b)*b):(c=a.x,a=a.y);return new u(c,a)},Qd:function(){var a=X(this);a.length&&this.qa([new Ad(a,Ed)])},Pd:function(){var a=X(this);a.length&&this.qa([new Ad(a,Dd)])},xd:function(){var a=
X(this);a.length&&this.qa([new Ad(a,Bd)])},be:function(){var a=X(this);a.length&&this.qa([new Ad(a,Cd)])},setProperty:function(a,b){var c=X(this);this.ya[a]=b;c.length&&this.qa([new zc(c,a,b)]);0<this.selection.length&&"lineWidth"===a&&"BrushNode"===this.selection[0].type()?this.sc=b:"textFillStyle"===a&&(this.ya.textFillStyle=b)},group:function(){var a=X(this);a.length&&this.qa([new wd(a)])},rd:function(){var a=X(this);a.length&&this.qa([new xd(a)])},selectNodes:function(a){M(this);for(var b=0;b<
a.length;b++)a[b].ma("locked")||"PageNode"===a[b].type()||me(this,a[b]);Zc(this)},qa:function(a,b){if(this.ca.get("readOnly"))this.log("readOnly mode: Ignoring change.");else{var c=this.ia.qa(a,b);this.ia.format(this.ga,this.nb);if(c.length)this.selectNodes(c);else if(this.selection.length||this.Aa){c=0;this.ob+=1;for(var d=0;d<this.selection.length;d++)d!==c&&(this.selection[c]=this.selection[d]),this.selection[c].id in this.ia.sa&&(this.selection[c].ob=this.ob,c++);this.selection.length!==c&&(this.selection.length=
c);!this.Aa||this.Aa.id in this.ia.sa||(this.log("EditNode %s no longer exists",this.Aa.id),this.Aa=null);0!==this.selection.length||this.Aa?vc(this):M(this)}this.la();this.ha.emit("document-changed")}},Mc:function(){var a=this.selection.concat();this.Aa&&a.push(this.Aa);for(var b=0;b<a.length;b++)this.log("Selected node=%s",a[b].id);return a},Ke:function(a){tb(a)||(a=[a]);for(var b=null,c=0;c<a.length;c++){var d=T(this.ia,a[c]);d&&(null===b?b=d.tb().clone():Rb(b,d.tb()))}null===b&&(b=new G(0,0,0,
0));return b},update:function(a){if(this.ia.format(this.ga,this.nb)||a)vc(this),this.la()},df:function(a){a?(this.log("Setting a custom background function."),this.se=a):this.log("Clearing custom background function.")},la:function(a){this.Fe=a;if(!this.He){this.He=!0;var b=this;this.requestAnimationFrame.call(window,function(){b.He=!1;var a,d,e,f;a=(0-b.Ja)/b.scale;d=(0-b.Ha)/b.scale;e=(b.canvas.width-b.Ja)/b.scale;f=(b.canvas.height-b.Ha)/b.scale;b.ga.setTransform(1,0,0,1,0,0);b.ee?(b.ga.fillStyle=
"#808080",b.ga.fillRect(0,0,b.canvas.width,b.canvas.height)):b.ga.clearRect(0,0,b.canvas.width,b.canvas.height);b.ga.translate(b.Ja,b.Ha);b.ga.scale(b.scale,b.scale);var g=new I(b.Ja,b.Ha),g=g.multiply(new Tb(b.scale,b.scale));b.ga.oc=g;Fe(b,b.ga,e,f);if(b.ee){var h=b.ga,l=Kd(b.ia);h.beginPath();h.fillStyle="#ffffff";h.shadowOffsetX=3/b.scale;h.shadowOffsetY=3/b.scale;h.shadowBlur=5/b.scale;h.shadowColor="rgba(0,0,0,1.0)";h.rect(0,0,l.width,l.height);h.fill();h.shadowColor="rgba(0,0,0,0.0)";h.shadowBlur=
0;h.shadowOffsetX=0;h.shadowOffsetY=0}b.se&&(b.ga.save(),b.se(b.ga,a,d,e,f),b.ga.restore());a=b.ca.options.symmetry;if(1<a){d=2*Math.PI/a;e=b.Wa(new u(b.canvas.width/2,b.canvas.height/2));a&1&&(g=new Ub(d,e.x,e.y));for(b.ga.save();d<2*Math.PI-1E-8;)0===(a&1)&&(g=new Vb(d,e.x,e.y)),b.ga.transform(g.m11,g.m21,g.m12,g.m22,g.va,g.wa),b.ia.la(b.ga),d+=2*Math.PI/a;b.ga.setTransform(1,0,0,1,0,0);b.ga.fillStyle="rgba(255,255,255,0.3)";b.ga.fillRect(0,0,b.canvas.width,b.canvas.height);b.ga.restore()}b.ia.la(b.ga);
if(0<b.selection.length){b.ga.save();g=b.ga;g.lineWidth=1/b.scale;g.strokeStyle="#888888";g.beginPath();for(a=0;a<b.selection.length;a++)e=b.selection[a],d=L(e),e=new $b(e.Xb),e.transform(d),cc(e,g,[3/b.scale,3/b.scale]);g.stroke();d=b.scale;for(a=0;a<b.lc.length;a++)e=b.lc[a],f=b.$d.apply(e.x,e.y),e instanceof qc?b.Ie&&(g.beginPath(),g.strokeStyle="#008000",g.lineWidth=3/d,g.moveTo(f.x,f.y),g.arc(f.x,f.y,6/d,0,1.5*Math.PI,!1),g.stroke()):(g.beginPath(),g.strokeStyle="#000",g.lineWidth=1/d,g.rect(f.x-
b.pc/d,f.y-b.pc/d,b.pc/d*2,b.pc/d*2),g.stroke())}b.Aa&&b.Aa.Ge(b.ga,1/b.scale);b.bd&&b.ca.get("showHints")&&(b.ga.save(),b.ga.font="10px Arial",b.ga.fillStyle="#000000",b.ga.textBaseline="top",b.ga.fillText(b.bd,0,0),b.ga.restore());g=b.ga;b.ua.eb&&(a=b.ua.x,d=b.ua.y,g.save(),g.setTransform(1,0,0,1,0,0),g.beginPath(),b.ua.we?(g.moveTo(a-3,d-10),g.lineTo(a+3,d-10),g.moveTo(a-3,d+10),g.lineTo(a+3,d+10),g.moveTo(a,d-10),g.lineTo(a,d+10)):(g.moveTo(a,d-3),g.lineTo(a,d-15),g.moveTo(a,d+3),g.lineTo(a,d+
15),g.moveTo(a-3,d),g.lineTo(a-15,d),g.moveTo(a+3,d),g.lineTo(a+15,d)),b.ua.Na&&b.ga.arc(a,d,8,0,2*Math.PI,!1),g.lineWidth=2,g.strokeStyle="#000000",g.stroke(),g.restore());0<b.selection.length&&b.Dc&&(b.ga.setTransform(1,0,0,1,0,0),b.ga.drawImage(b.Dc,b.canvas.width-b.Dc.width-oc(b.qb),0));b.na.Hf&&b.na.Hf(b.ga);b.Fe&&b.Fe()})}},Ua:function(){this.ca.get("readOnly")?this.log("readOnly mode: Ignoring undo."):this.ia.Ic()&&(this.ia.Ua(),this.ia.format(this.ga,this.nb),Ge(this),vc(this),this.la(),this.ha.emit("document-changed"))},
Ra:function(){this.ca.get("readOnly")?this.log("readOnly mode: Ignoring redo."):this.ia.Hc()&&(this.ia.Ra(),this.ia.format(this.ga,this.nb),Ge(this),vc(this),this.la(),this.ha.emit("document-changed"))},Yc:function(a){var b=this.Mc();if(0!==b.length){var c;c=this.ia;var d,e,f,g,h;d=[];e=0;h=Id(c,b);f=0;for(g=h.length;f<g;f++)b=h[f],e=Nd(c,b,d,e);c="zwibblerclip."+JSON.stringify(d);!0!==a&&(te()?window.localStorage.setItem("clipboard",c):ue.clipboard=c);this.log("Reset paste offset to 0");this.Vc=
0;return c}},duplicate:function(){var a=X(this);0<a.length&&this.qa([new zd(a,10)])},Ud:function(a){var b=[];a||(a=te()?window.localStorage.getItem("clipboard"):ue.clipboard);a=Md(this.ia,a,b);var c=this.ca.get("pasteOffset");0!==c&&(this.Vc+=c,this.log("Using paste offset %s",this.Vc),c=new I(this.Vc,this.Vc),a.push(new K(b,c,c.inverse())));this.qa(a);this.update()},nd:function(a,b){this.log("Set document size %s,%s",a,b);this.ia.setProperty("width",a);this.ia.setProperty("height",b);W(this);Ce(this);
this.ha.emit("document-changed")},Ec:function(a){var b,c,d,e,f;d=new Yc;e=this.Wa(new u(-50,-50));f=this.Wa(new u(50,-50));c=this.Wa(new u(50,50));b=this.Wa(new u(-50,50));d.moveTo(e.x,e.y);d.lineTo(f.x,f.y);d.lineTo(c.x,c.y);d.lineTo(b.x,b.y);d.lineTo(e.x,e.y);d.close();a={commands:d.Jb(),fillStyle:this.Ob,strokeStyle:this.Pb,seed:Math.round(65535*Math.random()),lineWidth:this.ya.lineWidth,sloppiness:this.ya.sloppiness,roundRadius:a,layer:this.Ka};this.log("Create an item on layer %s",this.Ka);this.oa.emit("tool-changed",
"rectangle");y(this,new Cc(this,"PathNode",a,100,100,"rectangle"))},sd:function(){var a=new u(0,0),b=new Yc;b.moveTo(a.x,a.y-50);R(b,a.x+50,a.y-50,a.x+50,a.y);R(b,a.x+50,a.y+50,a.x,a.y+50);R(b,a.x-50,a.y+50,a.x-50,a.y);R(b,a.x-50,a.y-50,a.x,a.y-50);b.close();a={commands:b.Jb(),fillStyle:this.Ob,strokeStyle:this.Pb,seed:Math.round(65535*Math.random()),lineWidth:this.ya.lineWidth,sloppiness:this.ya.sloppiness,layer:this.Ka};this.oa.emit("tool-changed","ellipse");y(this,new Cc(this,"PathNode",a,100,
100,"circle"))},Nc:function(){return Ha(this.canvas)},Ub:function(a,b){this.na.Ub?(this.log("Simulating click of colour %s",a),this.na.Ub({Qa:a,button:b?2:1})):this.log("A colour is not needed for this tool.")},xb:function(a){this.ia.xb(a)&&(M(this),Zc(this),this.la(),this.oa.emit("set-page",a))},gf:function(a){this.ee=a;a=re(this);this.Ja=-a.x;this.Ha=-a.y;W(this);this.la()},ie:function(){this.zoom(1.1*this.scale)},je:function(){this.zoom(this.scale/1.1)}};
function He(a,b){var c,d;c=a.ia.Ca;d=a.Wa(new u(100,100));d=new I(d.x,d.y);a.qa([new O("ImageNode",{url:b,layer:a.Ka}),new K([c],d,d.inverse())]);return N(a)}function oe(a,b,c){var d=a.ca.get("nudge");b*=d/a.scale;c*=d/a.scale;a.log("Nudge selection by %s, %s",b,c);d=X(a);d.length&&(b=new I(b,c),a.qa([new K(d,b,b.inverse())]));return 0<d.length}
function W(a){if(a.ca.get("scrollbars")){var b=re(a),c=b.width,d=b.height,e=a.canvas.width/a.scale,f=a.canvas.height/a.scale;if(f>=d)a.qb.Ga();else{a.qb.show();var g=a.qb,h=b.y,l=b.bottom(),k=-a.Ha/a.scale;g.Rb=h;g.Qb=l-h;g.he=f;g.position=k;g.format();g.la()}e>=c?a.Eb.Ga():(a.Eb.show(),g=a.Eb,h=b.x,b=b.right(),l=-a.Ja/a.scale,g.Rb=h,g.Qb=b-h,g.he=e,g.position=l,g.format(),g.la());e>=c&&f>=d||(e>=c?jc(a.qb,20,a.canvas.height):f>=d?jc(a.Eb,a.canvas.width,20):(jc(a.qb,20,a.canvas.height-20),jc(a.Eb,
a.canvas.width-20,20)))}else a.qb.Ga(),a.Eb.Ga()}function re(a){a.ee?(a=Kd(a.ia),a=new G(0,0,a.width,a.height),a.dc(20,20)):a=Ld(a.ia);return a}function Ie(a,b){a.ca.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(y(a,new qd(a,"arrow",void 0,b)),a.oa.emit("tool-changed","arrow"))}function pe(a){a.ca.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(y(a,new qd(a,"curves")),a.oa.emit("tool-changed","curve"))}
function Je(a,b,c){b=b||a.Nb;c=c||a.sc;a.ca.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(y(a,new Xc(a,a.na,b,c,"shapes")),a.oa.emit("tool-changed","shapebrush"))}function Ke(a,b,c){b=b||a.Nb;c=c||a.sc;a.ca.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(y(a,new Xc(a,a.na,b,c,"brush")),a.oa.emit("tool-changed","brush"))}
function qe(a,b){a.ca.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(y(a,new qd(a,"lines",void 0,b)),a.oa.emit("tool-changed","line"))}function se(a){a.ca.get("readOnly")?a.log("readOnly mode: Ignoring tool click."):(y(a,new wc(a)),a.oa.emit("tool-changed","text"))}function y(a,b){a.na&&a.na.yc&&a.na.yc();a.na=b;b.cc&&b.cc()}function N(a){y(a,new Pa(a));a.oa.emit("tool-changed","pick")}
function rd(a,b){b?(a.bd=a.language.get(b),a.ha.emit("hint",a.bd)):(a.bd=null,a.ha.emit("hint",""))}function Ce(a){"page"===a.Yb||"width"===a.Yb?a.zoom(a.Yb):W(a)}function Fe(a,b,c,d){a.background?(b.fillStyle=a.ga.createPattern(a.background,"repeat"),b.fillRect(0,0,c,d)):"G_vmlCanvasManager"in window&&(b.fillStyle="rgba(0, 0, 0, 0.0)",b.fillRect(0,0,c,d))}
function Ee(a){var b=a.ca.get("snap"),c=null,d,e;if("grid"===a.ca.get("background")){var b=a.ca.get("gridSpacing"),f=10*b,c=Da(document.body);c.width=f;c.height=f;d=c.getContext("2d");d.beginPath();for(e=0;e<f;e+=b)e%f&&(d.moveTo(e+.5,0),d.lineTo(e+.5,f));for(e=0;e<f;e+=b)e%f&&(d.moveTo(0,e+.5),d.lineTo(f,e+.5));d.strokeStyle="#cccccc";d.lineWidth=1;d.stroke();d.beginPath();for(e=0;e<=f;e+=f)d.moveTo(e,0),d.lineTo(e,f);for(e=0;e<=f;e+=f)d.moveTo(0,e+.5),d.lineTo(f,e+.5);d.lineWidth=2;d.stroke()}else 0<
b&&"clear"!==a.ca.get("background")&&(c=Da(document.body),c.width=b,c.height=b,d=c.getContext("2d"),d.beginPath(),d.moveTo(0,0),d.arc(0,0,3,0,2*Math.PI,!1),d.moveTo(b,0),d.arc(b,0,3,0,2*Math.PI,!1),d.moveTo(b,b),d.arc(b,b,3,0,2*Math.PI,!1),d.moveTo(0,b),d.arc(0,b,3,0,2*Math.PI,!1),d.fillStyle="#c0c0c0",d.fill());c&&document.body.removeChild(c);a.background=c}function X(a,b){var c=[],d=a.Mc();b||(d=Id(a.ia,d));for(var e=0;e<d.length;e++)a.log("Selected id=%s",d[e].id),c.push(d[e].id);return c}
function Ge(a){for(var b=0,c=0;c<a.selection.length;c++)c!==b&&(a.selection[b]=a.selection[c]),a.selection[b].id in a.ia.sa&&(b+=1);a.selection.length!==b&&(a.selection.length=b)}
function vc(a){function b(a,b,c,d,f){e.lc.push(new Hc(a,c,new u(b.x+d*b.width,b.y+f*b.height),new u(b.x+(1-d)*b.width,b.y+(1-f)*b.height)))}var c;a.ae=!0;a.bf=!0;if(0!==a.selection.length){a.pb=a.selection[0].tb().clone();a.selection[0].ma("lockSize")&&(a.ae=!1);a.selection[0].ma("lockRotate")&&(a.bf=!1);for(c=1;c<a.selection.length;c++)Rb(a.pb,a.selection[c].tb()),a.selection[c].ma("lockSize")&&(a.ae=!1),a.selection[c].ma("lockRotate")&&(a.bf=!1);a.Sf=1===a.selection.length?a.selection[0].wf():new J(a.pb);
c=a.selection[0].ma("rotateHandle");var d;1===a.selection.length&&c?(d=L(a.selection[0]),d=d.apply(c[0],c[1]),a.$e=d.x,a.af=d.y):(a.$e=a.pb.x+a.pb.width-30/a.scale,a.af=a.pb.y);var e=a;a.lc.length=0;var f,g;if(1<a.selection.length)d=new H,f=null,g=a.pb,b(f,g,d,.5,0),b(f,g,d,1,.5),b(f,g,d,.5,1),b(f,g,d,0,.5),b(f,g,d,0,0),b(f,g,d,1,0),b(f,g,d,1,1),b(f,g,d,0,1),e.lc.push(new qc(f,d,new u(g.x+.75*g.width,g.y),new u(g.x+.5*g.width,g.y+.5*g.height)));else for(c=0;c<a.selection.length;c++)f=a.selection[c],
g=f.Xb,d=L(f),b(f,g,d,.5,0),b(f,g,d,1,.5),b(f,g,d,.5,1),b(f,g,d,0,.5),b(f,g,d,0,0),b(f,g,d,1,0),b(f,g,d,1,1),b(f,g,d,0,1),e.lc.push(new qc(f,L(f),new u(g.x+.75*g.width,g.y),new u(g.x+.5*g.width,g.y+.5*g.height)))}}
function Zc(a){vc(a);if(a.cb){var b=a.cb,c=a.selection;b.action=null;b.Xd.length=0;b.Yd={};b.sa=c.concat();for(var d=!1,e=0;e<c.length;e++){var f=c[e];Mc(f)&&(d=!0);var g=f.ba,h;for(h in g)if(g.hasOwnProperty(h)){var l=b,k=h,p=f,q=void 0,q=l.ca;k in l.Yd?(q=l.Yd[k],q.value!==p.ma(k)&&(q.value=null)):"locked"===k||"points"===k||!0===p.ma("closed")&&("arrowSize"===k||"arrowStyle"===k||"doubleArrow"===k)||!1===p.ma("closed")&&("fontName"===k||"fontSize"===k||"textFillStyle"===k||"text"===k||"fillStyle"===
k)||"ImageNode"===p.type()&&("fillStyle"===k||"strokeStyle"===k||"lineWidth"===k||"shadow"===k)||"BrushNode"===p.type()&&"fillStyle"===k||"MathNode"===p.type()&&("fillStyle"===k||"strokeStyle"===k||"lineWidth"===k)||"TextNode"===p.type()&&"fillStyle"===k||"lockSize"===k||"lockRotate"===k||"rotateAround"===k||"layer"===k||0===k.indexOf("cell-")||"fontName"===k&&!q.get("showFontNameProperty")||"fontSize"===k&&!q.get("showFontSizeProperty")||"smoothness"===k&&!q.get("showSmoothnessProperty")||"sloppiness"===
k&&!q.get("showSloppinessProperty")||(q={Ze:Le(l,p,k),value:p.ma(k)},q.Ze.display&&0===q.Ze.display.indexOf("Display-")||(l.Xd.push(q),l.Yd[k]=q))}}Me(b);if(b.ca.get("showKeyboardHelp"))for(f=d,d=ya(n("<div>"),"keydiv"),d.$("font-size","8pt"),d.$("color","#909090"),d.$("font-weight","normal"),n(b.aa).append(d),g=b.language.vc(),d.append("<h1>"+g("keyboard")+"</h1>"),e=[{key:b.ca.get("keyCurveTool"),description:g("draw-curves")},{key:b.ca.get("keyLineTool"),description:g("draw-lines")}],0<c.length&&
e.push({key:b.ca.get("keyDelete"),description:g("delete-selection")},{key:b.ca.get("keyDuplicate"),description:g("duplicate-selection")},{key:b.ca.get("keyMoveUp"),description:g("move-selection-closer")},{key:b.ca.get("keyMoveDown"),description:g("move-selection-away")}),1<c.length&&e.push({key:b.ca.get("keyGroup"),description:g("group-selection")}),f&&e.push({key:b.ca.get("keyUngroup"),description:g("break-apart-group")}),e.push({key:b.ca.get("keyZoomIn"),description:g("zoom-in")}),e.push({key:b.ca.get("keyZoomOut"),
description:g("zoom-out")}),e.push({key:g("arrow-keys"),description:g("move-while-zoomed")}),b=0;b<e.length;b++)c=ya(n("<a>").text(e[b].key),"key"),c.$("background","#d0d0d0"),c.$("border-left","1px solid #808080"),c.$("border-right","1px solid #e0e0e0"),c.$("border-top","1px solid #808080"),c.$("border-bottom","1px solid #e0e0e0"),c.$("padding-left","0.5em"),c.$("padding-right","0.5em"),c.$("margin-right","1em"),c.$("color","#4fa0d3"),c.$("font-weight","bold"),c=n("<p>").append(c),c[0].appendChild(document.createTextNode(e[b].description)),
d.append(c)}a.ha.emit("selected-nodes")}function me(a,b){a.Aa=null;if(b.ob!==a.ob&&Oc(b)===a.Ka){a.selection.push(b);b.ob=a.ob;if(Mc(b)){for(var c=b.parent,d=0;d<c.children.length;d++)me(a,c.children[d]);me(a,c)}b.children&&0<b.children.length&&me(a,b.children[0])}}function M(a){0<a.selection.length&&(a.ob+=1,a.selection.length=0,a.log("Clear selection. selectGeneration=%s",a.ob));a.Aa&&(a.log("Clear selection."),a.Aa=null)}function De(a){var b=X(a);b.length&&a.qa([new ud(b)])}
function Bc(a){a.ua.eb=!0;a.ua.we=!1;if(0<a.selection.length){a.log("showKeyboardCursorAndStartMoving()");a.ua.Na=!0;var b=Pb(a.pb);a.ua.x=b.x;a.ua.y=b.y;N(a);y(a,new pc(a,new Ic(a.selection[0],L(a.selection[0])),!1,b.x-4,b.y-4))}a.la()}
function Be(a){var b=ne(a),c=new Date;n(a.canvas).bind("touchstart",function(b){if(a.na.$a){if(300<(new Date).getTime()-c.getTime())a.na.$a(b.Hb);else if(a.na.ic){var d=le(a,b.Hb.touches[0]);a.na.ic(d.x,d.y)}b.stopPropagation();b.preventDefault();c=new Date}});n(a.canvas).bind("touchmove",function(b){a.na.$a&&(a.na.$a(b.Hb),b.stopPropagation(),b.preventDefault())});n(a.canvas).bind("touchend",function(b){a.na.$a&&(a.na.$a(b.Hb),b.stopPropagation(),b.preventDefault())});n(a.canvas).bind("gesturestart",
function(b){a.log("GestureStart");a.na.Oc&&(a.na.Oc(b.Hb),b.stopPropagation(),b.preventDefault())});n(a.canvas).bind("gesturechange",function(b){a.log("GestureChange");a.na.Oc&&(a.na.Oc(b.Hb),b.stopPropagation(),b.preventDefault())});n(a.canvas).bind("gestureend",function(b){a.log("GestureEnd");a.na.Oc&&(a.na.Oc(b.Hb),b.stopPropagation(),b.preventDefault())});ua(n(a.canvas),function(c){if(a.na.Za){var d=n(a.canvas).offset();a.na.Za((c.pageX-d.left-b-a.Ja)/a.scale,(c.pageY-d.top-b-a.Ha)/a.scale,c)}c.preventDefault()});
wa(n(a.canvas),function(c){var d=n(a.canvas).offset();a.na.Ya&&a.na.Ya((c.pageX-d.left-b-a.Ja)/a.scale,(c.pageY-d.top-b-a.Ha)/a.scale,c);c.preventDefault()});va(n(a.canvas),function(c){var d=n(a.canvas).offset();a.na.fb&&a.na.fb((c.pageX-d.left-b-a.Ja)/a.scale,(c.pageY-d.top-b-a.Ha)/a.scale,c);c.stopPropagation();c.preventDefault()});n(a.canvas).click(function(c){var d=n(a.canvas).offset();a.na.jb&&a.na.jb((c.pageX-d.left-b-a.Ja)/a.scale,(c.pageY-d.top-b-a.Ha)/a.scale);c.stopPropagation();c.preventDefault()});
ta(n(a.canvas),function(c){var d=n(a.canvas).offset();if(a.na.ic||a.na.jb){var g=(c.pageX-d.left-b-a.Ja)/a.scale,d=(c.pageY-d.top-b-a.Ha)/a.scale;Ga()&&a.na.jb&&(a.log("Insert false mouse click for IE"),a.na.jb(g,d));a.na.ic&&a.na.ic(g,d,c)}c.stopPropagation();c.preventDefault()});n(a.canvas).bind("mouseenter",function(a){a.stopPropagation();a.preventDefault()});n(a.canvas).bind("mouseleave",function(a){a.stopPropagation();a.preventDefault()});n(a.canvas).bind("mouseover",function(a){a.stopPropagation();
a.preventDefault()});n(a.canvas).bind("mouseout",function(a){a.stopPropagation();a.preventDefault()});!window.parent&&a.ca.get("setFocus")&&n(a.canvas).focus();a.rb.bind("colour",function(b){a.na.Ub&&a.na.Ub(b)});var d="mousewheel";"onwheel"in document.createElement("div")&&(d="wheel");a.log("Binding to '%s' for mouse wheel",d);n(a.canvas).bind(d,function(b){if("block"===a.qb.canvas.style.display){var c=re(a),d=b.Hb.wheelDelta||-40*b.Hb.deltaY,h=d/120*32;a.Ha=-120>=d?Math.max(a.Ha+h,-(c.bottom()*
a.scale-a.canvas.height)):Math.min(a.Ha+h,-c.y*a.scale);W(a);a.la();b.stopPropagation();b.preventDefault()}})}function le(a,b){return s(a,b.pageX,b.pageY)}function Ac(a,b,c){var d=ne(a),e=n(a.canvas).offset();return new u(b*a.scale+a.Ja+e.left+d,c*a.scale+a.Ha+e.top+d)}function s(a,b,c){var d=ne(a),e=n(a.canvas).offset();return a.Wa(new u((b-e.left-d-a.Ja)/a.scale,(c-e.top-d-a.Ha)/a.scale))}function Ne(a,b,c){a.ya[b]=c;"fillStyle"===b?a.Ob=c:"strokeStyle"===b&&(a.Pb=c)}
function ne(a){return parseInt(n(a.canvas).$("border-left-width"),10)||0};function Oe(a){Pe(this,a)}function Pe(a,b){a.aa=b||n("<div>");a.aa.$("position","absolute");a.aa.$("margin","0px");a.aa.$("padding","0px");n("body").append(a.aa)}m=Oe.prototype;m.width=function(a){function b(a){a=parseInt(c.aa.$(a),10);return isNaN(a)?0:a}var c=this;if(void 0===a)return this.aa.outerWidth();a-=b("border-left-width");a-=b("border-right-width");a-=b("padding-right");a-=b("padding-left");a-=b("margin-left");a-=b("margin-right");a=Math.max(0,a);this.aa.$("width",""+a+"px")};
m.height=function(a){function b(a){a=parseInt(c.aa.$(a),10);return isNaN(a)?0:a}var c=this;if(void 0===a)return this.aa.outerHeight();a-=b("border-top-width");a-=b("border-bottom-width");a-=b("padding-top");a-=b("padding-bottom");a-=b("margin-top");a-=b("margin-bottom");this.td=a=Math.max(0,a);this.aa.$("height",""+this.td+"px")};m.moveTo=function(a,b){this.aa.$("left",""+a+"px");this.aa.$("top",""+b+"px")};m.show=function(){this.aa.show()};m.Ga=function(){this.aa.Ga()};function Qe(a){Oe.apply(this,arguments);var b=this;this.aa.$("background","black");this.aa.$("font-family",'"Lucida Console","Dejavu Sans Mono",Monospace,"Courier New"');this.aa.$("font-size","10px");this.aa.$("line-height","12px");this.aa.$("overflow","scroll");this.aa.$("cursor","default");this.Te=0;this.Pe={};this.eb=!1;this.width(300);ia(function(a,d){return Re(b,a,d)});this.timeout=null;this.ab=[];Re(this,"DEBUG","Debug window starting")}
Qe.prototype={mb:"#ffffff #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" "),show:function(){Oe.prototype.show.call(this);this.eb=!0;Se(this);this.aa[0].scrollTop=this.aa[0].scrollHeight},Ga:function(){this.eb=!1;Oe.prototype.Ga.call(this)}};
function Se(a){var b,c,d,e,f,g;g=a.ab;e=0;for(f=g.length;e<f;e++){c=g[e];d=c.key;c=c.Ig;b=a;var h=d;h in b.Pe||(b.Pe[h]=b.mb[b.Te],b.Te=(b.Te+1)%b.mb.length);b=b.Pe[h];b=n("<div>").$("color",b);b.$("border-bottom","1px solid #222");b.text(""+d+": "+c);a.aa.append(b)}a.aa[0].scrollTop=a.aa[0].scrollHeight;a.timeout=null;a.ab.length=0}
function Re(a,b,c){var d,e,f;f=c.split("\n");d=0;for(e=f.length;d<e;d++)c=f[d],a.ab.push({key:b,Ig:c});a.eb&&null===a.timeout&&(a.timeout=setTimeout(function(){return Se(a)},100))}F(Oe.prototype,Qe.prototype);function Te(a){var b=n("<div>");Pe(this,b);a.append(this.aa);this.Fa={};this.maxWidth=128;this.lh=5;this.aa.$("overflow-x","auto");this.aa.$("overflow-y","auto");this.Md="grid";this.Ue=0;this.Hd=1;this.cells=[];this.Hg=new Ja({itemSize:this.maxWidth,algorithm:"mason",resize:!1});this.jf=null}
Te.prototype={on:function(a,b){this.Fa[a]=b},log:r("ListView"),format:function(){var a,b,c,d,e;b=null;e=this.cells;c=0;for(d=e.length;c<d;c++){a=e[c];if(!a.Df){if(null===b){b=this.aa;var f=a.Ia,f=pa(f);0<b.length&&b[0].insertBefore(f[0],b[0].firstChild)}else b=b.Ia,f=a.Ia,f=pa(f),0<b.length&&0<f.length&&b[0].parentNode.insertBefore(f[0],b[0]);a.Df=!0}b=a}this.Hg.Md(this.aa[0])},clear:function(){this.aa.empty();this.cells.length=0;this.Hd+=1}};
function Ue(a,b,c){var d,e;e=a.Hd;d={Ia:null,index:a.Ue,Df:!1};a.Ue+=1;nb(b,function(b){var g,h;e===a.Hd&&(h=b.width,g=b.height,h>a.maxWidth&&(b.width=a.maxWidth,b.height=g/h*a.maxWidth),b=n(b),b.$("margin",""+a.lh+"px"),b.$("border-width","3"),b.$("border-color","white"),b.$("border-style","solid"),b.$("image-rendering","optimizeQuality"),sa(b,function(){a.log("Mouseenter");return b.$("border-color","#888888")}),ra(b,function(){return b.$("border-color","white")}),b.click(function(){if("click"in
a.Fa)return a.Fa.click(c)}),d.Ia=b,a.cells.push(d),a.cells.sort(function(a,b){return a.index-b.index}),a.jf||(a.jf=setTimeout(function(){a.jf=null;a.format()},500)))})}function Ve(a){a.Md="horizontal";"grid"!==a.Md&&a.aa.$("white-space","nowrap")}Te.prototype=n.extend({},Oe.prototype,Te.prototype);function We(a,b,c){this.Ba(a,b,c)}We.prototype.log=r("Menubar");
We.prototype.Ba=function(a,b,c){Pe(this,n("<div>"));this.Tg=c;this.aa.$("position","absolute");this.aa.$("background","#ccc");this.aa.$("font-family","tahoma,helvetica,arial,sans");this.aa.$("font-size","12px");this.aa.$("padding","0.5em");this.aa.$("cursor","default");this.aa.$("MozUserSelect","none");this.aa[0].onselectstart=function(){return!1};c&&(this.aa.$("background","white"),this.aa.$("border-left","1px solid #ccc"),this.aa.$("border-bottom","1px solid #888"),this.aa.$("border-right","1px solid #888"),
this.aa.$("box-shadow","3px 3px 5px #ccc"));this.hd=a;this.ha=b;for(b=0;b<a.items.length;b++)Xe(this,a.items[b]);this.Mb=this.Ib=null;this.aa.$("z-index",3001)};
function Xe(a,b){var c;a.Tg?("separator"===b.type?c=n("<hr>"):(c=n("<div>"),c.$("padding-left","0.5em"),c.$("padding-right","0.5em"),c.text(b.display),qa(c,function(){c.$("background","#ff9900")},function(){c.$("background","transparent")}),va(c,function(){a.yd&&a.yd();a.ha.emit(b.event,b.rg)})),a.aa.append(c)):"separator"!==b.type&&(6<b.display.length&&"image:"===b.display.substr(0,6)?(c=n("<img>"),c.La("src",b.display.substr(6)),c.load(function(){a.ha.emit("resize",{})}),c.$("border","1px solid #888"),
c.$("box-shadow","3px 3px 3px #000"),c.$("border-radius","5px"),c.$("vertical-align","middle"),c.$("margin-left","0.5em"),c.$("margin-right","0.5em"),qa(c,function(){c.$("background","#ff9900");c.$("color","white");a.Mb&&Ba(c)},function(){c.$("background","transparent");c.$("color","black")}),a.aa.append(c)):(c=n("<div>"),c.$("display","inline"),c.$("padding-left","0.5em"),c.$("padding-right","0.5em"),c.$("padding-top","0.5em"),c.$("padding-bottom","0.5em"),c.$("MozUserSelect","none"),c[0].onselectstart=
function(){return!1},c.$("vertical-align","middle"),c.text(b.display),qa(c,function(){c.$("background","#ff9900");if(a.Mb&&a.Mb!==b.hd){var d=c.offset();a.log("highlight a menu item.");a.Xf(b,d.left,d.top+c.outerHeight())}},function(){c.$("background","transparent")})),"menu"===b.type?wa(c,function(){var d=c.offset();a.Xf(b,d.left,d.top+c.outerHeight())}):c.click(function(){a.ha.emit(b.event,{})}),a.aa.append(c))}We.prototype.click=function(a){this.yd=a};
function Ye(a){a.Mb&&(a.Mb.aa.remove(),a.Mb=null);a.Ib&&(a.Ib.Ga(),a.Ib=null)}We.prototype.Xf=function(a,b,c){if(this.Mb&&this.Mb.hd===a.hd)Ye(this);else{Ye(this);var d=n(this.aa).offset().top+this.height(),d=new aa("transparent",0,d),e=this,f=function(){Ye(e)};d.show(f);a=new We(a.hd,this.ha,!0);a.click(f);a.moveTo(b,c);this.Mb=a;this.Ib=d}};F(Oe.prototype,We.prototype);function Y(a,b){this.type=a;this.fa=b;if(4>this.fa.length)throw"Bad value";}var Ze;
function $e(a){a.toLowerCase()in af&&(a=af[a.toLowerCase()]);var b=/rgba\( *([0-9]+) *, *([0-9]+) *, *([0-9]+) *, *([0-9\.]+) *\)/,c,d;d=/\#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])/i.exec(a);null!==d?(a=parseInt(d[1],16)/255,b=parseInt(d[2],16)/255,c=parseInt(d[3],16)/255,d=1):(d=b.exec(a),null!==d?(a=parseFloat(d[1])/255,b=parseFloat(d[2])/255,c=parseFloat(d[3])/255,d=parseFloat(d[4])):(a=1,b=0,d=c=1));return new Y(0,[a,b,c,d])}
Y.prototype={toString:function(){function a(a){a=Math.round(255*a);return 16>a?"0"+a.toString(16):a.toString(16)}var b=bf(this,0);return 1===b.fa[3]?"#"+a(b.fa[0])+a(b.fa[1])+a(b.fa[2]):"rgba("+Math.round(255*b.fa[0])+","+Math.round(255*b.fa[1])+","+Math.round(255*b.fa[2])+","+b.fa[3]+")"},Db:function(a){a.type!==this.type&&(a=bf(a,this.type));if(2===this.type){var b=this.fa[0],c=a.fa[0],b=b>c?Math.min(b-c,c-b+360):Math.min(c-b,b-c+360),b=b/360;return Math.pow(b*b+(this.fa[1]-a.fa[1])*(this.fa[1]-
a.fa[1])+(this.fa[2]-a.fa[2])*(this.fa[2]-a.fa[2]),.5)}return Math.pow((this.fa[0]-a.fa[0])*(this.fa[0]-a.fa[0])+(this.fa[1]-a.fa[1])*(this.fa[1]-a.fa[1])+(this.fa[2]-a.fa[2])*(this.fa[2]-a.fa[2]),.5)}};function bf(a,b){return Ze[a.type][b](a)}
(function(){function a(a){var b=a.fa[0],c=a.fa[1],d=a.fa[2];0>b&&(b+=360);var e=b/60-Math.floor(b/60),f=d*(1-c),g=d*(1-e*c),c=d*(1-(1-e)*c),h,k,l;switch(Math.floor(b/60)%6){case 0:h=d;k=c;l=f;break;case 1:h=g;k=d;l=f;break;case 2:h=f;k=d;l=c;break;case 3:h=f;k=g;l=d;break;case 4:h=c;k=f;l=d;break;case 5:h=d,k=f,l=g}return new Y(0,[h,k,l,a.fa[3]])}function b(a){var b,c=a.fa[0],d=a.fa[1],e=a.fa[2],f=Math.max(c,d,e),g=Math.min(c,d,e);f===g?b=0:f===c?b=(60*(d-e)/(f-g)+360)%360:f===d?b=60*(e-c)/(f-g)+
120:f===e&&(b=60*(c-d)/(f-g)+240);return new Y(2,[b,0===f?0:1-g/f,f,a.fa[3]])}function c(a){function b(a){return a>6/29*(6/29)*(6/29)?Math.pow(a,1/3):1/3*(29/6)*(29/6)*a+4/29}var c=b(a.fa[1]/k.le);return new Y(3,[116*c-16,500*(b(a.fa[0]/k.ke)-c),200*(c-b(a.fa[2]/k.me)),a.fa[3]])}function d(a){var b=(a.fa[0]+16)/116,c=b+a.fa[1]/500,d=b-a.fa[2]/200,e=6/29;return new Y(1,[c>e?k.ke*c*c*c:3*(c-16/116)*e*e*k.ke,b>e?k.le*b*b*b:3*(b-16/116)*e*e*k.le,d>e?k.me*d*d*d:3*(d-16/116)*e*e*k.me,a.fa[3]])}function e(a){for(var b=
[],c=0;3>c;c++)b[c]=.04045>=a.fa[c]?a.fa[c]/12.92:Math.pow((a.fa[c]+.055)/1.055,2.4);return new Y(1,[.4124*b[0]+.3576*b[1]+.1805*b[2],.2126*b[0]+.7152*b[1]+.0722*b[2],.0193*b[0]+.1192*b[1]+.9505*b[2],a.fa[3]])}function f(a){var b=[],c=[];b[0]=3.241*a.fa[0]-1.5374*a.fa[1]-.4986*a.fa[2];b[1]=-.9692*a.fa[0]+1.876*a.fa[1]+.0416*a.fa[2];b[2]=.0556*a.fa[0]-.204*a.fa[1]+1.057*a.fa[2];for(var d=0;3>d;d++)c[d]=.0031308>=b[d]?12.92*b[d]:1.055*Math.pow(b[d],1/2.4)-.055;c[3]=a.fa[3];return new Y(0,c)}function g(a){return new Y(a.type,
a.fa.concat())}function h(a){return c(e(a))}function l(a){return b(f(a))}var k={ke:.9505,le:1,me:1.089};Ze=[[g,e,b,h],[f,g,l,c],[a,function(b){return e(a(b))},g,function(b){return h(a(b))}],[function(a){return f(d(a))},d,function(a){return l(d(a))},g]]})();
var af={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",
darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",
gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",
lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",
orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",
snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};function cf(a,b,c,d){this.Ba(a,b,c,d)}m=cf.prototype;
m.Ba=function(a,b,c,d){function e(a){for(var b=30;100>b;b+=20)a.fa[2]=b/100,f.mb.push(a.toString())}z.call(this);this.aa=this.canvas=n(Da(a[0]));this.canvas.$("position","absolute");this.canvas.$("border","none");this.canvas.$("border-top","1px solid black");this.canvas.$("display","block");this.ga=this.canvas[0].getContext("2d");this.size=b;this.nc=c;this.ag=d;this.mb="rgba(0,0,0,0.0) #000000 #ffffff #000088 #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" ");var f=
this;e(new Y(2,[0,0,0,1]));for(a=0;720>a;a+=35)b=new Y(2,[a,.5,0,1]),e(b);df(this,100);this.canvas.bind("touchstart",function(a){var b=f.canvas.offset();f.jb(a.touches[0].pageX-b.left-0,a.touches[0].pageY-b.top-0,1);a.preventDefault();a.stopPropagation()});wa(this.canvas,function(a){var b=f.canvas.offset();f.jb(a.pageX-b.left-0,a.pageY-b.top-0,a.which)||(a.preventDefault(),a.stopPropagation())});this.canvas.bind("contextmenu",function(a){a.preventDefault();a.stopPropagation();return!1})};m.log=r("COLOURPANEL");
function ef(a,b){a.mb=b.slice(0);a.log("Set colours to %s len=%s",a.mb,a.mb.length);a.format();a.la()}function df(a,b){a.width=b;a.canvas.La("width",""+a.width);a.format();a.la()}m.height=function(){return this.td};m.moveTo=function(a,b){this.canvas.$("left",""+a+"px");this.canvas.$("top",""+b+"px")};
m.format=function(){this.zd=Math.floor(this.width/this.size);var a=Math.ceil(this.mb.length/this.zd);this.log("Format to width=%s; height=%s wrap=%s, cpr=%s",this.width,a*this.size,this.ag,this.zd);this.td=this.ag?a*this.size:this.size;this.canvas.La("height",""+this.td)};
m.la=function(){for(var a=0,b=0,c=0;c<this.mb.length;c++){var d=$e(this.mb[c]);this.ga.fillStyle=this.mb[c];this.ga.fillRect(a,b,this.size,this.size);0===d.fa[3]&&(this.ga.beginPath(),this.ga.strokeStyle="#000000",this.ga.moveTo(a,b),this.ga.lineTo(a+this.size,b+this.size),this.ga.moveTo(a+this.size,b),this.ga.lineTo(a,b+this.size),this.ga.stroke());a+=this.size;a>=this.width&&(b+=this.size,a=0)}};m.Ga=function(){this.canvas.Ga()};m.show=function(){this.canvas.show()};
m.jb=function(a,b,c){a=Math.floor(a/this.size);b=Math.floor(b/this.size);var d=b*this.zd+a;this.log("row=%s col=%s index=%s coloursPerRow=%s",b,a,d,this.zd);return d<this.mb.length?(this.emit("colour",{Qa:this.mb[d],button:c}),!0):!1};n.extend(cf.prototype,z.prototype);function ff(a){this.aa=document.createElement("div");this.canvas=document.createElement("canvas");this.height=this.width=a;this.canvas.width=this.width;this.canvas.height=this.height;this.canvas.style.cursor="crosshair";this.Ca=0;this.aa.appendChild(this.canvas);"G_vmlCanvasManager"in window&&window.G_vmlCanvasManager.initElement(this.canvas);this.ga=this.canvas.getContext("2d");var b=document.createElement("input");b.setAttribute("type","range");this.Wc=document.createElement("input");this.Wc.setAttribute("type",
"checkbox");"range"===b.type?(this.aa.appendChild(document.createElement("br")),this.aa.appendChild(b),b.min=0,b.max=255,b.value=255,this.Gc=b):(this.Gc=null,b="colourcheckbox"+this.Ca,this.Wc.setAttribute("id",b),this.aa.appendChild(document.createElement("br")),this.aa.appendChild(this.Wc),this.Ca+=1,b=n("<label>").La("for",b).text("Transparent"),this.aa.appendChild(b[0]));this.Oa=this.height;this.ec=.8*this.height;if(ff[a])this.data=ff[a];else{for(var b=this.ga.getImageData(0,0,this.Oa,this.Oa),
c=this.Oa/2,d=this.ec/2,e,f=0;f<this.Oa;f++){var g=Math.sqrt(c*c-(f-c)*(f-c)),h=Math.floor(-g+c),l=Math.floor(g+c),k=d*d-(f-c)*(f-c);if(0<=k){for(var g=Math.sqrt(k),k=Math.floor(-g+c),p=Math.floor(g+c),g=f*this.Oa*4+4*h;h<=k;h++)e=Math.atan2(f-c,h-c),e=new Y(2,[e/Math.PI*180,1,1,1]),e=bf(e,0),b.data[g++]=255*e.fa[0],b.data[g++]=255*e.fa[1],b.data[g++]=255*e.fa[2],b.data[g++]=255;g=f*this.Oa*4+4*p;h=p}else g=f*this.Oa*4+4*h;for(;h<=l;h++)e=Math.atan2(f-c,h-c),e=new Y(2,[e/Math.PI*180,1,1,1]),e=bf(e,
0),b.data[g++]=255*e.fa[0],b.data[g++]=255*e.fa[1],b.data[g++]=255*e.fa[2],b.data[g++]=255}this.data=b;ff[a]=b}this.Va=new Y(2,[20,1,1,1]);this.update();this.la();var q=this;q.ue=!1;q.jd="";wa(n(this.canvas),function(a){var b=n(q.canvas).offset(),c=a.pageX-b.left,b=a.pageY-b.top;q.ue=!0;gf(q,c,b);a.stopPropagation();a.preventDefault()});ua(n(this.canvas),function(a){if(q.ue){var b=n(q.canvas).offset();gf(q,a.pageX-b.left,a.pageY-b.top)}a.stopPropagation();a.preventDefault()});va(n(window),function(){q.ue=
!1;q.jd=""});null!==this.Gc&&n(this.Gc).xe(function(){q.Va.fa[3]=q.Gc.value/255;q.update();q.la()});n(this.Wc).xe(function(){q.Va.fa[3]=q.Wc.checked?0:1;q.update();q.la()})}
ff.prototype={update:function(){this.Jf&&this.Jf(this.Va.toString())},la:function(){this.ga.save();this.ga.lineWidth=1;this.ga.fillStyle="rgb(128, 128, 128)";this.ga.fillRect(0,0,this.width,this.height);this.ga.putImageData(this.data,0,0);var a=this.Va.fa[0]/180*Math.PI;this.ga.beginPath();var b={x:Math.cos(a)*this.ec/2+this.Oa/2,y:Math.sin(a)*this.ec/2+this.Oa/2},c={x:Math.cos(a+2*Math.PI/3)*this.ec/2+this.Oa/2,y:Math.sin(a+2*Math.PI/3)*this.ec/2+this.Oa/2},d={x:Math.cos(a+4*Math.PI/3)*this.ec/2+
this.Oa/2,y:Math.sin(a+4*Math.PI/3)*this.ec/2+this.Oa/2},e=Math.cos(a)*this.Oa/2+this.Oa/2,a=Math.sin(a)*this.Oa/2+this.Oa/2,f=c.x+(d.x-c.x)/2,g=c.y+(d.y-c.y)/2;this.ga.moveTo(b.x,b.y);this.ga.lineTo(c.x,c.y);this.ga.lineTo(d.x,d.y);this.ga.lineTo(b.x,b.y);var h=this.ga.createLinearGradient(c.x,c.y,d.x,d.y);h.addColorStop(0,"#ffffff");h.addColorStop(1,"#000000");this.ga.fillStyle=h;this.ga.fill();h=this.ga.createLinearGradient(b.x,b.y,f,g);f=bf(this.Va,2);f.fa[1]=1;f.fa[2]=1;f=bf(f,0);f.fa[3]=1;h.addColorStop(0,
f.toString());f.fa[3]=0;h.addColorStop(1,f.toString());this.ga.fillStyle=h;this.ga.fill();this.strokeStyle="#000000";this.ga.beginPath();this.ga.moveTo(b.x,b.y);this.ga.lineTo(e,a);this.ga.stroke();a=1-this.Va.fa[2];e=this.Va.fa[1]*b.x+a*d.x+(1-this.Va.fa[1]-a)*c.x;a=this.Va.fa[1]*b.y+a*d.y+(1-this.Va.fa[1]-a)*c.y;this.ga.beginPath();this.ga.arc(e,a,4,0,2*Math.PI,!1);this.ga.stroke();this.ga.restore();this.Mg=b;this.Ng=c;this.Og=d}};
function gf(a,b,c){var d=Math.sqrt((b-a.Oa/2)*(b-a.Oa/2)+(c-a.Oa/2)*(c-a.Oa/2));if("ring"===a.jd||"triangle"!==a.jd&&d>=a.ec/2&&d<=a.Oa/2)a.Va.fa[0]=Math.atan2(a.Oa/2-c,a.Oa/2-b)/Math.PI*180+180,0===a.Va.fa[1]&&(a.Va.fa[1]=1,a.Va.fa[2]=1),a.jd="ring";else{var e,f=a.Mg,d=a.Ng,g=a.Og;e=(f.x-g.x)*(d.y-g.y)-(d.x-g.x)*(f.y-g.y);d=((d.y-g.y)*(b-g.x)-(d.x-g.x)*(c-g.y))/e;b=(-(f.y-g.y)*(b-g.x)+(f.x-g.x)*(c-g.y))/e;b=1-Math.max(0,d)-Math.max(0,b);a.Va.fa[1]=Math.min(Math.max(d,0),1);a.Va.fa[2]=1-Math.min(Math.max(b,
0),1);a.jd="triangle"}a.la();a.update()}function hf(a,b){a.Va=bf($e(b),2);null!==a.Gc&&(a.Gc.value=Math.round(255*a.Va.fa[3]));a.Wc.checked=0===a.Va.fa[3]?!0:!1;a.la();a.update()}function jf(){var a=document.createElement("canvas");"G_vmlCanvasManager"in window&&window.G_vmlCanvasManager.initElement(a);return a.getContext&&a.getContext("2d").getImageData};function kf(a,b){this.ca=a;this.language=b;Pe(this,n("<div>"));ya(this.aa,"PropertyPanel");this.Xd=[];this.Yd={};this.view=null;this.sa=[];(this.pf=jf()&&"wheel"===a.get("colourPicker"))||this.log("ColourWheel not supported in this canvas.");this.action=null;this.aa.$("background","#ffffff");this.aa.$("border","none");this.aa.$("font-family","tahoma,arial,helvetica,sans");this.aa.$("color","#4fa0d3");this.aa.$("font-weight","bold");this.aa.$("font-size","10pt");this.aa.$("overflow-y","scroll");var c=
this;this.aa.click(function(){c.log("PropertyPanel clicked.");c.emit("click")});this.onclick=null}kf.prototype={log:r("PROP"),on:function(a,b){if("click"===a)this.onclick=b;else throw"This object only handles the click event";},emit:function(){if(this.onclick)this.onclick()},apply:function(a,b){this.view.setProperty(a,b)}};function lf(a,b,c,d){null!==a.action&&a.action.name===d.name||a.view.setProperty(d.name,b);c.value=b}
function mf(a,b){if(!b.Bf)if(a.pf){var c=new ff(120);hf(c,b.input.value);c.Jf=function(c){lf(a,c,b.input,b.input.wb)};b.Fh=c;b.Bf=!0;b.parentNode.appendChild(c.aa)}else{c=new cf(n(b.parentNode),20,!1,!0);c.aa.$("position","static");ef(c,a.ca.get("colourPalette"));b.Fh=c;b.Bf=!0;b.parentNode.appendChild(c.aa[0]);var d;c.on("colour",function(c){lf(a,c.Qa,b.input,b.input.wb);c=$e(c.Qa).fa[3];d.value=Math.round(100*c)});d=Kb();d.min=0;d.max=100;var e=$e(b.input.value);d.Wf(Math.round(100*e.fa[3]));d.onchange=
function(){e=$e(b.input.value);e.fa[3]=d.value/100;lf(a,e.toString(),b.input,b.input.wb)};b.parentNode.appendChild(document.createElement("br"));b.parentNode.appendChild(d)}}
function Me(a){function b(){mf(a,this)}function c(){var b=this;"timer"in b&&clearTimeout(b.timer);b.timer=setTimeout(function(){a.apply(b.wb.name,b.value)},250)}function d(){var b=a.view,c=this.wb.name;b.log("Someone clicked a button for %s",c);"mathml"===c&&b.ha.emit("math.edit",X(b)[0])}function e(b){13===b.keyCode&&a.apply(this.wb.name,this.value)}function f(){a.apply(this.wb.name,this.wb.fa[parseInt(this.value,10)].value)}n(a.aa).empty();var g,h;for(g=0;g<a.Xd.length;g++){var l=a.Xd[g],k=l.Ze;
if("none"!==k.type){var p=document.createElement("div");h=document.createElement("span");h.appendChild(document.createTextNode(k.display));p.appendChild(h);p.appendChild(document.createElement("br"));if("select"===k.type){var q=document.createElement("select");for(h=0;h<k.fa.length;h++){var t=k.fa[h],x=document.createElement("option");x.appendChild(document.createTextNode(t.name));x.setAttribute("value",h);t.value===l.value&&x.setAttribute("selected","");q.appendChild(x)}q.wb=k;q.onchange=f;p.appendChild(q)}else if("colour"===
k.type)h=document.createElement("input"),h.setAttribute("type","text"),h.value=l.value,h.wb=k,xa(n(h),e),p.appendChild(h),l=document.createElement("img"),l.src=a.ca.Ea+"wd-wheel.png",l.style.verticalAlign="middle",l.input=h,p.appendChild(l),n(l).click(b);else if("text"===k.type)h=document.createElement("input"),h.setAttribute("type","text"),h.value=l.value,h.wb=k,xa(n(h),e),p.appendChild(h);else if("textarea"===k.type)h=document.createElement("textarea"),h.setAttribute("rows","3"),h.setAttribute("cols",
"20"),h.value=l.value,h.wb=k,xa(n(h),c),p.appendChild(h);else if("button"===k.type)h=document.createElement("input"),h.setAttribute("type","button"),h.value="Edit",h.wb=k,n(h).click(d),p.appendChild(h);else throw"Error: No such property";a.aa.append(p)}}}
function Le(a,b,c){var d=a.language.vc();if("strokeStyle"===c)return{name:c,type:"colour",display:d("outline-colour")};if("fillStyle"===c)return{name:c,type:"colour",display:d("fill-colour")};if("lineWidth"===c)return a=[{name:d("thickness-pencil"),value:1},{name:d("thickness-pen"),value:2},{name:d("thickness-marker"),value:4},{name:d("thickness-brush"),value:10}],!0!==b.ma("closed")&&"TextNode"!==b.type()||a.unshift({name:d("none"),value:0}),{name:c,display:d("outline-thickness"),type:"select",fa:a};
if("sloppiness"===c)return{name:"sloppiness",display:d("sloppiness"),type:"select",fa:[{name:d("sloppiness-draftsman"),value:0},{name:d("sloppiness-artist"),value:.25},{name:d("sloppiness-cartoonist"),value:.5},{name:d("sloppiness-child"),value:1},{name:d("sloppiness-drunk"),value:2}]};if("smoothness"===c)return{name:"smoothness",display:d("smoothness"),type:"select",fa:[{name:d("smoothness-sharpest"),value:0},{name:d("smoothness-sharper"),value:.1},{name:d("smoothness-sharp"),value:.2},{name:d("smoothness-smooth"),
value:.3},{name:d("smoothness-smoothest"),value:.5}]};if("shadow"===c)return{name:"shadow",display:d("shadow"),type:"select",fa:[{name:d("yes"),value:!0},{name:d("no"),value:!1}]};if("dashes"===c)return{name:"dashes",display:d("line-style"),type:"select",fa:[{name:d("line-style-solid"),value:""},{name:d("line-style-short-dashes"),value:"5,5"},{name:d("line-style-long-dashes"),value:"10,5"}]};if("matrix"===c||"inverse"===c||"closed"===c||"commands"===c||"seed"===c)return{name:c,type:"none"};if("text"===
c)return{name:"text",display:d("text"),type:"textarea"};if("textFillStyle"===c)return{name:"textFillStyle",display:d("text-colour"),type:"colour"};if("fontSize"===c)return{name:"fontSize",display:d("font-size"),type:"select",fa:[{name:"10",value:10},{name:"12",value:12},{name:"15",value:15},{name:"20",value:20},{name:"30",value:30},{name:"40",value:40},{name:"50",value:50},{name:"60",value:60},{name:"100",value:100}]};if("fontName"===c){b=[];c=a.ca.options.fonts;for(a=0;a<c.length;a++)b.push({name:c[a],
value:c[a]});return{name:"fontName",display:d("font"),type:"select",fa:b}}return"arrowSize"===c?{name:"arrowSize",display:d("arrowhead-size"),type:"select",fa:[{name:d("arrowhead-size-none"),value:0},{name:d("arrowhead-size-tiny"),value:10},{name:d("arrowhead-size-small"),value:15},{name:d("arrowhead-size-medium"),value:20},{name:d("arrowhead-size-large"),value:30}]}:"arrowStyle"===c?{name:"arrowStyle",display:d("arrowhead-style"),type:"select",fa:[{name:d("arrowhead-style-simple"),value:"simple"},
{name:d("arrowhead-style-solid"),value:"solid"}]}:"doubleArrow"===c?{name:"doubleArrow",display:d("double-arrows"),type:"select",fa:[{name:d("no"),value:!1},{name:d("yes"),value:!0}]}:"url"===c?{name:"url",display:d("image-url"),type:"text"}:"mathml"===c?{name:"mathml",display:"Equation",type:"button"}:"rows"===c?{name:c,display:"Rows",type:"text"}:"columns"===c?{name:c,display:"Columns",type:"text"}:{name:c,display:"Display-"+c,type:"text"}}kf.prototype=n.extend({},Oe.prototype,kf.prototype);function nf(a,b,c){var d,e=this;this.oa=a;this.aa=b;this.aa.empty();"absolute"!==this.aa.$("position")&&this.aa.$("position","relative");this.aa.$("overlow","none");this.aa.$("text-align","left");this.Kc=new Qe(n("<div>"));this.log("Starting Zwibbler Version %s",14);this.aa.append(this.Kc.aa);this.ca=new ge(c);this.language=new Ra("en:arrowhead-size:Arrowhead size\nes:arrowhead-size:Flecha tama\u00f1o\n\nen:arrowhead-size-large:Large\nes:arrowhead-size-large:Grande\n\nen:arrowhead-size-medium:Medium\nes:arrowhead-size-medium:Medio\n\nen:arrowhead-size-none:None\nes:arrowhead-size-none:Nada\n\nen:arrowhead-size-small:Small\nes:arrowhead-size-small:Peque\u00f1o\n\nen:arrowhead-size-tiny:Tiny\nes:arrowhead-size-tiny:Diminuto\n\nen:arrowhead-style:Arrowhead style\nes:arrowhead-style:Flecha estilo\n\nen:arrowhead-style-simple:Simple\nes:arrowhead-style-simple:Llanura\n\nen:arrowhead-style-solid:Solid\nes:arrowhead-style-solid:Denso\n\nen:arrow-keys:Arrow Keys\nes:arrow-keys:Teclas de flecha\n\nen:arrow-tool:Arrow tool\nes:arrow-tool:Flecha\n\nen:break-apart-group:Break apart group\nes:break-apart-group:Dividir el grupo\n\nen:bring-to-front:Bring to front\nes:bring-to-front:Traer al frente\n\nen:brush-tool:Brush tool\nes:brush-tool:Brocha\n\nen:circle-tool:Circle tool\nes:circle-tool:C\u00edrculo\n\nen:click-to-place-another-point-or-double-click-to-end-the-line:Click to place another point, or double-click to end the line.\nes:click-to-place-another-point-or-double-click-to-end-the-line:Haga clic para colocar otro punto, o doble clic para finalizar la l\u00ednea\n\nen:click-to-place-first-point-of-line:Click to place first point of line\nes:click-to-place-first-point-of-line:Haga clic para colocar el primer punto de la l\u00ednea\n\nen:click-to-set-the-end-of-the-line:Click to set the end of the line\nes:click-to-set-the-end-of-the-line:Haga clic para colocar el extremo de la l\u00ednea\n\nen:copy:Copy\nes:copy:Copiar\n\nen:curve-tool:Curve tool\nes:curve-tool:Curva\n\nen:delete-selection:Delete selection\nes:delete-selection:Eliminar la selecci\u00f3n\n\nen:del-key:Del\nes:del-key:Del\n\nen:double-arrows:Double arrows\nes:double-arrows:flechas dobles\n\nen:draw-curves:Draw curves\nes:draw-curves:Dibuje las curvas\n\nen:draw-lines:Draw lines\nes:draw-lines:Dibujar l\u00edneas\n\nen:duplicate-selection:Duplicate selection\nes:duplicate-selection:Duplica la selecci\u00f3n\n\nen:fill-colour:Fill colour\nes:fill-colour:Color de relleno\n\nen:font:Font\nes:font:Font\n\nen:font-size:Font size\nes:font-size:Tama\u00f1o de letra\n\nen:group-selection:Group selection\nes:group-selection:Grupo la selecci\u00f3n\n\nen:image-tool:Image tool\nes:image-tool:Imagen\n\nen:image-url:Image URL\nes:image-url:URL de la imagen\n\nen:keyboard:Keyboard\nes:keyboard:Teclado\n\nen:line-style:Line style\nes:line-style:Estilo de l\u00ednea\n\nen:line-style-long-dashes:Long dashes\nes:line-style-long-dashes:Gui\u00f3n largo\n\nen:line-style-short-dashes:Short dashes\nes:line-style-short-dashes:Gui\u00f3n corto\n\nen:line-style-solid:Solid\nes:line-style-solid:Denso\n\nen:line-tool:Line tool\nes:line-tool:Raya\n\nen:math-tool:Equation tool\nes:math-tool:Ecuaci\u00f3n\n\nen:move-selection-away:Move selection away\nes:move-selection-away:Mover la selecci\u00f3n de distancia\n\nen:move-selection-closer:Move selection closer\nes:move-selection-closer:Mover la selecci\u00f3n de distancia\n\nen:move-while-zoomed:Move while zoomed\nes:move-while-zoomed:Desplazarse por la pantalla\n\nen:none:None\nes:none:Nada\n\nen:no:No\nes:no:No\n\nen:outline-colour:Outline colour\nes:outline-colour:Color del contorno\n\nen:outline-thickness:Outline thickness\nes:outline-thickness:Grosor del contorno\n\nen:page-down-key:Page Down\nes:page-down-key:Page Down\n\nen:page-up-key:Page Up\nes:page-up-key:Page Up\n\nen:paste:Paste\nes:paste:Pegar\n\nen:pick-tool:Pick tool\nes:pick-tool:Seleccionar\n\nen:rectangle-tool:Rectangle tool\nes:rectangle-tool:rect\u00e1ngulo\n\nen:redo:Redo\nes:redo:Rehacer\n\nen:rounded-rectangle-tool:Rounded rectangle tool\nes:rounded-rectangle-tool:Rect\u00e1ngulo redondeado\n\nen:save:Save\nes:save:Guardar\n\nen:send-to-back:Send to back\nes:send-to-back:Enviar a la parte posterior\n\nen:shadow:Shadow\nes:shadow:Sombra\n\nen:shape-brush-tool:Shape brush tool\nes:shape-brush-tool:Brush que dibuja formas\n\nen:sloppiness-artist:Artist\nes:sloppiness-artist:Artista\n\nen:sloppiness-cartoonist:Cartoonist\nes:sloppiness-cartoonist:Caricaturista\n\nen:sloppiness-child:Child\nes:sloppiness-child:Ni\u00f1o\n\nen:sloppiness-draftsman:Draftsman\nes:sloppiness-draftsman:Dibujante\n\nen:sloppiness-drunk:Drunk\nes:sloppiness-drunk:Borracho\n\nen:sloppiness:Sloppiness\nes:sloppiness:La dejadez\n\nen:smoothness-sharper:Sharper\nes:smoothness-sharper:Muy afilado\n\nen:smoothness-sharpest:Sharpest\nes:smoothness-sharpest:M\u00e1s afilado\n\nen:smoothness-sharp:Sharp\nes:smoothness-sharp:Afilado\n\nen:smoothness-smoothest:Smoothest\nes:smoothness-smoothest:Muy liso\n\nen:smoothness:Smoothness\nes:smoothness:Lisura\n\nen:smoothness-smooth:Smooth\nes:smoothness-smooth:Liso\n\nen:text-colour:Text colour\nes:text-colour:Color del texto\n\nen:text:Text\nes:text:Texto\n\nen:text-tool:Text tool\nes:text-tool:Texto\n\nen:thickness-brush:Brush\nes:thickness-brush:Brocha\n\nen:thickness-marker:Marker\nes:thickness-marker:Rotulador\n\nen:thickness-pencil:Pencil\nes:thickness-pencil:L\u00e1piz\n\nen:thickness-pen:Pen\nes:thickness-pen:Pluma\n\nen:undo:Undo\nes:undo:Deshacer\n\nen:yes:Yes\nes:yes:S\u00ed\n\nen:zoom-in:Zoom in\nes:zoom-in:Zoom\n\nen:zoom-out:Zoom out\nes:zoom-out:Disminuir el zoom\n");
Ta(this.language,this.ca.get("language"));this.rc=null;this.Zb=n("<div>");this.Zb.$("position","absolute");this.Zb.$("overflow","hidden");this.aa.append(this.Zb);this.canvas=n(Da(this.Zb[0]));this.canvas.$("outline","0");this.canvas.$("position","absolute");this.canvas.$("left","0");this.canvas.$("top","0");this.canvas.La("tabindex","0");this.ga=this.canvas[0].getContext("2d");this.ca.nc()?this.rb=new cf(this.aa,40,!0,!1):this.rb=new cf(this.aa,20,!1,!1);this.ha=new z;this.ha.bind("document-changed",
function(){of(e)});this.ha.bind("document-changed",function(){of(e)});this.view=new Ae(this.canvas,new Gd,this.rb,this.ha,this.ca,this.language);pf(this);qf(this);rf(this);this.cb=new kf(this.ca,this.language);this.aa.append(this.cb.aa);this.ca.Yf()&&(this.view.cb=this.cb);this.cb.view=this.view;this.cb.on("click",function(){e.focus("none")});n(window).resize(function(){return e.Fc()});this.ha.bind("resize",function(){return e.Fc});this.query=ce();this.mc="debug"in this.query||this.ca.mc();this.Bb=
new Te(this.aa);this.Bb.aa.$("border-right","1px solid black");this.zb=new Te(this.aa);this.zb.aa.$("border-top","1px solid black");Ve(this.zb);this.zb.on("click",function(a){return He(e.view,a)});this.Bb.on("click",function(a){return sf(e,a)});null!==this.ca.options.backgroundImage&&(sf(this,this.ca.options.backgroundImage),Qd(this.view.ia));tf(this);this.ca.get("showMathTool")&&(d=new ob,d.load(function(){e.log("App: MJAX loaded.");return e.view.ef(d)}));this.ca.on("update",function(a,b){e.Xe(a,
b)});this.Ff=this.Gf=-1;this.gb=new Za(n("<div>"),!1);this.gb.aa.$("position","absolute");this.gb.aa.$("top","0");this.gb.aa.$("bottom","0");this.gb.aa.$("width","160px");this.gb.aa.$("left","50px");this.gb.aa.$("background","#888");cb(this.gb,this.ca.get("showPageSelector"));this.aa.append(this.gb.aa);this.Fc();this.Be=(a=je(this.ca))?new Za(n(a),!0):null;this.ca.get("setFocus")&&this.focus("toolbar");this.ca.get("pageView")&&this.view.zoom("page");this.Tf=new Qa;this.Tf.start();this.Ed=[];bb(this.gb,
this.oa);this.Be&&(bb(this.Be,this.oa),cb(this.Be,!0));this.view.oa=this.oa;this.oa.emit("document-changed");this.oa.emit("set-page",this.view.ia.sb)}
nf.prototype={log:r("APP"),Xe:function(a,b){var c=!1;this.log("onConfigChange %s=%s",a,b);switch(a){case "debug":this.mc=b;c=!0;break;case "showPageSelector":c=!0;cb(this.gb,b);break;case "backgroundImage":sf(this,b)}c&&this.Fc(!0)},Sc:function(a){this.rc=null;this.view.Sc(a);pf(this);uf(this);this.oa&&(this.oa.emit("document-changed"),this.oa.emit("set-page",a.sb));for(a=0;a<this.Ed.length;a++){var b=this.Ed[a];this.log("Removing old DomElement of type %s",b.tagName);n(b).remove()}this.Ed=[]},focus:function(a){this.log("Set focus to %s",
a);if("toolbar"!==a&&"canvas"!==a&&"none"!==a)throw"Focus must be toolbar or canvas or none, not "+a;this.Xc=a;"toolbar"===this.Xc?(this.toolbar.focus(),a=this.view,a.ua.eb&&(a.ua.eb=!1,a.la()),this.aa.focus()):"canvas"===this.Xc&&(this.toolbar.blur(),this.aa.focus())},Wb:function(a){this.focus("canvas");this.view.Wb(a)},createNode:function(a,b,c){var d;d=this.view.ia.Ca;"layer"in c||(c.layer=this.view.Ka);a.push(new O(b,c));return d},kf:function(a,b,c,d){c=new I(c,d);a.push(new K([b],c,c.inverse()));
return!0},Ce:function(a,b){return a.push(new ud([b]))},Rd:function(){this.Sc(new Gd);null!==this.ca.options.backgroundImage&&(sf(this,this.ca.options.backgroundImage),Qd(this.view.ia))},Fc:function(a){var b,c,d,e,f,g,h,l,k,p,q,t,x,v,w;v=n(window).width();h=n(window).height();if(a||v!==this.Gg||h!==this.Fg)this.Gg=v,this.Fg=h,v=this.aa.width()-0,h=this.aa.height()-0,0>=v||!a&&v===this.Gf&&h===this.Ff||(this.Gf=v,this.Ff=h,this.ca.options.showMenu?(this.zc.show(),this.zc.moveTo(0,0),this.zc.width(v),
k=this.zc.height()):(this.zc.Ga(),k=0),this.ca.options.showBackgroundSelector?(b=100,this.Bb.show()):(b=0,this.Bb.Ga()),this.ca.options.showImageSelector?(e=100,this.zb.show()):(e=0,this.zb.Ga()),this.ca.options.showPageSelector?(this.gb.aa.show(),w=this.gb.aa.outerWidth()):(this.gb.aa.Ga(),w=0),this.ca.ih()?(this.rb.show(),df(this.rb,v),a=this.rb.height()):(this.rb.Ga(),a=0),this.log("Colour panel height is %s",a),this.ca.jh()?(this.toolbar.show(!0),c=h-k-a,d=this.toolbar,0>=c||(f=52*Math.ceil(d.ge/
c)+1,d.aa.style.width=""+f+"px",d.log("Toolbar width/height = %s,%s totalHeight=%s",f,c,d.ge)),x=this.toolbar.width()):(this.toolbar.show(!1),x=0),c=ne(this.view),this.toolbar.moveTo(b+w,k),f=h-a,g=p=t=0,this.mc&&(g=this.Kc.width()),(q=this.ca.Yf()&&700<=v)&&(p=300),t+=p+g,l=v-2*c-b-t,d=h-2*c-a-k-e,this.Bb.width(b),this.Bb.height(h-2*c-k-a),this.Bb.moveTo(0,k),this.gb.aa.$("top",""+k+"px"),this.gb.aa.$("left","0"),this.zb.width(l),this.zb.height(e),this.zb.moveTo(b,h-2*c-a-e),e=w+b+x,b=v-2*c-x-t-
b-w,this.log("menuHeight = %s",k),this.Zb.$("left",""+e+"px"),this.Zb.$("top",""+k+"px"),this.Zb.$("width",""+b+"px"),this.Zb.$("height",""+d+"px"),this.canvas.La("width",""+b),this.canvas.La("height",""+d),this.rb.moveTo(0,f),df(this.rb,v),this.rb.la(),this.mc?(this.Kc.show(),this.Kc.moveTo(v-g,k),this.Kc.height(h-2*c-a-k)):this.Kc.Ga(),q?(this.cb.show(),this.cb.moveTo(v-g-p,k),this.cb.width(p),this.cb.height(h-2*c-k-a)):this.eg||this.cb.Ga(),h=this.view,a=n(h.canvas),b=a.offset(),w=n(h.canvas.parentNode).offset(),
v=a.width(),a=a.height(),k=b.left-w.left,b=b.top-w.top,w=ne(h),h.qb.moveTo(k+v-20+w,b+w),jc(h.qb,20,a-20),h.Eb.moveTo(k+w,b+a-20+w),jc(h.Eb,v-20,20),Ce(h),h.la())},emit:function(a,b){return this.ha.emit(a,b)},ce:function(a,b,c,d){this.log("External app setItemProperty %s: %s=%s",b,c,d);b=tb(b)?b:[b];a.push(new zc(b,c,d))},ff:function(a,b,c){var d;this.log("External app setNodeProperty %s: %s",b,c);tb(b)||(b=[b]);for(d in c)c.hasOwnProperty(d)&&a.push(new zc(b,d,c[d]));if(0<a.length)return this.view.qa(a)},
Id:function(a,b){var c,d;(c=T(this.view.ia,a))&&(d=c.ma(b));this.log("GetItemProperty %s: %s=%s",a,b,d);return d},Le:function(a){return(a=T(this.view.ia,a))?a.type():""},ze:function(a,b){var c,d,e,f,g,h;if(6>b.length)this.log("newShape: Cannot create shape with fewer than three points.");else{c=new Yc;e=g=0;for(h=b.length-1;g<=h;e=g+=2)f=this.view.Wa(new u(b[e],b[e+1])),0===e?(c.moveTo(f.x,f.y),d=f):c.lineTo(f.x,f.y);c.lineTo(d.x,d.y);c.close();return this.Bd(a,c.Jb())}},Bd:function(a,b){return this.createNode(a,
"PathNode",{commands:b,fillStyle:this.view.Ob,strokeStyle:this.view.Pb,seed:Math.round(65535*Math.random()),lineWidth:this.view.ya.lineWidth,sloppiness:this.view.ya.sloppiness})},Jc:function(a,b){var c;c=this.view.ia.Ca;a.push(new wd(b));return c},rd:function(a,b){a.push(new xd(b))}};
function vf(a){var b,c,d;d=Ld(a.view.ia);b=n("<canvas>");b.La("width",""+d.width);b.La("height",""+d.height);c=b[0].getContext("2d");c.translate(-d.x,-d.y);Fe(a.view,c,d.width,d.height);a.view.ia.la(c);return b[0].toDataURL()}function sf(a,b){var c,d;c=[];null!==a.rc&&a.rc in a.view.ia.sa&&c.push(new ud([a.rc]));d=a.view.ia.Ca;c.push(new O("ImageNode",{url:b,locked:!0,layer:a.view.Ka}));c.push(new Ad([d],Cd));a.rc=d;a.view.qa(c);M(a.view);Zc(a.view)}
function uf(a){a.rc=null;a.view.ia.ac(!1,function(b){"ImageNode"===b.type()&&!0===b.ma("locked")&&(a.log("Found background image at nodeid %s",b.id),a.rc=b.id)})}function wf(a){a.focus("canvas");Bc(a.view)}
function rf(a){a.Xc="none";a.Qe=new Hb;ie(a.ca,a.Qe);a.Qe.on("*",function(b,c){"toolbar"===a.Xc?a.toolbar.Gb(b,c):"canvas"===a.Xc?a.view.Gb(b,c):a.log("Ignore key action -- don't have focus.")});a.aa.La("tabindex","0");Jb(a.Qe,a.aa[0]);a.canvas.click(function(){Ga()?a.Xc="canvas":a.focus("canvas")});n(a.toolbar.aa).click(function(){a.focus("toolbar")});a.rb.on("colour",function(){a.focus("canvas")});a.ha.on("goto-toolbar",function(){a.focus("toolbar")});a.ha.on("goto-canvas",function(){a.focus("canvas")})}
function qf(a){function b(a){return 0===a.type.indexOf("key")}var c,d,e,f,g,h,l=a.language.vc();a.toolbar=new Db(a.ca.nc());if(a.ca.get("showToolbar")){a.ca.get("showPickTool")&&Gb(a.toolbar,"pick",l("pick-tool"),a.ca.Ea+"wd-pick.png",function(c){N(a.view);b(c)&&a.Wb()});a.ca.get("showSquareTool")&&a.toolbar.lb(a.ca.Ea+"wd-box.png",l("rectangle-tool"),function(c){a.view.Ec(0);b(c)&&wf(a)});a.ca.get("showRoundRectTool")&&a.toolbar.lb(a.ca.Ea+"wd-roundrect.png",l("rounded-rectangle-tool"),function(c){a.view.Ec(a.ca.get("defaultRoundRectRadius"));
b(c)&&wf(a)});a.ca.get("showCircleTool")&&a.toolbar.lb(a.ca.Ea+"wd-circle.png",l("circle-tool"),function(c){a.view.sd();b(c)&&wf(a)});a.ca.get("showShapeBrushTool")&&Gb(a.toolbar,"shapebrush",l("shape-brush-tool"),a.ca.Ea+"wd-shapebrush.png",function(c){Je(a.view,a.view.Nb,a.view.sc);b(c)&&a.Wb()});a.ca.hh()&&Gb(a.toolbar,"brush",l("brush-tool"),a.ca.Ea+"wd-brush.png",function(c){Ke(a.view,a.view.Nb,a.view.sc);b(c)&&a.Wb()});a.ca.get("showLineTool")&&Gb(a.toolbar,"line",l("line-tool"),a.ca.Ea+"wd-line.png",
function(c){qe(a.view,{});b(c)&&a.Wb()});a.ca.get("showCurveTool")&&Gb(a.toolbar,"curve",l("curve-tool"),a.ca.Ea+"wd-curve.png",function(c){pe(a.view);b(c)&&a.Wb()});a.ca.get("showArrowTool")&&Gb(a.toolbar,"arrow",l("arrow-tool"),a.ca.Ea+"wd-arrow.png",function(c){Ie(a.view,{});b(c)&&a.Wb()});a.ca.get("showTextTool")&&Gb(a.toolbar,"text",l("text-tool"),a.ca.Ea+"wd-text.png",function(c){var d=a.view,e,f;"interactive"===d.ca.get("textMode")?se(d):(e=d.ia.Ca,f=d.Wa(new u(100,100)),f=new I(f.x,f.y),d.qa([new O("TextNode",
{text:d.ca.options.defaultText,fontSize:d.ya.fontSize,fontName:d.ya.fontName,textFillStyle:d.ya.textFillStyle,layer:d.Ka}),new K([e],f,f.inverse())]));b(c)&&a.Wb(!0)});a.ca.get("showMathTool")&&a.toolbar.lb(a.ca.Ea+"wd-equation.png",l("math-tool"),function(){var b=a.view,c,d;N(b);c=b.ia.Ca;d=new I(100,100);b.qa([new O("MathNode",{mathml:"<math xmlns='http://www.w3.org/1998/Math/MathML'></math>",layer:b.Ka}),new K([c],d,d.inverse())]);b.ha.emit("math.edit",c)});c=function(b){a.toolbar.lb(d,b.name,
function(){a.log("Custom button %s clicked.",b.name);b.onclick(a.oa)})};g=0;for(h=xf.length;g<h;g++)e=xf[g],f=e.name,d=e.image,a.log("add custom button %s",f),c(e);Fb(a.toolbar,"pick");a.ca.options.showImageTool&&a.toolbar.lb(a.ca.Ea+"wd-image.png",l("image-tool"),function(){He(a.view,"logo.png")});a.ca.options.showMoveToFrontBack&&(a.toolbar.lb(a.ca.Ea+"wd-moveup.png",l("bring-to-front"),function(){a.ha.emit("menu.bringToFront")}),a.toolbar.lb(a.ca.Ea+"wd-movedown.png",l("send-to-back"),function(){a.ha.emit("menu.sendToBack")}));
a.ca.options.showMenu||(a.ca.get("showUndoRedo")&&(a.toolbar.lb(a.ca.Ea+"wd-undo.png",l("undo"),function(){a.ha.emit("menu.undo")}),a.toolbar.lb(a.ca.Ea+"wd-redo.png",l("redo"),function(){a.ha.emit("menu.redo")})),a.ca.get("showCopyPaste")&&(a.toolbar.lb(a.ca.Ea+"wd-copy.png",l("copy"),function(){a.ha.emit("menu.copy")}),a.toolbar.lb(a.ca.Ea+"wd-paste.png",l("paste"),function(){a.ha.emit("menu.paste")})))}a.toolbar.on("click",function(){a.focus("toolbar")});a.toolbar.aa.style.position="absolute";
a.toolbar.aa.style.left="0";a.toolbar.aa.style.right="0";a.aa.append(a.toolbar.aa);a.oa.on("tool-changed",function(b){Fb(a.toolbar,b)});c=new Yd;e=new Yd;V(e,"New","menu.new");Zd(c,"File",e);e=new Yd;V(e,"Undo\tCtrl+Z","menu.undo");V(e,"Redo\tCtrl+Shift+Z","menu.redo");$d(e);V(e,"Cut\tCtrl+X","menu.cut");V(e,"Copy\tCtrl+C","menu.copy");V(e,"Paste\tCtrl+V","menu.paste");V(e,"Duplicate\tCtrl+D","menu.duplicate");$d(e);V(e,"Delete\tDel","menu.delete");Zd(c,"Edit",e);e=new Yd;V(e,"Raise","menu.moveUp");
V(e,"Lower","menu.moveDown");V(e,"Raise to front","menu.bringToFront");V(e,"Send to back","menu.sendToBack");$d(e);V(e,"Group","menu.group");V(e,"Break apart group","menu.ungroup");Zd(c,"Arrange",e);e=new Yd;V(e,"No Outline","menu.outline-none");V(e,"Pencil Outline","menu.outline-pencil");V(e,"Pen Outline","menu.outline-pen");V(e,"Marker Outline","menu.outline-marker");$d(e);V(e,"No shadow","menu.shadow-none");V(e,"Shadow","menu.shadow");$d(e);V(e,"Draftsman","menu.sloppiness-draftsman");V(e,"Artist",
"menu.sloppiness-artist");V(e,"Cartoonist","menu.sloppiness-cartoonist");V(e,"Child","menu.sloppiness-child");V(e,"Drunk","menu.sloppiness-drunk");Zd(c,"Appearance",e);e=new Yd;V(e,"Arial","menu.font.Arial");V(e,"Times New Roman","menu.font.Times New Roman");Zd(c,"Font",e);e=new Yd;V(e,"Force redraw","menu.force-redraw");$d(e);V(e,"Rebuild document","menu.rebuild-doc");V(e,"Show/Hide Debug Panel","menu.toggle-debug");V(e,"dump","menu.dump");Zd(c,"Debug",e);a.zc=new We(c,a.ha);a.aa.append(a.zc.aa);
a.zc.moveTo(0,0);a.ha.bind("menu.new",function(){a.Rd()});a.ha.bind("menu.force-redraw",function(){a.view.update(!0)});a.ha.bind("menu.remove-cookie",function(){var a="cookieid",b="",c;c=new Date;c.setTime(c.getTime()+-1E3);a=encodeURIComponent(a);b=encodeURIComponent(b);a=""+a+"="+b+"; expires="+c.toGMTString()+"; path=/";Ia("Set document.cookie=%s",a);document.cookie=a});a.ha.bind("menu.rebuild-doc",function(){for(var b=a.view.ia;b.Da.Ua(b););if(b.root.children.length)throw"Error: There should be 0 children length.";
if(1!==b.Ca)throw"Error: nextId should be 1";for(;b.Da.Ra(b););});a.ha.bind("menu.toggle-debug",function(){a.mc=!a.mc;var b=a.mc,c;c=ce();b?c.debug="1":delete c.debug;var d,e;e=[];b=!0;for(d in c)c.hasOwnProperty(d)&&(b||e.push("&"),b=!1,e.push(encodeURIComponent(d)),""!==c[d]&&(e.push("="),e.push(encodeURIComponent(c[d]))));window.location.hash=e.join("");a.Fc()});a.ha.bind("menu.dump",function(){window.console.log(Wd(a.view.ia.root))});a.ha.bind("math.edit",function(b){a.oa&&(a.log("Starting equation editor"),
a.oa.emit("math.edit",b))});a.ha.bind("selected-nodes",function(){a.oa&&a.oa.emit("selected-nodes")});a.ha.bind("node-clicked",function(b){a.oa&&a.oa.emit("node-clicked",b)});a.ha.bind("hint",function(b){a.oa&&a.oa.emit("hint",b)});a.ha.bind("convert-dom-request",function(b,c){a.oa&&a.oa.emit("convert-dom-request",c,b)})}function of(a){a.log("Local document changed.");a.oa.emit("document-changed")}
function pf(a){a.ca.options.sloppy||Ne(a.view,"sloppiness",0);var b;b=(""+a.ca.options.defaultSmoothness).toLowerCase();Ne(a.view,"smoothness","sharpest"===b?0:"sharper"===b?.1:"sharp"===b?.2:"smoothest"===b?.5:.3);Ne(a.view,"fillStyle",a.ca.options.defaultFillStyle);Ne(a.view,"strokeStyle",a.ca.options.defaultStrokeStyle);Ne(a.view,"fontName",a.ca.options.defaultFont);Ne(a.view,"fontSize",a.ca.options.defaultFontSize);Ne(a.view,"lineWidth",a.ca.options.defaultLineWidth);Ne(a.view,"textFillStyle",
a.ca.options.defaultTextFillStyle)}function tf(a){var b,c,d,e,f;a.canvas[0].getContext("2d");e=a.ca.options.fonts;f=[];c=0;for(d=e.length;c<d;c++)b=e[c],a.log("Preloading: %s",b),b=n("<div>").$("font-family",b).text("abcd"),b.$("color","rgba(0,0,0,0.0)"),f.push(a.aa.append(b))};function Z(a,b){this.Fa={};this.cd=!1;this.Pa=[];this.Bc=0;this.ja=new nf(this,a,b);yf(this)}
Z.prototype={log:r("CONTEXT"),fg:function(){this.cd=!1;this.Pa=[]},gg:function(){return this.dd(this.xc())},jg:function(){this.Pa=[];this.Bc=0;this.cd=!0},xd:function(){this.ja.view.xd()},Hc:function(){return this.ja.view.ia.Hc()},Ic:function(){return this.ja.view.ia.Ic()},kg:function(){Qd(this.ja.view.ia)},lg:function(a,b){this.ja.view.Ub(a,b)},mg:function(){this.ja.view.qa(this.Pa,!0);this.cd=!1;this.Pa=[];this.Bc=0},ye:function(){this.ja.view.qa(this.Pa);this.cd=!1;this.Pa=[];this.Bc=0},Yc:function(a){return this.ja.view.Yc(a)},
Jc:function(a){return $(this,this.ja.Jc(this.Pa,a))},createNode:function(a,b){return $(this,this.ja.createNode(this.Pa,a,b))},Bd:function(a){return $(this,this.ja.Bd(this.Pa,a))},ng:function(a,b){"string"===typeof b&&(b=n("#"+b));if("PageSelector"===a){this.log("Creating page selector");var c=new Za(b,!1);cb(c,!0);bb(c,this);ab(c)}else return this.ne("Cannot create UI Elemment %s",a),!1;return!0},ze:function(a){return $(this,this.ja.ze(this.Pa,a))},Ce:function(a){return $(this,this.ja.Ce(this.Pa,
a))},qf:function(){if(1===this.xc())this.log("Cannot remove all the pages.");else{var a=this.ja.view.ia;this.Pa.push(new ud([a.vb[a.sb].id]));$(this)}},qg:function(){De(this.ja.view)},De:function(){if(1===arguments.length&&!1===arguments[0]){var a=this.ja.view.ia;a.Pf=a.Da.next}return this.ja.view.ia.De()},Ee:function(a,b){"pdf"===a||"svg"===a||"png"===a?this.ja.Tf.Ee(this,a,b):this.log("unsupported format for download: %s",a)},la:function(a,b){b=b||{};var c=this.ja.view.ia.sb;this.ja.view.ia.xb(b.page||
0);this.ja.view.ia.la(a);this.ja.view.ia.xb(c)},duplicate:function(){this.ja.view.duplicate()},emit:function(a,b){var c,d=this;this.Fa||(this.Fa={});c=Array.prototype.slice.call(arguments,1);setTimeout(function(){var b,f,g,h;if(a in d.Fa)for(h=d.Fa[a],f=0,g=h.length;f<g;f++)b=h[f],b.apply(null,c)},0);return this},sg:function(a){a=this.sf(a);return a.length?a[0]:null},sf:function(a){var b=this.ja.view.ia,c=[],d;for(d in b.sa)if(b.sa.hasOwnProperty(d)){var e=b.sa[d];e.ma("tag")===a&&c.push(e)}a=[];
for(b=0;b<c.length;b++)a.push(c[b].id);return a},tg:function(a){var b=this.ja.view;a=a/180*Math.PI;0===b.selection.length&&null===b.Aa||b.log("flipSelection: selection is empty");var c;c=b.Mc();if(0===c.length)c=new u(0,0);else{for(var d=c[0].tb().clone(),e=1;e<c.length;e++)Rb(d,c[e].tb());c=Pb(d)}a=new Vb(a,c.x,c.y);b.qa([new K(X(b),a,a.inverse())])},Ke:function(a){return zf(this.ja.view.Ke(a))},Lc:function(){return this.ja.view.ia.sb},ug:function(a,b){var c=s(this.ja.view,a,b);return{x:c.x,y:c.y}},
xf:function(){var a=Ld(this.ja.view.ia);return{x:a.x,y:a.y,width:a.width,height:a.height}},vg:function(){return zf(this.ja.view.ia.tb())},xg:function(a,b){return this.Id(a,b)},Id:function(a,b){return this.ja.Id(a,b)},Le:function(a){return this.ja.Le(a)},xc:function(){return this.ja.view.ia.xc()},dg:function(){this.ja.view.cb=this.ja.cb;this.ja.eg=!0;return this.ja.cb.aa[0]},yg:function(a,b,c,d){var e;e=Ac(this.ja.view,a,b);if(void 0===c)return{x:e.x,y:e.y};a=Ac(this.ja.view,a+c,b+d);return zf(new G(e.x,
e.y,a.x-e.x,a.y-e.y))},Mc:function(a){return X(this.ja.view,a)},ne:function(a,b){for(var c=arguments[0].split("%s"),d=[],e=0;e<c.length;e++)d.push(c[e]),e<c.length-1&&d.push(JSON.stringify(arguments[e+1]));this.log(d.join(""));throw{message:d,toString:function(){return d}};},dd:function(a){var b=this.ja.view.ia.Ca;this.Pa.push(new O("PageNode",{},this.ja.view.ia.root.id,a));$(this,b);return a},load:function(a,b){1===arguments.length&&(b=arguments[0],a="zwibbler3");var c;"list"===a?(this.ja.Sc(Vd(b)),
c=void 0):c=this.ja.Sc(Td(b));return c},Pd:function(){this.ja.view.Pd()},Qd:function(){this.ja.view.Qd()},Rd:function(){this.ja.Rd();yf(this)},nextPage:function(){this.md(Math.min(this.Lc()+1,this.xc()-1))},on:function(a,b){a in this.Fa?this.Fa[a].push(b):this.Fa[a]=[b];return this},Ud:function(a){this.ja.view.Ud(a)},Ug:function(){this.md(Math.max(this.Lc()-1,0))},Ra:function(){this.ja.ha.emit("menu.redo")},resize:function(){this.ja.Fc(!0)},save:function(a){if("list"===a)return Sd(this.ja.view.ia.root);
if("png"===a)return vf(this.ja);if("zwibbler3"===a||0===arguments.length)return this.ja.view.ia.save("zwibbler3");if("image/png"===a){for(var b=vf(this.ja),b=b.substr(b.indexOf(",")+1),c=["base64"],d=0;d<c.length;d++)b=Xd[c[d]](b);return b}return"Unsupported format: "+a},be:function(){this.ja.view.be()},cf:function(a){this.ja.view.cf(a)},$g:function(a){var b=this.ja,c,d,e,f;b.Bb.clear();f=[];d=0;for(e=a.length;d<e;d++)c=a[d],"string"===typeof c?f.push(Ue(b.Bb,c,c)):f.push(Ue(b.Bb,c.small,c.large))},
ah:function(a,b){return this.ja.ca.set(a,b)},md:function(a){this.ja.view.xb(a)},df:function(a){this.ja.view.df(a)},nd:function(a,b){ub(a)&&ub(b)?this.ja.view.nd(a,b):alert("setDocumentSize: width/height must be numbers")},bh:function(a,b){var c=T(this.ja.view.ia,a);c||this.ne("setDomElement: Node %s does not exist",a);"DomNode"!==c.type()&&this.ne("setDomElement: Node %s is not a DomNode. It is %s",a,c.type());c.Uf(b);this.ja.Ed.push(b)},Vf:function(a){var b,c=null,d,e=!0,f=!1;if(2===arguments.length)ub(arguments[0])&&
ub(arguments[1])?(d=arguments[0],b=arguments[1]):"string"===typeof arguments[0]&&"boolean"===typeof arguments[1]?(c=arguments[0],f=arguments[1]):e=!1;else if(1===arguments.length&&"string"===typeof arguments[0])for(var g=arguments[0].split(" "),h=0;h<g.length;h++)"landscape"===g[h]?f=!0:"portrait"===g[h]?f=!1:c=g[h];if(!1===e)return this.log("Bad arguments to setPaperSize()."),!1;if(null===c)return this.nd(d,b),!0;switch(c){case "letter":d=816;b=1056;break;case "legal":d=816;b=1344;break;case "11x17":d=
1056;b=1632;break;case "tabloid":d=1056;b=1632;break;case "a0":d=841/25.4*96;b=1189/25.4*96;break;case "a1":d=594/25.4*96;b=841/25.4*96;break;case "a2":d=420/25.4*96;b=594/25.4*96;break;case "a3":d=297/25.4*96;b=420/25.4*96;break;case "a4":d=210/25.4*96;b=297/25.4*96;break;default:return this.log("Invalid paper size: %s",c),!1}f&&(c=d,d=b,b=c);this.nd(d,b);return!0},dh:function(a){var b=this.ja,c,d,e,f;b.zb.clear();f=[];d=0;for(e=a.length;d<e;d++)c=a[d],"string"===typeof c?f.push(Ue(b.zb,c,c)):f.push(Ue(b.zb,
c.small,c.large))},eh:function(a,b,c){this.ce(a,b,c)},ff:function(a,b){if(2!==arguments.length)throw"Error: setNodeProperties takes 2 arguments.";return $(this,this.ja.ff(this.Pa,a,b))},ce:function(a,b,c){return $(this,this.ja.ce(this.Pa,a,b,c))},gf:function(a){this.ja.view.gf(a)},gh:function(a){ub(a)||"page"===a||"width"===a?this.ja.view.zoom(a):this.log("setZoom: invalid parameter.")},od:function(a,b){this.ja.view.od(a,b)},kf:function(a,b,c){this.log("Translate node %s by %s,%s actions=%s",a,b,
c,this.Pa.length);return $(this,this.ja.kf(this.Pa,a,b,c))},Ua:function(){this.ja.ha.emit("menu.undo")},rd:function(a){return $(this,this.ja.rd(this.Pa,a))},th:function(a){Ie(this.ja.view,a)},uh:function(a,b){Ke(this.ja.view,a,b)},vh:function(){this.ja.view.sd()},wh:function(){pe(this.ja.view)},sd:function(){this.ja.view.sd()},xh:function(a,b){var c=this.ja.view,d,e;d=a||c.Nb;e=b||c.sc;c.ca.get("readOnly")?c.log("readOnly mode: Ignoring tool click."):(y(c,new Xc(c,c.na,d,e,"freehand")),c.oa.emit("tool-changed",
"freehand"))},yh:function(a){qe(this.ja.view,a)},zh:function(){N(this.ja.view)},Ec:function(){this.ja.view.Ec(0)},Ah:function(){this.ja.view.Ec(this.ja.ca.get("defaultRoundRectRadius"))},Bh:function(a,b){Je(this.ja.view,a,b)},Dh:function(a){var b=this.ja.view;b.ca.get("readOnly")?b.log("readOnly mode: Ignoring tool click."):(y(b,new qd(b,"stampline",a)),b.oa.emit("tool-changed","stampline"))},Ch:function(){this.ja.view.Ec(0)},Eh:function(){se(this.ja.view)},ie:function(){this.ja.view.ie()},je:function(){this.ja.view.je()}};
function yf(a){var b=a.ja.ca.get("defaultPaperSize");a.log("onNewDocument()");"none"!==b&&a.Vf(b)}function zf(a){return{x:a.x,y:a.y,left:a.x,top:a.y,right:a.x+a.width,bottom:a.y+a.height,width:a.width,height:a.height}}function $(a,b){if(!a.cd)return a.log("Not in a transaction. committing immediately. id=%s",b),a.ye(),b;if("number"===typeof b)return a.Bc+=1,a.log("id=%s numCreated=%s",b,a.Bc),b+a.Bc-1};"jQuery"in window&&(window.jQuery.fn.zwibbler=function(a){a=a||{};var b=null;this.each(function(c,d){d.zwibbler&&n(d).empty();b=new Z(n(d),a);d.zwibbler=b});return b},window.jQuery.fn.zwibblerContext=function(){return this[0].zwibbler});var xf=[],ad={};
window.Zwibbler={create:function(a,b){var c=document.getElementById(a);return null===c?(alert("Zwibbler.create: Cannot find an element with id "+a),null):new Z(n(c),b)},addButton:function(a){for(var b=["name","image","onclick"],c=0;c<b.length;c++)if(!(b[c]in a))return alert("Zwibbler.addButton: missing "+b[c]),!1;xf.push(a);return!0},addCustomNode:function(a,b){ad[a]=b},Dialog:function(a,b){var c=n("#"+a);b=b||{};var d=Ha(c[0]),e=new aa("rgba(0,0,0,0.5)");e.zIndex=d;e.insertBefore=c;var f={hide:function(){e.Ga();
c.Ga();if(f.onhide)f.onhide()},show:function(){c.show();var a=c.width(),b=c.height();c.$("left","50%");c.$("top","50%");c.$("margin-left",""+-a/2+"px");c.$("margin-top",""+-b/2+"px");e.show(f.hide);if(f.onshow)f.onshow()},onshow:b.onshow,onhide:b.onhide};return f},SlidingPanel:function(a,b){b=b||{};var c=b.autohide,d;d="string"===typeof a?n("#"+a):n(a);var e=new Va(d);if(b.onshow)e.on("show",b.onshow);if(b.onhide)e.on("hide",b.onhide);return{show:function(a){e.show(a,c)},hide:function(){e.Ga()}}},
createPreview:function(a,b){return window.Zwibbler.render(a,b)},render:function(a,b){function c(){var a=q.tb(),b=1,c=0,t=0;f&&(a.y=f);l&&(a.height=l-a.y);g&&(a.x=g);h&&(a.width=h-a.x);d&&e?b=Math.min(d/a.width,e/a.height):d?(b=d/a.width,e=a.height*b):e?(b=e/a.height,d=a.width*b):(d=a.width,e=a.height);a.width*b<d&&(c=d/2-a.width*b/2);a.height*b<e&&(t=e/2-a.height*b/2);c-=a.x*b;t-=a.y*b;k.width=Math.ceil(d);k.height=Math.ceil(e);p.translate(c,t);p.scale(b,b);q.la(p)}b=b||{};var d=b.width||0,e=b.height||
0,f=b.top||0,g=b.left||0,h=b.right||0,l=b.bottom||0,k=Da(null),p=k.getContext("2d"),q=Td(a),t=new pb;q.format(p,t);t.on("reformat",function(a){Gc(q,a.id)});if(t.Kb)t.on("done",function(){q.format(p,t);c()});else c();return k},parseColour:function(a){a=$e(a);return{r:a.fa[0],g:a.fa[1],b:a.fa[2],a:a.fa[3]}},makeColour:function(a){return(new Y(0,[a.r,a.g,a.b,a.a])).toString()}};bd.prototype.setElement=bd.prototype.Uf;Z.prototype.abortTransaction=Z.prototype.fg;Z.prototype.addPage=Z.prototype.gg;Z.prototype.beginTransaction=Z.prototype.jg;Z.prototype.bringToFront=Z.prototype.xd;Z.prototype.canRedo=Z.prototype.Hc;Z.prototype.canUndo=Z.prototype.Ic;Z.prototype.clearUndo=Z.prototype.kg;Z.prototype.clickColour=Z.prototype.lg;Z.prototype.commitIrreversibleTransaction=Z.prototype.mg;Z.prototype.commitTransaction=Z.prototype.ye;Z.prototype.copy=Z.prototype.Yc;
Z.prototype.createGroup=Z.prototype.Jc;Z.prototype.createNode=Z.prototype.createNode;Z.prototype.createPath=Z.prototype.Bd;Z.prototype.createUiElement=Z.prototype.ng;Z.prototype.createShape=Z.prototype.ze;Z.prototype.deleteNode=Z.prototype.Ce;Z.prototype.deletePage=Z.prototype.qf;Z.prototype.deleteSelection=Z.prototype.qg;Z.prototype.dirty=Z.prototype.De;Z.prototype.download=Z.prototype.Ee;Z.prototype.draw=Z.prototype.la;Z.prototype.duplicate=Z.prototype.duplicate;Z.prototype.findNode=Z.prototype.sg;
Z.prototype.findNodes=Z.prototype.sf;Z.prototype.flip=Z.prototype.tg;Z.prototype.getBoundingRectangle=Z.prototype.Ke;Z.prototype.getCurrentPage=Z.prototype.Lc;Z.prototype.getDocumentCoordinates=Z.prototype.ug;Z.prototype.getDocumentSize=Z.prototype.xf;Z.prototype.getDrawingRectangle=Z.prototype.vg;Z.prototype.getItemProperty=Z.prototype.xg;Z.prototype.getNodeProperty=Z.prototype.Id;Z.prototype.getNodeType=Z.prototype.Le;Z.prototype.getPageCount=Z.prototype.xc;
Z.prototype._getPropertyPanelElement=Z.prototype.dg;Z.prototype.getScreenCoordinates=Z.prototype.yg;Z.prototype.getSelectedNodes=Z.prototype.Mc;Z.prototype.insertPage=Z.prototype.dd;Z.prototype.load=Z.prototype.load;Z.prototype.moveDown=Z.prototype.Pd;Z.prototype.moveUp=Z.prototype.Qd;Z.prototype.newDocument=Z.prototype.Rd;Z.prototype.nextPage=Z.prototype.nextPage;Z.prototype.on=Z.prototype.on;Z.prototype.paste=Z.prototype.Ud;Z.prototype.previousPage=Z.prototype.Ug;Z.prototype.redo=Z.prototype.Ra;
Z.prototype.resize=Z.prototype.resize;Z.prototype.save=Z.prototype.save;Z.prototype.sendToBack=Z.prototype.be;Z.prototype.setActiveLayer=Z.prototype.cf;Z.prototype.setBackgroundBrowserImages=Z.prototype.$g;Z.prototype.setConfig=Z.prototype.ah;Z.prototype.setCurrentPage=Z.prototype.md;Z.prototype.setCustomBackgroundFn=Z.prototype.df;Z.prototype.setDocumentSize=Z.prototype.nd;Z.prototype.setDomElement=Z.prototype.bh;Z.prototype.setPaperSize=Z.prototype.Vf;Z.prototype.setIconBrowserImages=Z.prototype.dh;
Z.prototype.setItemProperty=Z.prototype.eh;Z.prototype.setNodeProperties=Z.prototype.ff;Z.prototype.setNodeProperty=Z.prototype.ce;Z.prototype.setPageView=Z.prototype.gf;Z.prototype.setZoom=Z.prototype.gh;Z.prototype.showLayer=Z.prototype.od;Z.prototype.translateNode=Z.prototype.kf;Z.prototype.undo=Z.prototype.Ua;Z.prototype.ungroup=Z.prototype.rd;Z.prototype.useArrowTool=Z.prototype.th;Z.prototype.useBrushTool=Z.prototype.uh;Z.prototype.useCircleTool=Z.prototype.vh;Z.prototype.useCurveTool=Z.prototype.wh;
Z.prototype.useEllipseTool=Z.prototype.sd;Z.prototype.useFreehandTool=Z.prototype.xh;Z.prototype.useLineTool=Z.prototype.yh;Z.prototype.usePickTool=Z.prototype.zh;Z.prototype.useRectangleTool=Z.prototype.Ec;Z.prototype.useRoundRectTool=Z.prototype.Ah;Z.prototype.useShapeBrushTool=Z.prototype.Bh;Z.prototype.useStampLineTool=Z.prototype.Dh;Z.prototype.useSquareTool=Z.prototype.Ch;Z.prototype.useTextTool=Z.prototype.Eh;Z.prototype.zoomIn=Z.prototype.ie;Z.prototype.zoomOut=Z.prototype.je;
nf.prototype.emit=nf.prototype.emit;nf.prototype.createGroup=nf.prototype.Jc;

})();
