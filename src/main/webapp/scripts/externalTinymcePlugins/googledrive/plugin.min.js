/**
 * Google Drive plugin Author: dave Date : 16/11/2014
 */

var googleDriveEditor;
var googleDriveUrl;

function authorizeGoogleDriveLink() {
	if (typeof window.gapi === 'object') {
		window.gapi.auth.authorize({
			'client_id': gdClientId,
			'scope': gdScope,
			'immediate': false
		}, handleGoogleDriveAuthLinkResult);
	} else {
		apprise('Unable to contact Google Drive.  Please try again later or ensure that your network connection is active and reload the page.');
	}
}

function handleGoogleDriveAuthLinkResult(authResult) {
	if (authResult && !authResult.error) {
		gdOauthToken = authResult.access_token;
		createTinyMCEGoogleDrivePicker(googleDrivePickerLinkCallback);
	}
}

function createTinyMCEGoogleDrivePicker(callback) {
	if (gdPickerApiLoaded && gdOauthToken) {
		var picker = new google.picker.PickerBuilder()
			.addView(google.picker.ViewId.DOCS)
			.setOAuthToken(gdOauthToken)
			.setDeveloperKey(gdDeveloperKey)
			.setCallback(callback)
			.build();
		picker.setVisible(true);
	}
}

function googleDrivePickerLinkCallback(data) {
	var googleDriveLinkUrl = 'nothing';
	if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
		var doc = data[google.picker.Response.DOCUMENTS][0];
		googleDriveLinkUrl = doc[google.picker.Document.EMBEDDABLE_URL] || doc[google.picker.Document.URL];

		var name = doc[google.picker.Document.NAME];

		var extension = RS.getFileExtension(name);
		var iconPath = RS.getIconPathForExtension(extension);
		var docId = doc.id;

		var json = {
			id: 'googledrive-' + docId,
			fileStore: 'Google Drive',
			recordURL: googleDriveLinkUrl,
			name: name,
			iconPath: iconPath,
			badgeIconPath: '/images/icons/drive_icon.png'
		};

		RS.insertTemplateIntoTinyMCE('insertedExternalDocumentTemplate', json);
	}
}

tinymce.PluginManager.add('googledrive', function (editor, url) {

	googleDriveEditor = editor;
	googleDriveUrl = url;

	// Add command to open the comment dialog.htm
	editor.addCommand('cmdGoogleDrive', function () {
		authorizeGoogleDriveLink();
	});

	// Add a button that opens a window
	editor.ui.registry.addButton('googledrive', {
		tooltip: 'Insert from Google Drive',
		icon: 'google_drive',
		onAction: function () {
			editor.execCommand("cmdGoogleDrive");
		}
	});

	// Adds a menu item to the insert menu
	editor.ui.registry.addMenuItem('optGoogleDrive', {
		text: 'From Google Drive',
		icon: 'google_drive',
		onAction: function () {
			editor.execCommand("cmdGoogleDrive");
		}
	});

  if(!window.insertActions) window.insertActions = new Map();
  window.insertActions.set("optGoogleDrive", {
    text: 'From Google Drive',
    icon: 'google_drive',
    action: () => {
			editor.execCommand("cmdGoogleDrive");
    },
  });

});
